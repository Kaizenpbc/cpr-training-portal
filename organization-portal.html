<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organization Portal - GTA CPR</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --background-color: #ecf0f1;
            --text-color: #2c3e50;
            --header-height: 60px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
        }

        .main-header {
            background-color: var(--primary-color);
            color: white;
            padding: 0 20px;
            height: var(--header-height);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
        }

        .logo {
            font-size: 1.5rem;
        }

        .main-nav {
            display: flex;
            gap: 20px;
            margin-left: auto;
        }

        .main-nav a {
            color: white;
            text-decoration: none;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .main-nav a:hover {
            background-color: var(--secondary-color);
        }

        .content-wrapper {
            display: flex;
            margin-top: var(--header-height);
            min-height: calc(100vh - var(--header-height));
        }

        .left-nav {
            width: 250px;
            background-color: white;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }

        .left-nav button {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: none;
            background-color: #ccc;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .left-nav button i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        .left-nav button.active {
            background-color: var(--secondary-color);
        }

        .left-nav button:hover {
            background-color: var(--primary-color);
        }

        .left-nav button.disabled {
            background-color: #ccc;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .left-nav button.disabled:hover {
            background-color: #ccc;
        }

        .main-content {
            flex-grow: 1;
            padding: 20px;
            background-color: var(--background-color);
        }

        .welcome-banner {
            background-color: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .welcome-banner .portal-title {
            flex-grow: 1;
            text-align: center;
        }

        .welcome-banner p {
            margin: 0;
            text-align: right;
        }

        .section {
            display: none;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--dark-color);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-right: 0.5rem;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: var(--light-color);
            font-weight: bold;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .status {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.875rem;
        }

        .status-pending {
            background-color: #ffc107;
            color: #000;
        }

        .status-confirmed {
            background-color: #28a745;
            color: white;
        }

        .status-available {
            background-color: #17a2b8;
            color: white;
        }

        .status-scheduled {
            background-color: #007bff;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            position: relative;
            background-color: white;
            margin: 10% auto;
            padding: 2rem;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .close-modal {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .student-list-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .student-list-table {
            margin-top: 1rem;
            width: 100%;
            border-collapse: collapse;
        }

        .student-list-table th,
        .student-list-table td {
            padding: 0.5rem;
            border: 1px solid #ddd;
        }

        @media (max-width: 768px) {
            .content-wrapper {
                flex-direction: column;
            }

            .left-nav {
                width: 100%;
            }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 4px;
            color: white;
            z-index: 2000;
            display: none;
            animation: slideIn 0.5s ease-in-out;
        }

        .notification-success {
            background-color: var(--success-color);
        }

        .notification-error {
            background-color: var(--danger-color);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .upload-progress {
            margin-top: 1rem;
            display: none;
        }

        .progress-container {
            margin-top: 1rem;
            margin-bottom: 1rem;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .progress {
            height: 20px;
            background-color: #f5f5f5;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            font-size: 0.9em;
            color: var(--text-color);
        }

        /* Analytics Dashboard Styles */
        .analytics-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
            max-width: 50%;  /* Reduce width by 50% */
        }

        .analytics-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            border-left: 4px solid var(--secondary-color);  /* Add blue accent */
        }

        .analytics-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .analytics-card .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            color: var(--secondary-color);  /* Use blue color for header */
        }

        .analytics-card .card-header i {
            font-size: 1.5rem;
            margin-right: 0.5rem;
            color: var(--secondary-color);  /* Use blue color for icons */
        }

        .analytics-card .card-body {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);  /* Use darker blue for numbers */
        }

        .analytics-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .analytics-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
        }

        .trends-section {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stats-table {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #courseStatsTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        #courseStatsTable th,
        #courseStatsTable td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        #courseStatsTable th {
            background-color: var(--light-color);
            font-weight: bold;
        }

        .trend-up {
            color: var(--success-color);
        }

        .trend-down {
            color: var(--danger-color);
        }

        .section-content {
            padding: 1rem;
        }

        .welcome-banner {
            background-color: var(--light-color);
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }

        .welcome-banner h3 {
            margin: 0;
            color: var(--dark-color);
            text-align: center;
        }

        .btn-danger {
            background-color: #e74c3c !important;
        }
        .btn-danger:hover {
            background-color: #c0392b !important;
        }
        
        #resetDataModal ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        #resetDataModal p {
            margin: 10px 0;
        }

        /* Add these styles for the truncated notes and tooltip */
        .truncated-note {
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: help;
            position: relative;
        }

        .truncated-note:hover::after {
            content: attr(data-full-note);
            position: absolute;
            left: 0;
            top: 100%;
            background-color: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            z-index: 1000;
            white-space: normal;
            max-width: 300px;
            word-wrap: break-word;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .course-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .course-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .course-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .course-header h3 {
            margin: 0;
            color: var(--primary-color);
        }

        .course-details {
            margin-bottom: 15px;
        }

        .course-details p {
            margin: 8px 0;
        }

        .course-details strong {
            color: var(--primary-color);
        }

        .course-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .status-complete {
            background-color: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .status-confirmed {
            background-color: #17a2b8;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .status-scheduled {
            background-color: #007bff;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .status-pending {
            background-color: #ffc107;
            color: #000;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        /* Certificate Modal Styles */
        .certificate-view {
            max-width: 800px;
            padding: 20px;
        }

        .certificate-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .certificate-actions {
            display: flex;
            gap: 10px;
        }

        .certificate-content {
            border: 2px solid #ddd;
            padding: 30px;
            text-align: center;
            background: #fff;
        }

        .certificate-logo {
            margin-bottom: 20px;
        }

        .certificate-logo img {
            max-width: 150px;
            height: auto;
        }

        .certificate-title {
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .student-name {
            font-size: 2em;
            margin: 20px 0;
            color: #333;
        }

        .certificate-text {
            font-size: 1.1em;
            margin: 20px 0;
            line-height: 1.6;
        }

        .certificate-details {
            text-align: left;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }

        .certificate-details p {
            margin: 10px 0;
        }

        /* Monthly Summary Box Styles */
        .monthly-summary {
            max-width: 50%;
            margin-bottom: 20px;
        }

        .monthly-summary-content {
            background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            color: white;
        }

        .monthly-summary-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .monthly-summary-header i {
            margin-right: 10px;
            color: white;
        }

        .monthly-summary-header h3 {
            margin: 0;
            color: white;
        }

        .monthly-summary-body {
            margin-top: 1rem;
        }

        .monthly-summary-body p {
            margin: 5px 0;
            color: white;
        }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="logo">GTA CPR</div>
        <nav class="main-nav">
            <a href="Index.html">Home</a>
            <a href="instructor-portal.html">Instructors</a>
            <a href="organization-portal.html" class="active">Organizations</a>
            <a href="admin-portal.html">Course Management</a>
            <a href="support-portal.html">Support</a>
            <a href="#" onclick="handleLogout()">Logout</a>
        </nav>
    </header>

    <div class="content-wrapper">
        <div class="left-nav">
            <nav class="left-nav">
                <button onclick="showSection('login')" id="loginBtn" class="active">
                    <i class="fas fa-sign-in-alt"></i>
                    <span>Login</span>
                </button>
                <button onclick="showSection('schedule')" id="scheduleBtn">
                    <i class="fas fa-calendar-plus"></i>
                    <span>Schedule Course</span>
                </button>
                <button onclick="showSection('courses')" id="coursesBtn">
                    <i class="fas fa-book"></i>
                    <span>My Courses</span>
                </button>
                <button onclick="showSection('certificates')" id="certificatesBtn">
                    <i class="fas fa-certificate"></i>
                    <span>Certificates</span>
                </button>
                <button onclick="showSection('profile')" id="profileBtn">
                    <i class="fas fa-user"></i>
                    <span>Profile</span>
                </button>
                <button onclick="handleLogout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </button>
            </nav>
        </div>

        <main class="main-content">
            <div class="welcome-banner">
                <div class="portal-title">
                    <h1>Organization Portal</h1>
                </div>
                <p id="welcomeMessage">Please log in to continue.</p>
            </div>

            <section id="login" class="section active">
                <h2>Organization Login</h2>
                <form onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label for="username">Organization Name:</label>
                        <input type="text" id="username" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Login</button>
                </form>
            </section>

            <section id="schedule" class="section">
                <h2>Schedule Course</h2>
                <form onsubmit="handleScheduleCourse(event)">
                    <div class="form-group">
                        <label for="courseDate">Date:</label>
                        <input type="date" id="courseDate" required>
                    </div>
                    <div class="form-group">
                        <label for="location">Location:</label>
                        <input type="text" id="location" required>
                    </div>
                    <div class="form-group">
                        <label for="classType">Class Type:</label>
                        <select id="classType" required>
                            <option value="">Select a class type</option>
                            <option value="BLS">BLS - Basic Life Support</option>
                            <option value="ACLS">ACLS - Advanced Cardiac Life Support</option>
                            <option value="PALS">PALS - Pediatric Advanced Life Support</option>
                            <option value="CPR">CPR - Cardiopulmonary Resuscitation</option>
                            <option value="First Aid">First Aid</option>
                            <option value="AED">AED - Automated External Defibrillator</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="studentsRegistered">Students Registered:</label>
                        <input type="number" id="studentsRegistered" min="1" required>
                    </div>
                    <div class="form-group">
                        <label for="notes">Notes (max 100 characters):</label>
                        <textarea id="notes" maxlength="100" rows="2"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Schedule Course</button>
                </form>
            </section>

            <section id="courses" class="section">
                <h2>My Courses</h2>
                <!-- Monthly Summary Box -->
                <div style="max-width: 300px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%); border-radius: 8px; padding: 1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <div style="color: white; display: flex; align-items: center; margin-bottom: 10px;">
                            <i class="fas fa-calendar-check" style="color: white; margin-right: 10px;"></i>
                            <h3 style="margin: 0;">Monthly Summary</h3>
                        </div>
                        <div style="color: white; margin-top: 1rem;">
                            <p style="margin: 5px 0;">Total Courses: <span id="totalCourses">0</span></p>
                            <p style="margin: 5px 0;">Completed: <span id="completedCourses">0</span></p>
                            <p style="margin: 5px 0;">Pending: <span id="pendingCourses">0</span></p>
                        </div>
                    </div>
                </div>
                <!-- Course Table -->
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Location</th>
                                <th>Class Type</th>
                                <th>Students Registered</th>
                                <th>Students Attendance</th>
                                <th>Status</th>
                                <th>Assigned Instructor</th>
                                <th>Notes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="coursesTableBody"></tbody>
                    </table>
                </div>
            </section>

            <section id="archivedCourses" class="section">
                <h2>Archived Courses</h2>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Location</th>
                                <th>Class Type</th>
                                <th>Students</th>
                                <th>Status</th>
                                <th>Instructor</th>
                                <th>Notes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="archivedCoursesTableBody"></tbody>
                    </table>
                </div>
            </section>

            <section id="students" class="section">
                <h2>Student Lists</h2>
                <div class="student-lists">
                    <h3>Existing Student Lists</h3>
                    <div id="existingLists"></div>
                </div>
            </section>

            <div id="notification" class="notification"></div>

            <script>
                // Global variables
                let currentOrganization = null;
                let currentStudents = [];
                let currentSort = { column: null, ascending: true };
                let currentCourseId = null;
                let selectedFile = null;  // Add this line to store the selected file

                // Initialize the application
                document.addEventListener('DOMContentLoaded', function() {
                    console.log('=== Application Initialization ===');
                    console.log('Checking monthly summary box styling...');
                    
                    // Add trace for monthly summary box
                    const monthlyBox = document.querySelector('[style*="max-width: 300px"]');
                    console.log('Monthly Summary Box:', monthlyBox);
                    if (monthlyBox) {
                        console.log('Monthly Box Current Styles:', {
                            maxWidth: monthlyBox.style.maxWidth,
                            background: monthlyBox.querySelector('div').style.background,
                            color: monthlyBox.querySelector('div').style.color
                        });
                    }
                    
                    // Check if user is logged in
                    const currentOrg = JSON.parse(localStorage.getItem('currentOrganization'));
                    if (currentOrg) {
                        console.log('Found logged in organization:', currentOrg.name);
                        currentOrganization = currentOrg; // Set the global variable
                        showWelcomeBanner(currentOrg.name);
                        showSection('courses');  // Show courses section by default
                        updateMyCoursesTable(); // Update the courses table
                    } else {
                        console.log('No organization logged in, showing login section');
                        showSection('login');
                    }

                    // Initialize check functions
                    window.checkDataIntegrity = function() {
                        console.log('=== Data Integrity Check ===');
                        try {
                            // Check courses
                            const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                            console.log('Courses:', courses);
                            console.log('Number of courses:', courses.length);
                            
                            // Check students
                            const students = JSON.parse(localStorage.getItem('students') || '[]');
                            console.log('Students:', students);
                            console.log('Number of students:', students.length);
                            
                            // Check organizations
                            const organizations = JSON.parse(localStorage.getItem('organizations') || '[]');
                            console.log('Organizations:', organizations);
                            console.log('Number of organizations:', organizations.length);
                            
                            // Check current organization
                            const currentOrg = JSON.parse(localStorage.getItem('currentOrganization'));
                            console.log('Current Organization:', currentOrg);
                            
                            // Check for data inconsistencies
                            let issues = [];
                            
                            // Check course references
                            courses.forEach(course => {
                                if (!course.id) issues.push(`Course missing ID: ${JSON.stringify(course)}`);
                                if (!course.organizationId) issues.push(`Course missing organization ID: ${course.id}`);
                                if (!Array.isArray(course.studentList)) issues.push(`Course ${course.id} has invalid studentList`);
                            });
                            
                            // Check student references
                            students.forEach(student => {
                                if (!student.id) issues.push(`Student missing ID: ${JSON.stringify(student)}`);
                                if (!Array.isArray(student.courses)) issues.push(`Student ${student.id} has invalid courses array`);
                            });
                            
                            // Check organization references
                            organizations.forEach(org => {
                                if (!org.id) issues.push(`Organization missing ID: ${JSON.stringify(org)}`);
                            });
                            
                            if (issues.length > 0) {
                                console.log('=== Data Issues Found ===');
                                issues.forEach(issue => console.log(issue));
                                showNotification('Data integrity issues found. Check console for details.', 'error');
                            } else {
                                console.log('No data integrity issues found');
                                showNotification('Data integrity check passed', 'success');
                            }
                            
                        } catch (error) {
                            console.error('Error checking data integrity:', error);
                            showNotification('Error checking data integrity', 'error');
                        }
                        console.log('=== End Data Integrity Check ===');
                    };

                    window.checkFileUploadState = function() {
                        console.log('=== File Upload State Check ===');
                        try {
                            const fileInput = document.getElementById('excelFile');
                            console.log('File input element:', fileInput);
                            console.log('File input value:', fileInput.value);
                            console.log('File input files:', fileInput.files);
                            console.log('File input files length:', fileInput.files.length);
                            
                            if (fileInput.files.length > 0) {
                                const file = fileInput.files[0];
                                console.log('Selected file details:', {
                                    name: file.name,
                                    type: file.type,
                                    size: file.size,
                                    lastModified: new Date(file.lastModified).toISOString()
                                });
                            } else {
                                console.log('No file selected');
                            }
                            
                            console.log('Current course ID:', currentCourseId);
                            
                            // Check if the modal is open
                            const modal = document.getElementById('uploadModal');
                            console.log('Upload modal:', modal);
                            console.log('Modal display style:', modal?.style.display);
                            
                            // Check if the upload button is enabled
                            const uploadButton = document.querySelector('.modal-content .btn-primary');
                            console.log('Upload button:', uploadButton);
                            console.log('Upload button disabled state:', uploadButton?.disabled);
                            
                        } catch (error) {
                            console.error('Error checking file upload state:', error);
                        }
                        console.log('=== End File Upload State Check ===');
                    };
                    
                    // Add click event listener for the close button
                    const closeButtons = document.querySelectorAll('.close');
                    closeButtons.forEach(button => {
                        button.addEventListener('click', function() {
                            const modal = this.closest('.modal');
                            if (modal) {
                                closeModal(modal.id);
                            }
                        });
                    });
                });

                function handleLogin(event) {
                    event.preventDefault();
                    try {
                        const organizationName = document.getElementById('username')?.value.trim();
                        
                        if (!organizationName) {
                            showNotification('Please enter your organization name', 'error');
                            return;
                        }

                        // Get existing organizations or initialize empty array
                        let organizations = JSON.parse(localStorage.getItem('organizations') || '[]');
                        
                        // Find or create organization
                        let organization = organizations.find(org => org.name === organizationName);
                        if (!organization) {
                            organization = {
                                id: 'org_' + Date.now(),
                                name: organizationName
                            };
                            organizations.push(organization);
                            localStorage.setItem('organizations', JSON.stringify(organizations));
                        }
                        
                        // Set current organization in both localStorage and global variable
                        localStorage.setItem('currentOrganization', JSON.stringify(organization));
                        currentOrganization = organization;
                        
                        showWelcomeBanner(organization.name);
                        showSection('courses');  // Show courses section by default after login
                        updateMyCoursesTable(); // Update the courses table
                        showNotification('Login successful', 'success');
                    } catch (error) {
                        console.error('Login error:', error);
                        showNotification('Error during login', 'error');
                    }
                }

                function handleLogout() {
                    localStorage.removeItem('currentOrganization');
                    currentOrganization = null; // Clear the global variable
                    showWelcomeBanner('Welcome!');
                    showSection('login');
                    showNotification('Logged out successfully', 'success');
                }

                function showWelcomeBanner(name) {
                    document.getElementById('welcomeMessage').textContent = `Welcome, ${name}!`;
                }

                function handleScheduleCourse(event) {
                    event.preventDefault();
                    try {
                        const organization = JSON.parse(localStorage.getItem('currentOrganization'));
                        if (!organization) {
                            showNotification('Please log in first', 'error');
                            return;
                        }

                        const courseDate = document.getElementById('courseDate').value;
                        const location = document.getElementById('location').value;
                        const classType = document.getElementById('classType').value;
                        const studentsRegistered = parseInt(document.getElementById('studentsRegistered').value) || 0;
                        const notes = document.getElementById('notes').value.trim();

                        // Create new course with initial status
                        const course = {
                            id: 'course_' + Date.now(),
                            organizationId: organization.id,
                            organizationName: organization.name,
                            courseDate: courseDate,
                            systemDate: new Date().toISOString().split('T')[0],
                            location: location,
                            classType: classType,
                            // Status fields
                            status: 'PENDING',                    // Organization Portal view
                            adminConfirmed: false,                // Admin confirmation flag
                            adminScheduledDashStatus: 'PENDING',  // Admin Portal Scheduled Courses view
                            adminInstructorDashStatus: 'PENDING', // Admin Portal Instructor Dashboard
                            organizationStatus: 'PENDING',        // Organization Portal status
                            instructorStatus: '',                 // Instructor Portal status
                            // Course details
                            studentsRegistered: studentsRegistered,
                            studentsAttended: 0,
                            notes: notes,
                            studentList: [],
                            // Instructor fields (initially empty)
                            instructorId: '',
                            instructorName: '',
                            // Additional fields
                            completionStatus: '',
                            isArchived: false,
                            displayInstructorDetails: false,      // Hide instructor details until confirmed
                            displayOrgDetails: false              // Hide org details in instructor view until confirmed
                        };

                        // Save course
                        const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                        courses.push(course);
                        localStorage.setItem('courses', JSON.stringify(courses));

                        showNotification('Course scheduled successfully', 'success');
                        event.target.reset();
                        updateMyCoursesTable();
                        showSection('courses'); // Switch to My Courses view after scheduling
                    } catch (error) {
                        console.error('Error scheduling course:', error);
                        showNotification('Error scheduling course', 'error');
                    }
                }

                function showSection(sectionId) {
                    try {
                        // Hide all sections
                        document.querySelectorAll('.section').forEach(section => {
                            section.classList.remove('active');
                        });
                        
                        // Show the selected section
                        const selectedSection = document.getElementById(sectionId);
                        if (selectedSection) {
                            selectedSection.classList.add('active');
                            
                            // Update navigation buttons
                            document.querySelectorAll('.nav-button').forEach(button => {
                                button.classList.toggle('active', button.dataset.section === sectionId);
                            });
                            
                            // If showing myCourses, update the table
                            if (sectionId === 'myCourses') {
                                updateMyCoursesTable();
                            }
                            // If showing archived courses, update the list
                            if (sectionId === 'archivedCourses') {
                                updateArchivedCoursesList();
                            }
                        }
                    } catch (error) {
                        console.error('Error showing section:', error);
                        showNotification('Error changing sections', 'error');
                    }
                }

                function updateMyCoursesTable() {
                    try {
                        const currentOrg = JSON.parse(localStorage.getItem('currentOrganization'));
                        if (!currentOrg) {
                            showNotification('Please log in to view courses', 'error');
                            return;
                        }

                        console.log('Updating courses table for organization:', currentOrg.name);
                        const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                        const tbody = document.getElementById('coursesTableBody');
                        
                        if (!tbody) return;

                        // Filter courses for current organization only
                        const orgCourses = courses.filter(course => course.organizationId === currentOrg.id && !course.isArchived);
                        console.log('Found', orgCourses.length, 'courses for organization');

                        if (orgCourses.length === 0) {
                            tbody.innerHTML = `
                                <tr>
                                    <td colspan="9" style="text-align: center;">No courses found. Schedule a course to get started.</td>
                                </tr>
                            `;
                            return;
                        }

                        // Sort courses by date (most recent first)
                        orgCourses.sort((a, b) => new Date(b.courseDate) - new Date(a.courseDate));

                        // Generate table rows
                        tbody.innerHTML = orgCourses.map(course => {
                            const statusClass = course.completionStatus === 'COMPLETED' ? 'complete' :
                                course.adminConfirmed ? 'confirmed' :
                                course.instructorId ? 'scheduled' : 'pending';

                            const statusText = course.completionStatus === 'COMPLETED' ? 'COMPLETED' :
                                course.adminConfirmed ? 'CONFIRMED' :
                                course.instructorId ? 'SCHEDULED' : 'PENDING';

                            const attendanceText = course.studentsAttended ? 
                                `${course.studentsAttended}/${course.studentsRegistered} Present` : 
                                'Not Taken';

                            const notes = course.notes || '';
                            const truncatedNotes = notes.length > 50 ? notes.substring(0, 50) + '...' : notes;

                            return `
                                <tr>
                                    <td>${formatDate(course.courseDate)}</td>
                                    <td>${course.location}</td>
                                    <td>${course.classType}</td>
                                    <td>${course.studentsRegistered || 0}</td>
                                    <td>${attendanceText}</td>
                                    <td><span class="status-${statusClass.toLowerCase()}">${statusText}</span></td>
                                    <td>${course.displayInstructorDetails ? (course.instructorName || 'Not Assigned') : '-'}</td>
                                    <td><span title="${notes}">${truncatedNotes}</span></td>
                                    <td>
                                        <button class="btn btn-primary" onclick="viewStudentList('${course.id}')">
                                            View Students
                                        </button>
                                        <button class="btn btn-success" onclick="showUploadModal('${course.id}')">
                                            Upload List
                                        </button>
                                        ${course.completionStatus === 'COMPLETED' ? 
                                            `<button class="btn btn-info" onclick="viewCertificate('${course.id}')">
                                                Certificates
                                            </button>` : 
                                            ''
                                        }
                                    </td>
                                </tr>
                            `;
                        }).join('');
                    } catch (error) {
                        console.error('Error updating course list:', error);
                        showNotification('Error loading courses', 'error');
                    }
                }

                function formatDate(dateString) {
                    if (!dateString) return '';
                    const date = new Date(dateString);
                    return date.toISOString().split('T')[0];
                }

                function viewStudentList(courseId) {
                    try {
                        const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                        const course = courses.find(c => c.id === courseId);
                        
                        if (!course) {
                            showNotification('Course not found', 'error');
                            return;
                        }

                            const studentListTableBody = document.getElementById('studentListTableBody');
                        if (!studentListTableBody) {
                            showNotification('Error: Student list table not found', 'error');
                            return;
                        }
                            
                            // Clear existing content
                            studentListTableBody.innerHTML = '';
                            
                            if (!course.studentList || course.studentList.length === 0) {
                                studentListTableBody.innerHTML = `
                                    <tr>
                                        <td colspan="3" style="text-align: center;">No students added yet</td>
                                    </tr>
                                `;
                            } else {
                            studentListTableBody.innerHTML = `
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Status</th>
                                    ${course.adminConfirmed ? '<th>Attendance</th>' : ''}
                                </tr>
                            `;
                            course.studentList.forEach((student, index) => {
                                    const row = document.createElement('tr');
                                    row.innerHTML = `
                                        <td>${student.name || '-'}</td>
                                        <td>${student.email || '-'}</td>
                                        <td>${student.status || 'Registered'}</td>
                                    ${course.adminConfirmed ? `
                                        <td>${student.attendance ? 
                                            `<span class="status-${student.attendance}">${student.attendance.toUpperCase()}</span>` : 
                                            'Not Recorded'}</td>
                                    ` : ''}
                                    `;
                                    studentListTableBody.appendChild(row);
                                });
                            }
                            
                            // Show the modal
                        const modal = document.getElementById('studentListModal');
                        if (modal) {
                            modal.style.display = 'block';
                        } else {
                            showNotification('Error: Student list modal not found', 'error');
                        }
                    } catch (error) {
                        console.error('Error viewing student list:', error);
                        showNotification('Error loading student list', 'error');
                    }
                }

                function closeStudentListModal() {
                    try {
                        const modal = document.getElementById('studentListModal');
                        if (modal) {
                            modal.style.display = 'none';
                        }
                    } catch (error) {
                        console.error('Error closing student list modal:', error);
                        showNotification('Error closing modal', 'error');
                    }
                }

                function showUploadModal(courseId) {
                    console.log('=== Upload Modal Debug ===');
                    console.log('Opening upload modal for course:', courseId);
                    currentCourseId = courseId;
                    
                    const modal = document.getElementById('uploadModal');
                    console.log('Modal element:', modal);
                    
                    const fileInput = document.getElementById('excelFile');
                    console.log('File input element:', fileInput);
                    
                    if (modal) {
                        modal.style.display = 'block';
                        console.log('Modal displayed');
                    } else {
                        console.error('Upload modal not found');
                        showNotification('Error: Upload modal not found', 'error');
                    }
                }

                function handleFileSelect(event) {
                    console.log('=== File Selection Debug ===');
                    console.log('Event triggered:', event);
                    console.log('Event target:', event.target);
                    console.log('Files array:', event.target.files);
                    console.log('Files array length:', event.target.files.length);
                    
                    selectedFile = event.target.files[0];  // Store the selected file
                    console.log('Selected file:', selectedFile);
                    
                    if (selectedFile) {
                        console.log('File details:', {
                            name: selectedFile.name,
                            type: selectedFile.type,
                            size: selectedFile.size,
                            lastModified: new Date(selectedFile.lastModified).toISOString()
                        });
                        
                        // Enable the upload button
                        const uploadButton = event.target.closest('.modal-content').querySelector('.btn-primary');
                        if (uploadButton) {
                            uploadButton.disabled = false;
                            console.log('Upload button enabled');
                        }
                    } else {
                        console.log('No file selected');
                        
                        // Disable the upload button
                        const uploadButton = event.target.closest('.modal-content').querySelector('.btn-primary');
                        if (uploadButton) {
                            uploadButton.disabled = true;
                            console.log('Upload button disabled');
                        }
                    }
                }

                function handleExcelUpload() {
                    try {
                        console.log('=== Starting File Upload Process ===');
                        console.log('Selected file:', selectedFile);
                        
                        if (!selectedFile) {
                            console.log('No file selected');
                            showNotification('Please select a file to upload', 'error');
                            return;
                        }

                        // Show progress bar
                        const progressContainer = document.querySelector('.progress-container');
                        const progressBar = document.querySelector('.progress-bar');
                        const progressText = document.querySelector('.progress-text');
                        
                        progressContainer.style.display = 'block';
                        progressBar.style.width = '0%';
                        progressText.textContent = '0%';

                        const reader = new FileReader();
                        console.log('FileReader created');

                        reader.onload = function(e) {
                            try {
                                console.log('FileReader onload triggered');
                                progressBar.style.width = '50%';
                                progressText.textContent = '50%';

                                const data = e.target.result;
                                const workbook = XLSX.read(data, { type: 'binary' });
                                const sheetName = workbook.SheetNames[0];
                                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                                
                                if (!currentCourseId) {
                                    console.log('No course ID found');
                                    showNotification('No course selected for upload', 'error');
                                    progressContainer.style.display = 'none';
                                    return;
                                }

                                // Load existing courses
                                const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                                const courseIndex = courses.findIndex(course => course.id === currentCourseId);
                                
                                if (courseIndex === -1) {
                                    console.log('Course not found');
                                    showNotification('Course not found', 'error');
                                    progressContainer.style.display = 'none';
                                    return;
                                }

                                // Process students from Excel and create a new student list specific to this course
                                const newStudentList = jsonData.map(student => ({
                                    id: 'student_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                                    name: student.Name || student.name || '',
                                    email: (student.Email || student.email || '').toLowerCase().trim(),
                                    phone: (student.Phone || student.phone || '').trim(),
                                    status: 'Registered',
                                    attendance: '',
                                    registrationDate: new Date().toISOString()
                                }));

                                // Update the course with the new student list
                                courses[courseIndex].studentList = newStudentList;
                                courses[courseIndex].studentsRegistered = newStudentList.length;
                                
                                // Save the updated courses
                                localStorage.setItem('courses', JSON.stringify(courses));

                                progressBar.style.width = '100%';
                                progressText.textContent = '100%';

                                setTimeout(() => {
                                    progressContainer.style.display = 'none';
                                    showNotification('Student list uploaded successfully', 'success');
                                    closeModal('uploadModal');
                                    updateMyCoursesTable();
                                }, 500);

                            } catch (error) {
                                console.error('Error processing Excel file:', error);
                                showNotification('Error processing Excel file', 'error');
                                progressContainer.style.display = 'none';
                            }
                        };

                        reader.onerror = function(error) {
                            console.error('Error reading file:', error);
                            showNotification('Error reading file', 'error');
                            progressContainer.style.display = 'none';
                        };

                        reader.readAsBinaryString(selectedFile);
                    } catch (error) {
                        console.error('Error handling file upload:', error);
                        showNotification('Error handling file upload', 'error');
                        document.querySelector('.progress-container').style.display = 'none';
                    }
                }

                function downloadTemplate() {
                    try {
                        // Create workbook with template data
                        const wb = XLSX.utils.book_new();
                        const wsData = [
                            ['Name', 'Email', 'Phone', 'Status'],
                            // Empty row for example format
                            ['', '', '', 'Registered']
                        ];
                        const ws = XLSX.utils.aoa_to_sheet(wsData);
                        
                        // Add worksheet to workbook
                        XLSX.utils.book_append_sheet(wb, ws, 'Students');
                        
                        // Save the file
                        XLSX.writeFile(wb, 'student_template.xlsx');
                        showNotification('Template downloaded successfully', 'success');
                    } catch (error) {
                        console.error('Error downloading template:', error);
                        showNotification('Error downloading template', 'error');
                    }
                }

                function showNotification(message, type) {
                    try {
                        const notification = document.getElementById('notification');
                        if (notification) {
                            notification.textContent = message;
                            notification.className = `notification notification-${type}`;
                            notification.style.display = 'block';
                            
                            setTimeout(() => {
                                notification.style.display = 'none';
                            }, 3000);
                        }
                    } catch (error) {
                        console.error('Error showing notification:', error);
                    }
                }

                function updateArchivedCoursesList() {
                    try {
                        const organization = JSON.parse(localStorage.getItem('currentOrganization'));
                        if (!organization) return;

                        const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                        const tableBody = document.getElementById('archivedCoursesTableBody');
                        
                        if (!tableBody) return;

                        // Filter archived courses for this organization
                        const archivedCourses = courses.filter(course => 
                            course.organizationId === organization.id && 
                            course.isArchived === true
                        );

                        // Sort by archived date (most recent first)
                        archivedCourses.sort((a, b) => new Date(b.archivedDate) - new Date(a.archivedDate));

                        // Update archived courses table
                        tableBody.innerHTML = archivedCourses.length ? 
                            archivedCourses.map(course => `
                                <tr>
                                    <td>${formatDate(course.courseDate)}</td>
                                    <td>${course.location}</td>
                                    <td>${course.classType}</td>
                                    <td>${course.studentsRegistered || 0}</td>
                                    <td><span class="status status-archived">Archived</span></td>
                                    <td>${course.displayInstructorName ? course.instructorName : 'Not Assigned'}</td>
                                    <td class="note-cell" data-full-note="${course.notes || '-'}">${course.notes || '-'}</td>
                                    <td>
                                        <button class="btn btn-primary" onclick="viewStudentList('${course.id}')">View Students</button>
                                        <button class="btn btn-secondary" onclick="unarchiveCourse('${course.id}')">Unarchive</button>
                                    </td>
                                </tr>
                            `).join('') :
                            '<tr><td colspan="8" style="text-align: center;">No archived courses found</td></tr>';
                    } catch (error) {
                        console.error('Error updating archived courses list:', error);
                        showNotification('Error updating archived courses list', 'error');
                    }
                }

                function unarchiveCourse(courseId) {
                    try {
                        const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                        const courseIndex = courses.findIndex(c => c.id === courseId);

                        if (courseIndex === -1) {
                            showNotification('Course not found', 'error');
                            return;
                        }

                        // Remove archive status
                        courses[courseIndex].isArchived = false;
                        delete courses[courseIndex].archivedDate;
                        delete courses[courseIndex].autoArchiveDate;

                        localStorage.setItem('courses', JSON.stringify(courses));
                        updateArchivedCoursesList();
                        updateMyCoursesTable();
                        showNotification('Course unarchived successfully', 'success');
                    } catch (error) {
                        console.error('Error unarchiving course:', error);
                        showNotification('Error unarchiving course', 'error');
                    }
                }

                function deleteCourse(courseId) {
                    if (!confirm('Are you sure you want to delete this course? This action cannot be undone.')) {
                        return;
                    }

                    try {
                        const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                        const courseIndex = courses.findIndex(c => c.id === courseId);

                        if (courseIndex === -1) {
                            showNotification('Course not found', 'error');
                            return;
                        }

                        // Remove the course
                        courses.splice(courseIndex, 1);
                        localStorage.setItem('courses', JSON.stringify(courses));

                        // Update the display
                        updateMyCoursesTable();
                        showNotification('Course deleted successfully', 'success');
                    } catch (error) {
                        console.error('Error deleting course:', error);
                        showNotification('Error deleting course', 'error');
                    }
                }

                // Date handling functions
                function formatDateForStorage(date) {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }

                function formatDateForDisplay(dateString) {
                    if (!dateString) return '-';
                    const [year, month, day] = dateString.split('-');
                    return `${month}/${day}/${year}`;
                }

                function getCurrentDate() {
                    const now = new Date();
                    return formatDateForStorage(now);
                }

                // Update sorting function
                function sortCourses(courses) {
                    return courses.sort((a, b) => {
                        const [yearA, monthA, dayA] = a.courseDate.split('-');
                        const [yearB, monthB, dayB] = b.courseDate.split('-');
                        return new Date(yearA, monthA - 1, dayA).getTime() - new Date(yearB, monthB - 1, dayB).getTime();
                    });
                }

                // Update bulk scheduling
                function handleBulkScheduling() {
                    const startDate = document.getElementById('bulkStartDate').value;
                    const endDate = document.getElementById('bulkEndDate').value;
                    
                    if (!startDate || !endDate) {
                        showNotification('Please select both start and end dates', 'error');
                        return;
                    }

                    // Generate dates in between
                    const dates = [];
                    let [startYear, startMonth, startDay] = startDate.split('-').map(Number);
                    const [endYear, endMonth, endDay] = endDate.split('-').map(Number);
                    
                    let currentDate = new Date(startYear, startMonth - 1, startDay);
                    const lastDate = new Date(endYear, endMonth - 1, endDay);

                    while (currentDate <= lastDate) {
                        dates.push(formatDateForStorage(currentDate));
                        currentDate.setDate(currentDate.getDate() + 1);
                    }

                    // Show preview
                    showBulkSchedulePreview(dates);
                }

                // Update course creation
                function createCourse(courseData) {
                    try {
                        const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                        const newCourse = {
                            ...courseData,
                            id: 'course_' + Date.now(),
                            systemDate: getCurrentDate(),
                            status: 'PENDING',
                            adminConfirmed: false,
                            adminScheduledDashStatus: 'PENDING',
                            adminInstructorDashStatus: 'PENDING',
                            organizationStatus: 'PENDING',
                            instructorStatus: '',
                            studentList: []
                        };
                        
                        courses.push(newCourse);
                        localStorage.setItem('courses', JSON.stringify(courses));
                        return true;
                    } catch (error) {
                        console.error('Error creating course:', error);
                        return false;
                    }
                }

                // Update course completion
                function completeCourse(courseId) {
                    try {
                        const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                        const courseIndex = courses.findIndex(c => c.id === courseId);
                        
                        if (courseIndex === -1) return false;
                        
                        const currentDate = getCurrentDate();
                        courses[courseIndex].completedDate = currentDate;
                        courses[courseIndex].status = 'Complete';
                        
                        // Set auto-archive date to 30 days from completion
                        const archiveDate = new Date();
                        archiveDate.setDate(archiveDate.getDate() + 30);
                        courses[courseIndex].autoArchiveDate = formatDateForStorage(archiveDate);
                        
                        localStorage.setItem('courses', JSON.stringify(courses));
                        return true;
                    } catch (error) {
                        console.error('Error completing course:', error);
                        return false;
                    }
                }

                // Update archive handling
                function checkAutoArchive() {
                    try {
                        const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                        const currentDate = getCurrentDate();
                        let updated = false;

                        courses.forEach(course => {
                            if (course.autoArchiveDate && 
                                course.autoArchiveDate <= currentDate && 
                                !course.isArchived) {
                                course.isArchived = true;
                                course.archivedDate = currentDate;
                                updated = true;
                            }
                        });

                        if (updated) {
                            localStorage.setItem('courses', JSON.stringify(courses));
                            updateMyCoursesTable();
                        }
                    } catch (error) {
                        console.error('Error checking auto-archive:', error);
                    }
                }

                // Certificate Management Functions
                function viewCertificate(courseId) {
                    try {
                        console.log('=== Certificate View Debug ===');
                        console.log('Course ID:', courseId);

                        const certificates = JSON.parse(localStorage.getItem('certificates') || '[]');
                        console.log('All Certificates:', certificates);
                        console.log('Number of certificates found:', certificates.length);

                        const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                        console.log('All Courses:', courses);
                        console.log('Number of courses found:', courses.length);
                        
                        // Find the certificate
                        const certificate = certificates.find(cert => {
                            console.log('Checking certificate:', cert);
                            console.log('Comparing courseId:', cert.courseId, 'with:', courseId);
                            return cert.courseId === courseId;
                        });

                        console.log('Found certificate:', certificate);

                        if (!certificate) {
                            console.log('Certificate not found. Checking course status...');
                            const course = courses.find(c => c.id === courseId);
                            console.log('Course found:', course);
                            if (course) {
                                console.log('Course completion status:', course.completionStatus);
                                console.log('Course student list:', course.studentList);
                            }
                            showNotification('Certificate not found. Please ensure the course is completed and attendance has been taken.', 'error');
                            return;
                        }

                        // Find the course and student details
                        const course = courses.find(c => c.id === courseId);
                        console.log('Found course:', course);
                        
                        if (!course) {
                            console.log('Course not found in courses array');
                            showNotification('Course details not found', 'error');
                            return;
                        }

                        console.log('Updating certificate modal with data...');
                        // Update certificate modal content
                        document.getElementById('certificateStudentName').textContent = certificate.metadata.studentName;
                        document.getElementById('certificateCourseName').textContent = certificate.metadata.courseName;
                        document.getElementById('certificateNumber').textContent = certificate.certificateNumber;
                        document.getElementById('certificateIssueDate').textContent = formatDate(certificate.issueDate);
                        document.getElementById('certificateExpiryDate').textContent = formatDate(certificate.expiryDate);
                        document.getElementById('certificateInstructorName').textContent = certificate.metadata.instructorName;
                        document.getElementById('certificateOrganizationName').textContent = certificate.metadata.organizationName;
                        document.getElementById('certificateCompletionDate').textContent = formatDate(certificate.metadata.completionDate);

                        console.log('Showing certificate modal...');
                        // Show the modal
                        const certificateModal = new bootstrap.Modal(document.getElementById('certificateModal'));
                        certificateModal.show();
                        console.log('=== End Certificate View Debug ===');
                    } catch (error) {
                        console.error('Error in viewCertificate:', error);
                        console.error('Error stack:', error.stack);
                        showNotification('Error loading certificate details', 'error');
                    }
                }

                function downloadCertificate() {
                    try {
                        const certificate = JSON.parse(localStorage.getItem('currentCertificate'));
                        if (!certificate) {
                            showNotification('No certificate selected', 'error');
                            return;
                        }

                        // Generate PDF using certificate data
                        const doc = new jsPDF();
                        // Add certificate content to PDF
                        // ... PDF generation code ...

                        // Download the PDF
                        doc.save(`certificate_${certificate.certificateNumber}.pdf`);
                        showNotification('Certificate downloaded successfully', 'success');
                    } catch (error) {
                        console.error('Error downloading certificate:', error);
                        showNotification('Error downloading certificate', 'error');
                    }
                }

                function printCertificate() {
                    try {
                        const certificate = JSON.parse(localStorage.getItem('currentCertificate'));
                        if (!certificate) {
                            showNotification('No certificate selected', 'error');
                            return;
                        }

                        // Open print dialog for certificate content
                        window.print();
                        showNotification('Certificate printed successfully', 'success');
                    } catch (error) {
                        console.error('Error printing certificate:', error);
                        showNotification('Error printing certificate', 'error');
                    }
                }

                // Update the updateCompletedCourses function to include certificate viewing
                function updateCompletedCourses() {
                    const tbody = document.getElementById('completedCoursesTableBody');
                    if (!tbody) return;

                    const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                    const completedCourses = courses.filter(course => 
                        course.completionStatus === 'COMPLETED' && 
                        course.organizationId === currentOrganization.id
                    );

                    tbody.innerHTML = completedCourses.map(course => `
                        <tr>
                            <td>${formatDate(course.courseDate)}</td>
                            <td>${course.courseName}</td>
                            <td>${course.location}</td>
                            <td>${course.instructorName || 'Not Assigned'}</td>
                            <td>
                                <button class="btn btn-primary" onclick="viewCertificate('${course.id}')">
                                    <i class="fas fa-certificate"></i> View Certificate
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }

                function closeModal(modalId) {
                    const modal = document.getElementById(modalId);
                    if (modal) {
                        modal.style.display = 'none';
                        // Reset file input and progress bar if it's the upload modal
                        if (modalId === 'uploadModal') {
                            const fileInput = document.getElementById('excelFile');
                            if (fileInput) fileInput.value = '';
                            const progressContainer = document.querySelector('.progress-container');
                            if (progressContainer) progressContainer.style.display = 'none';
                            selectedFile = null;
                        }
                    }
                }

                // Course ID Generation
                function generateCourseId(orgName, courseType) {
                    try {
                        // Get organization prefix (first 3 letters uppercase)
                        const orgPrefix = orgName.substring(0, 3).toUpperCase();
                        
                        // Get today's date in YYYYMMDD format
                        const today = new Date();
                        const dateStr = today.getFullYear().toString() +
                                      (today.getMonth() + 1).toString().padStart(2, '0') +
                                      today.getDate().toString().padStart(2, '0');
                        
                        // Get existing courses for this org on this date
                        const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                        const todayCourses = courses.filter(course => {
                            return course.id.startsWith(`${orgPrefix}_${dateStr}_${courseType}`);
                        });
                        
                        // Generate sequence number
                        const sequence = (todayCourses.length + 1).toString().padStart(3, '0');
                        
                        // Construct ID
                        const courseId = `${orgPrefix}_${dateStr}_${courseType}_${sequence}`;
                        console.log('Generated course ID:', courseId);
                        
                        return courseId;
                    } catch (error) {
                        console.error('Error generating course ID:', error);
                        // Fallback to a timestamp-based ID if something goes wrong
                        return `COURSE_${Date.now()}`;
                    }
                }

                function handleCourseSubmit(event) {
                    event.preventDefault();
                    try {
                        console.log('=== Course Creation Started ===');
                        
                        // Get form values
                        const courseDate = document.getElementById('courseDate').value;
                        const location = document.getElementById('location').value;
                        const classType = document.getElementById('classType').value;
                        const notes = document.getElementById('notes').value;
                        
                        if (!courseDate || !location || !classType) {
                            showNotification('Please fill in all required fields', 'error');
                            return;
                        }

                        // Get current organization
                        const currentOrg = JSON.parse(localStorage.getItem('currentOrganization'));
                        if (!currentOrg) {
                            showNotification('Please log in to create courses', 'error');
                            return;
                        }

                        // Generate course ID
                        const courseId = generateCourseId(currentOrg.name, classType);
                        console.log('Generated course ID:', courseId);

                        // Create course object
                        const newCourse = {
                            id: courseId,
                            organizationId: currentOrg.id,
                            courseDate: courseDate,
                            location: location,
                            classType: classType,
                            notes: notes,
                            status: 'PENDING',
                            studentsRegistered: 0,
                            studentList: [],
                            createdAt: new Date().toISOString(),
                            lastModified: new Date().toISOString()
                        };

                        // Get existing courses
                        const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                        courses.push(newCourse);
                        
                        // Save updated courses
                        localStorage.setItem('courses', JSON.stringify(courses));
                        
                        console.log('Course created:', newCourse);
                        
                        // Clear form and close modal
                        document.getElementById('courseForm').reset();
                        closeModal('courseModal');
                        
                        // Update table and show success message
                        updateMyCoursesTable();
                        showNotification('Course created successfully', 'success');
                        
                    } catch (error) {
                        console.error('Error creating course:', error);
                        showNotification('Error creating course', 'error');
                    }
                }
            </script>
        </main>
    </div>

    <!-- Modal for viewing student list -->
    <div id="studentListModal" class="student-list-modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeStudentListModal()">&times;</span>
            <h3>Student List</h3>
            <div id="studentListContent">
                <table class="student-list-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Status</th>
                            ${course.adminConfirmed ? '<th>Attendance</th>' : ''}
                        </tr>
                    </thead>
                    <tbody id="studentListTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add Certificate Modal -->
    <div id="certificateModal" class="modal">
        <div class="modal-content certificate-view">
            <span class="close-modal" onclick="closeModal('certificateModal')">&times;</span>
            <div class="certificate-header">
                <h2>Course Completion Certificate</h2>
                <div class="certificate-actions">
                    <button class="btn btn-primary" onclick="downloadCertificate()">
                        <i class="fas fa-download"></i> Download PDF
                    </button>
                    <button class="btn btn-secondary" onclick="printCertificate()">
                        <i class="fas fa-print"></i> Print
                    </button>
                </div>
            </div>
            <div class="certificate-content">
                <div class="certificate-logo">
                    <h1 style="font-size: 2em; color: #2c3e50; margin-bottom: 20px;">GTA CPR</h1>
                </div>
                <div class="certificate-body">
                    <p class="certificate-title">This is to certify that</p>
                    <h3 class="student-name" id="certificateStudentName"></h3>
                    <p class="certificate-text" id="certificateCourseText"></p>
                    <div class="certificate-details">
                        <p><strong>Course:</strong> <span id="certificateCourseName"></span></p>
                        <p><strong>Instructor:</strong> <span id="certificateInstructorName"></span></p>
                        <p><strong>Certificate Number:</strong> <span id="certificateNumber"></span></p>
                        <p><strong>Issue Date:</strong> <span id="certificateIssueDate"></span></p>
                        <p><strong>Expiry Date:</strong> <span id="certificateExpiryDate"></span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Upload Student List</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="excelFile">Select Excel File:</label>
                    <input type="file" id="excelFile" accept=".xlsx,.xls" onchange="handleFileSelect(event)">
                </div>
                <div class="progress-container" style="display: none;">
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="progress-text">Processing: 0%</div>
                </div>
                <div class="button-group">
                    <button id="uploadBtn" class="btn btn-primary" onclick="handleExcelUpload()" disabled>
                        Upload
                    </button>
                    <button class="btn btn-secondary" onclick="downloadTemplate()">
                        Download Template
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>