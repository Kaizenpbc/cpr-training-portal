<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organization Portal - GTA CPR</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --background-color: #ecf0f1;
            --text-color: #2c3e50;
            --header-height: 60px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
        }

        .main-header {
            background-color: var(--primary-color);
            color: white;
            padding: 0 20px;
            height: var(--header-height);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
        }

        .logo {
            font-size: 1.5rem;
        }

        .main-nav {
            display: flex;
            gap: 20px;
            margin-left: auto;
        }

        .main-nav a {
            color: white;
            text-decoration: none;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .main-nav a:hover {
            background-color: var(--secondary-color);
        }

        .content-wrapper {
            display: flex;
            margin-top: var(--header-height);
            min-height: calc(100vh - var(--header-height));
        }

        .left-nav {
            width: 250px;
            background-color: white;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }

        .left-nav button {
            display: block;
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: none;
            background-color: var(--secondary-color);
            color: white;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .left-nav button:hover {
            background-color: var(--primary-color);
        }

        .main-content {
            flex-grow: 1;
            padding: 20px;
            background-color: var(--background-color);
        }

        .welcome-banner {
            background-color: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .welcome-banner .portal-title {
            flex-grow: 1;
            text-align: center;
        }

        .welcome-banner p {
            margin: 0;
            text-align: right;
        }

        .section {
            display: none;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--dark-color);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-right: 0.5rem;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: var(--light-color);
            font-weight: bold;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .status {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.875rem;
        }

        .status-pending {
            background-color: #ffc107;
            color: #000;
        }

        .status-confirmed {
            background-color: #28a745;
            color: white;
        }

        .status-available {
            background-color: #17a2b8;
            color: white;
        }

        .status-scheduled {
            background-color: #007bff;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            position: relative;
            background-color: white;
            margin: 10% auto;
            padding: 2rem;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .close-modal {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .student-list-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .student-list-table {
            margin-top: 1rem;
            width: 100%;
            border-collapse: collapse;
        }

        .student-list-table th,
        .student-list-table td {
            padding: 0.5rem;
            border: 1px solid #ddd;
        }

        @media (max-width: 768px) {
            .content-wrapper {
                flex-direction: column;
            }

            .left-nav {
                width: 100%;
            }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 4px;
            color: white;
            z-index: 2000;
            display: none;
            animation: slideIn 0.5s ease-in-out;
        }

        .notification-success {
            background-color: var(--success-color);
        }

        .notification-error {
            background-color: var(--danger-color);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .upload-progress {
            margin-top: 1rem;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background-color: var(--primary-color);
            width: 0%;
            transition: width 0.3s ease-in-out;
        }

        /* Analytics Dashboard Styles */
        .analytics-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .analytics-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .analytics-card:hover {
            transform: translateY(-5px);
        }

        .analytics-card .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .analytics-card .card-header i {
            font-size: 1.5rem;
            margin-right: 0.5rem;
            color: var(--primary-color);
        }

        .analytics-card .card-body {
            font-size: 2rem;
            font-weight: bold;
            color: var(--dark-color);
        }

        .analytics-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .analytics-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
        }

        .trends-section {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stats-table {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #courseStatsTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        #courseStatsTable th,
        #courseStatsTable td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        #courseStatsTable th {
            background-color: var(--light-color);
            font-weight: bold;
        }

        .trend-up {
            color: var(--success-color);
        }

        .trend-down {
            color: var(--danger-color);
        }

        .section-content {
            padding: 1rem;
        }

        .welcome-banner {
            background-color: var(--light-color);
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }

        .welcome-banner h3 {
            margin: 0;
            color: var(--dark-color);
            text-align: center;
        }

        .btn-danger {
            background-color: #e74c3c !important;
        }
        .btn-danger:hover {
            background-color: #c0392b !important;
        }
        
        #resetDataModal ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        #resetDataModal p {
            margin: 10px 0;
        }

        /* Add these styles for the truncated notes and tooltip */
        .truncated-note {
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: help;
            position: relative;
        }

        .truncated-note:hover::after {
            content: attr(data-full-note);
            position: absolute;
            left: 0;
            top: 100%;
            background-color: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            z-index: 1000;
            white-space: normal;
            max-width: 300px;
            word-wrap: break-word;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .course-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .course-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .course-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .course-header h3 {
            margin: 0;
            color: var(--primary-color);
        }

        .course-details {
            margin-bottom: 15px;
        }

        .course-details p {
            margin: 8px 0;
        }

        .course-details strong {
            color: var(--primary-color);
        }

        .course-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .status-complete {
            background-color: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .status-confirmed {
            background-color: #17a2b8;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .status-scheduled {
            background-color: #007bff;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .status-pending {
            background-color: #ffc107;
            color: #000;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="logo">GTA CPR</div>
        <nav class="main-nav">
            <a href="Index.html">Home</a>
            <a href="instructor-portal.html">Instructors</a>
            <a href="organization-portal.html">Organizations</a>
            <a href="admin-portal.html">Admin</a>
            <a href="accounting-portal.html">Accounting</a>
        </nav>
    </header>

    <div class="content-wrapper">
        <div class="left-nav">
            <button onclick="showSection('login')">Login</button>
            <button onclick="showSection('schedule')">Schedule Course</button>
            <button onclick="showSection('courses')">My Courses</button>
            <button onclick="showSection('archivedCourses')">Archived Courses</button>
            <button onclick="showSection('students')">Student Lists</button>
            <button onclick="handleLogout()">Logout</button>
        </div>

        <main class="main-content">
            <div class="welcome-banner">
                <div class="portal-title">
                    <h1>Organization Portal</h1>
                </div>
                <p id="welcomeMessage">Please log in to continue.</p>
            </div>

            <section id="login" class="section active">
                <h2>Organization Login</h2>
                <form onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label for="username">Organization Name:</label>
                        <input type="text" id="username" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Login</button>
                </form>
            </section>

            <section id="schedule" class="section">
                <h2>Schedule Course</h2>
                <form onsubmit="handleScheduleCourse(event)">
                    <div class="form-group">
                        <label for="courseDate">Date:</label>
                        <input type="date" id="courseDate" required>
                    </div>
                    <div class="form-group">
                        <label for="location">Location:</label>
                        <input type="text" id="location" required>
                    </div>
                    <div class="form-group">
                        <label for="classType">Class Type:</label>
                        <select id="classType" required>
                            <option value="">Select a class type</option>
                            <option value="BLS">BLS - Basic Life Support</option>
                            <option value="ACLS">ACLS - Advanced Cardiac Life Support</option>
                            <option value="PALS">PALS - Pediatric Advanced Life Support</option>
                            <option value="CPR">CPR - Cardiopulmonary Resuscitation</option>
                            <option value="First Aid">First Aid</option>
                            <option value="AED">AED - Automated External Defibrillator</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="studentsRegistered">Students Registered:</label>
                        <input type="number" id="studentsRegistered" min="1" required>
                    </div>
                    <div class="form-group">
                        <label for="notes">Notes (max 100 characters):</label>
                        <textarea id="notes" maxlength="100" rows="2"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Schedule Course</button>
                </form>
            </section>

            <section id="courses" class="section">
                <h2>My Courses</h2>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Location</th>
                                <th>Class Type</th>
                                <th>Students Registered</th>
                                <th>Students Attendance</th>
                                <th>Status</th>
                                <th>Assigned Instructor</th>
                                <th>Notes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="coursesTableBody"></tbody>
                    </table>
                </div>
            </section>

            <section id="archivedCourses" class="section">
                <h2>Archived Courses</h2>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Location</th>
                                <th>Class Type</th>
                                <th>Students</th>
                                <th>Status</th>
                                <th>Instructor</th>
                                <th>Notes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="archivedCoursesTableBody"></tbody>
                    </table>
                </div>
            </section>

            <section id="students" class="section">
                <h2>Student Lists</h2>
                <div class="upload-section">
                    <h3>Upload Student List</h3>
                    <p>Select a course to upload student list:</p>
                    <select id="courseSelect" onchange="updateCurrentCourseId(this.value)">
                        <option value="">Select a course</option>
                    </select>
                    <div class="form-group">
                        <label for="studentListFile">Upload Excel File:</label>
                        <input type="file" id="studentListFile" accept=".xlsx,.xls">
                    </div>
                    <button onclick="handleFileUpload()" class="btn btn-primary">Upload List</button>
                    <a href="templates/student-list-template.xlsx" download class="btn btn-secondary">Download Template</a>
                </div>
                <div class="student-lists">
                    <h3>Existing Student Lists</h3>
                    <div id="existingLists"></div>
                </div>
            </section>

            <div id="notification" class="notification"></div>

            <script>
                // Global variables
                let currentOrganization = null;
                let currentStudents = [];
                let currentSort = { column: null, ascending: true };
                let currentCourseId = null;

                // Initialize on page load
                document.addEventListener('DOMContentLoaded', () => {
                    checkSession();
                    updateMyCoursesTable();
                    
                    // Add periodic refresh
                    setInterval(updateMyCoursesTable, 5000);
                });

                function checkSession() {
                    const organization = JSON.parse(localStorage.getItem('currentOrganization'));
                    if (organization) {
                        showWelcomeBanner(organization.name);
                        showSection('courses');  // Show courses section by default after login
                    } else {
                        showSection('login');
                    }
                }

                function handleLogin(event) {
                    event.preventDefault();
                    try {
                        const organizationName = document.getElementById('username')?.value.trim();
                        
                        if (!organizationName) {
                            showNotification('Please enter your organization name', 'error');
                            return;
                        }

                        // Get existing organizations or initialize empty array
                        let organizations = JSON.parse(localStorage.getItem('organizations') || '[]');
                        
                        // Find or create organization
                        let organization = organizations.find(org => org.name === organizationName);
                        if (!organization) {
                            organization = {
                                id: 'org_' + Date.now(),
                                name: organizationName
                            };
                            organizations.push(organization);
                            localStorage.setItem('organizations', JSON.stringify(organizations));
                        }
                        
                        // Set current organization in session
                        localStorage.setItem('currentOrganization', JSON.stringify(organization));
                        
                        showWelcomeBanner(organization.name);
                        showSection('courses');  // Show courses section by default after login
                        showNotification('Login successful', 'success');
                    } catch (error) {
                        console.error('Login error:', error);
                        showNotification('Error during login', 'error');
                    }
                }

                function handleLogout() {
                    localStorage.removeItem('currentOrganization');
                    showWelcomeBanner('Welcome!');
                    showSection('login');
                    showNotification('Logged out successfully', 'success');
                }

                function showWelcomeBanner(name) {
                    document.getElementById('welcomeMessage').textContent = `Welcome, ${name}!`;
                }

                function handleScheduleCourse(event) {
                    event.preventDefault();
                    try {
                        const organization = JSON.parse(localStorage.getItem('currentOrganization'));
                        if (!organization) {
                            showNotification('Please log in first', 'error');
                            return;
                        }

                        const courseDate = document.getElementById('courseDate').value;
                        const location = document.getElementById('location').value;
                        const classType = document.getElementById('classType').value;
                        const studentsRegistered = parseInt(document.getElementById('studentsRegistered').value) || 0;
                        const notes = document.getElementById('notes').value.trim();

                        // Create new course with initial status
                        const course = {
                            id: 'course_' + Date.now(),
                            organizationId: organization.id,
                            organizationName: organization.name,
                            courseDate: courseDate,
                            systemDate: new Date().toISOString().split('T')[0],
                            location: location,
                            classType: classType,
                            // Status fields
                            status: 'PENDING',                    // Organization Portal view
                            adminConfirmed: false,                // Admin confirmation flag
                            adminScheduledDashStatus: 'PENDING',  // Admin Portal Scheduled Courses view
                            adminInstructorDashStatus: 'PENDING', // Admin Portal Instructor Dashboard
                            organizationStatus: 'PENDING',        // Organization Portal status
                            instructorStatus: '',                 // Instructor Portal status
                            // Course details
                            studentsRegistered: studentsRegistered,
                            studentsAttended: 0,
                            notes: notes,
                            studentList: [],
                            // Instructor fields (initially empty)
                            instructorId: '',
                            instructorName: '',
                            // Additional fields
                            completionStatus: '',
                            isArchived: false,
                            displayInstructorDetails: false,      // Hide instructor details until confirmed
                            displayOrgDetails: false              // Hide org details in instructor view until confirmed
                        };

                        // Save course
                        const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                        courses.push(course);
                        localStorage.setItem('courses', JSON.stringify(courses));

                        showNotification('Course scheduled successfully', 'success');
                        event.target.reset();
                        updateMyCoursesTable();
                        showSection('courses'); // Switch to My Courses view after scheduling
                    } catch (error) {
                        console.error('Error scheduling course:', error);
                        showNotification('Error scheduling course', 'error');
                    }
                }

                function showSection(sectionId) {
                    try {
                        // Hide all sections
                        document.querySelectorAll('.section').forEach(section => {
                            section.classList.remove('active');
                        });
                        
                        // Show the selected section
                        const selectedSection = document.getElementById(sectionId);
                        if (selectedSection) {
                            selectedSection.classList.add('active');
                            
                            // Update navigation buttons
                            document.querySelectorAll('.nav-button').forEach(button => {
                                button.classList.toggle('active', button.dataset.section === sectionId);
                            });
                            
                            // If showing myCourses, update the table
                            if (sectionId === 'myCourses') {
                                updateMyCoursesTable();
                            }
                            // If showing archived courses, update the list
                            if (sectionId === 'archivedCourses') {
                                updateArchivedCoursesList();
                            }
                        }
                    } catch (error) {
                        console.error('Error showing section:', error);
                        showNotification('Error changing sections', 'error');
                    }
                }

                function updateMyCoursesTable() {
                    try {
                        const currentOrg = JSON.parse(localStorage.getItem('currentOrganization'));
                        if (!currentOrg) {
                            showNotification('Please log in to view courses', 'error');
                            return;
                        }

                        const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                        const tbody = document.getElementById('coursesTableBody');
                        
                        if (!tbody) return;

                        // Filter courses for current organization
                        const orgCourses = courses.filter(course => course.organizationId === currentOrg.id);

                        if (orgCourses.length === 0) {
                            tbody.innerHTML = `
                                <tr>
                                    <td colspan="9" style="text-align: center;">No courses found. Schedule a course to get started.</td>
                                </tr>
                            `;
                            return;
                        }

                        // Generate table rows
                        tbody.innerHTML = orgCourses.map(course => {
                            const statusClass = course.completionStatus === 'COMPLETED' ? 'complete' :
                                course.adminConfirmed ? 'confirmed' :
                                course.instructorId ? 'pending' : 'pending';

                            const statusText = course.completionStatus === 'COMPLETED' ? 'COMPLETED' :
                                course.adminConfirmed ? 'CONFIRMED' :
                                course.instructorId ? 'PENDING' : 'PENDING';

                            const attendanceText = course.studentsAttended ? 
                                `${course.studentsAttended}/${course.studentsRegistered} Present` : 
                                'Not Taken';

                            const notes = course.notes || '';
                            const truncatedNotes = notes.length > 50 ? notes.substring(0, 50) + '...' : notes;

                            return `
                                <tr>
                                    <td>${formatDate(course.courseDate)}</td>
                                    <td>${course.location}</td>
                                    <td>${course.classType}</td>
                                    <td>${course.studentsRegistered || 0}</td>
                                    <td>${attendanceText}</td>
                                    <td><span class="status-${statusClass}">${statusText}</span></td>
                                    <td>${course.displayInstructorDetails ? (course.instructorName || 'Not Assigned') : '-'}</td>
                                    <td><span title="${notes}">${truncatedNotes}</span></td>
                                    <td>
                                        <button class="btn btn-primary" onclick="viewStudentList('${course.id}')">
                                            View Student List
                                        </button>
                                        <button class="btn btn-success" onclick="showUploadModal('${course.id}')">
                                            UPLOAD
                                        </button>
                                        ${course.completionStatus === 'COMPLETED' ? 
                                            `<button class="btn btn-info" onclick="viewCertificates('${course.id}')">
                                                View Certificates
                                            </button>` : 
                                            ''
                                        }
                                    </td>
                                </tr>
                            `;
                        }).join('');
                    } catch (error) {
                        console.error('Error updating course list:', error);
                        showNotification('Error loading courses', 'error');
                    }
                }

                function formatDate(dateString) {
                    if (!dateString) return '';
                    const date = new Date(dateString);
                    return date.toISOString().split('T')[0];
                }

                function viewStudentList(courseId) {
                    try {
                        const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                        const course = courses.find(c => c.id === courseId);
                        
                        if (!course) {
                            showNotification('Course not found', 'error');
                            return;
                        }

                        const studentListTableBody = document.getElementById('studentListTableBody');
                        if (!studentListTableBody) {
                            showNotification('Error: Student list table not found', 'error');
                            return;
                        }
                        
                        // Clear existing content
                        studentListTableBody.innerHTML = '';
                        
                        if (!course.studentList || course.studentList.length === 0) {
                            studentListTableBody.innerHTML = `
                                <tr>
                                    <td colspan="3" style="text-align: center;">No students added yet</td>
                                </tr>
                            `;
                        } else {
                            studentListTableBody.innerHTML = `
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Status</th>
                                    ${course.adminConfirmed ? '<th>Attendance</th>' : ''}
                                </tr>
                            `;
                            course.studentList.forEach((student, index) => {
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td>${student.name || '-'}</td>
                                    <td>${student.email || '-'}</td>
                                    <td>${student.status || 'Registered'}</td>
                                    ${course.adminConfirmed ? `
                                        <td>${student.attendance ? 
                                            `<span class="status-${student.attendance}">${student.attendance.toUpperCase()}</span>` : 
                                            'Not Recorded'}</td>
                                    ` : ''}
                                `;
                                studentListTableBody.appendChild(row);
                            });
                        }
                        
                        // Show the modal
                        const modal = document.getElementById('studentListModal');
                        if (modal) {
                            modal.style.display = 'block';
                        } else {
                            showNotification('Error: Student list modal not found', 'error');
                        }
                    } catch (error) {
                        console.error('Error viewing student list:', error);
                        showNotification('Error loading student list', 'error');
                    }
                }

                function closeStudentListModal() {
                    try {
                        const modal = document.getElementById('studentListModal');
                        if (modal) {
                            modal.style.display = 'none';
                        }
                    } catch (error) {
                        console.error('Error closing student list modal:', error);
                        showNotification('Error closing modal', 'error');
                    }
                }

                function showUploadModal(courseId) {
                    console.log('Opening upload modal for course:', courseId);
                    currentCourseId = courseId;
                    const modal = document.getElementById('uploadModal');
                    const fileInput = document.getElementById('studentListFileModal');
                    
                    // Reset the file input
                    if (fileInput) {
                        fileInput.value = '';
                    }
                    
                    if (modal) {
                        modal.style.display = 'block';
                    } else {
                        console.error('Upload modal not found');
                        showNotification('Error: Upload modal not found', 'error');
                    }
                }

                function updateCurrentCourseId(courseId) {
                    currentCourseId = courseId;
                    console.log('Current course ID updated:', currentCourseId);
                }

                function handleFileUpload(event) {
                    if (event) event.preventDefault();
                    console.log('handleFileUpload function started');
                    try {
                        // Get the file input from the modal
                        const fileInput = document.getElementById('studentListFileModal');
                        console.log('File input element:', fileInput);
                        console.log('File input files:', fileInput.files);
                        
                        const file = fileInput.files[0];
                        console.log('Selected file:', file);
                        
                        if (!file) {
                            console.log('No file selected');
                            showNotification('Please select a file', 'error');
                            return;
                        }

                        if (!currentCourseId) {
                            console.log('No course selected');
                            showNotification('Please select a course first', 'error');
                            return;
                        }

                        console.log('File selected successfully:', file.name);

                        // Show progress bar
                        const progressContainer = document.querySelector('.progress-container');
                        const progressBarFill = document.querySelector('.progress-bar-fill');
                        const progressPercentage = document.getElementById('progressPercentage');
                        progressContainer.style.display = 'block';
                        progressBarFill.style.width = '0%';
                        progressPercentage.textContent = '0%';

                        // Process the file
                        const reader = new FileReader();
                        console.log('FileReader created');
                        
                        reader.onload = function(e) {
                            console.log('FileReader onload triggered');
                            try {
                                const data = new Uint8Array(e.target.result);
                                console.log('File data read:', data.length, 'bytes');
                                
                                const workbook = XLSX.read(data, { type: 'array' });
                                console.log('Workbook read successfully');
                                
                                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                                console.log('First sheet:', workbook.SheetNames[0]);
                                
                                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                                console.log('JSON data extracted:', jsonData.length, 'rows');

                                // Update course with student list
                                const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                                console.log('Current courses:', courses.length);
                                
                                const courseIndex = courses.findIndex(c => c.id === currentCourseId);
                                console.log('Course index:', courseIndex);
                                
                                if (courseIndex !== -1) {
                                    // Create student list with all fields
                                    courses[courseIndex].studentList = jsonData.map(student => ({
                                        name: student.Name || student.name || '',
                                        email: student.Email || student.email || '',
                                        phone: student.Phone || student.phone || '',
                                        status: student.Status || student.status || 'Registered',
                                        attendance: '' // Set attendance to blank initially
                                    }));
                                    
                                    // Update the students registered count
                                    courses[courseIndex].studentsRegistered = courses[courseIndex].studentList.length;
                                    courses[courseIndex].studentsAttended = 0; // Reset attended count
                                    
                                    console.log('Updated course:', courses[courseIndex]);
                                    localStorage.setItem('courses', JSON.stringify(courses));
                                    
                                    // Update progress bar to 100%
                                    progressBarFill.style.width = '100%';
                                    progressPercentage.textContent = '100%';
                                    
                                    // Show success message and close modal after a delay
                                    setTimeout(() => {
                                        showNotification('Student list uploaded successfully', 'success');
                                        closeModal('uploadModal');
                                        updateMyCoursesTable();
                                        fileInput.value = ''; // Clear the file input
                                    }, 500);
                                } else {
                                    console.error('Course not found with ID:', currentCourseId);
                                    showNotification('Course not found', 'error');
                                }
                            } catch (error) {
                                console.error('Error processing file:', error);
                                showNotification('Error processing file. Please check the format.', 'error');
                            }
                        };
                        
                        reader.onerror = function(error) {
                            console.error('FileReader error:', error);
                            showNotification('Error reading file', 'error');
                        };
                        
                        // Update progress as file is read
                        reader.onprogress = function(e) {
                            if (e.lengthComputable) {
                                const progress = Math.round((e.loaded / e.total) * 100);
                                progressBarFill.style.width = `${progress}%`;
                                progressPercentage.textContent = `${progress}%`;
                            }
                        };
                        
                        console.log('Starting file read');
                        reader.readAsArrayBuffer(file);
                    } catch (error) {
                        console.error('Error in handleFileUpload:', error);
                        showNotification('Error uploading file', 'error');
                    }
                }

                function closeModal(modalId) {
                    try {
                        const modal = document.getElementById(modalId);
                        if (modal) {
                            modal.style.display = 'none';
                        }
                    } catch (error) {
                        console.error('Error closing modal:', error);
                    }
                }

                function showNotification(message, type) {
                    try {
                        const notification = document.getElementById('notification');
                        if (notification) {
                            notification.textContent = message;
                            notification.className = `notification notification-${type}`;
                            notification.style.display = 'block';
                            
                            setTimeout(() => {
                                notification.style.display = 'none';
                            }, 3000);
                        }
                    } catch (error) {
                        console.error('Error showing notification:', error);
                    }
                }

                function downloadTemplate() {
                    try {
                        // Create workbook with template data
                        const wb = XLSX.utils.book_new();
                        const wsData = [
                            ['Name', 'Email', 'Phone', 'Status'],
                            // Empty row for example format
                            ['', '', '', 'Registered']
                        ];
                        const ws = XLSX.utils.aoa_to_sheet(wsData);
                        
                        // Add worksheet to workbook
                        XLSX.utils.book_append_sheet(wb, ws, 'Students');
                        
                        // Save the file
                        XLSX.writeFile(wb, 'student_template.xlsx');
                        showNotification('Template downloaded successfully', 'success');
                    } catch (error) {
                        console.error('Error downloading template:', error);
                        showNotification('Error downloading template', 'error');
                    }
                }

                function toggleSelectAll() {
                    try {
                        const selectAll = document.getElementById('selectAll');
                        const checkboxes = document.querySelectorAll('.student-select');
                        checkboxes.forEach(checkbox => {
                            checkbox.checked = selectAll.checked;
                        });
                    } catch (error) {
                        console.error('Error toggling selection:', error);
                    }
                }

                function exportData() {
                    try {
                        const format = document.getElementById('exportFormat').value;
                        const selectedStudents = Array.from(document.querySelectorAll('.student-select:checked'))
                            .map(checkbox => currentStudents[checkbox.dataset.index]);
                        
                        if (selectedStudents.length === 0) {
                            showNotification('Please select students to export', 'error');
                            return;
                        }
                        
                        switch(format) {
                            case 'csv':
                                exportToCSV(selectedStudents);
                                break;
                            case 'excel':
                            case 'pdf':
                                showNotification(`${format.toUpperCase()} export not implemented yet`, 'error');
                                break;
                        }
                    } catch (error) {
                        console.error('Error exporting data:', error);
                        showNotification('Error exporting data', 'error');
                    }
                }

                function exportToCSV(students) {
                    try {
                        const headers = ['Name', 'Email', 'Phone', 'Status'];
                        const rows = students.map(student => 
                            [student.name, student.email, student.phone, student.status]
                        );
                        
                        const csvContent = [headers, ...rows]
                            .map(row => row.join(','))
                            .join('\n');
                        
                        const blob = new Blob([csvContent], { type: 'text/csv' });
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'students.csv';
                        a.click();
                        window.URL.revokeObjectURL(url);
                    } catch (error) {
                        console.error('Error exporting to CSV:', error);
                        showNotification('Error exporting to CSV', 'error');
                    }
                }

                function updateArchivedCoursesList() {
                    try {
                        const organization = JSON.parse(localStorage.getItem('currentOrganization'));
                        if (!organization) return;

                        const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                        const tableBody = document.getElementById('archivedCoursesTableBody');
                        
                        if (!tableBody) return;

                        // Filter archived courses for this organization
                        const archivedCourses = courses.filter(course => 
                            course.organizationId === organization.id && 
                            course.isArchived === true
                        );

                        // Sort by archived date (most recent first)
                        archivedCourses.sort((a, b) => new Date(b.archivedDate) - new Date(a.archivedDate));

                        // Update archived courses table
                        tableBody.innerHTML = archivedCourses.length ? 
                            archivedCourses.map(course => `
                                <tr>
                                    <td>${formatDate(course.courseDate)}</td>
                                    <td>${course.location}</td>
                                    <td>${course.classType}</td>
                                    <td>${course.studentsRegistered || 0}</td>
                                    <td><span class="status status-archived">Archived</span></td>
                                    <td>${course.displayInstructorName ? course.instructorName : 'Not Assigned'}</td>
                                    <td class="note-cell" data-full-note="${course.notes || '-'}">${course.notes || '-'}</td>
                                    <td>
                                        <button class="btn btn-primary" onclick="viewStudentList('${course.id}')">View Students</button>
                                        <button class="btn btn-secondary" onclick="unarchiveCourse('${course.id}')">Unarchive</button>
                                    </td>
                                </tr>
                            `).join('') :
                            '<tr><td colspan="8" style="text-align: center;">No archived courses found</td></tr>';
                    } catch (error) {
                        console.error('Error updating archived courses list:', error);
                        showNotification('Error updating archived courses list', 'error');
                    }
                }

                function unarchiveCourse(courseId) {
                    try {
                        const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                        const courseIndex = courses.findIndex(c => c.id === courseId);

                        if (courseIndex === -1) {
                            showNotification('Course not found', 'error');
                            return;
                        }

                        // Remove archive status
                        courses[courseIndex].isArchived = false;
                        delete courses[courseIndex].archivedDate;
                        delete courses[courseIndex].autoArchiveDate;

                        localStorage.setItem('courses', JSON.stringify(courses));
                        updateArchivedCoursesList();
                        updateMyCoursesTable();
                        showNotification('Course unarchived successfully', 'success');
                    } catch (error) {
                        console.error('Error unarchiving course:', error);
                        showNotification('Error unarchiving course', 'error');
                    }
                }

                function deleteCourse(courseId) {
                    if (!confirm('Are you sure you want to delete this course? This action cannot be undone.')) {
                        return;
                    }

                    try {
                        const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                        const courseIndex = courses.findIndex(c => c.id === courseId);

                        if (courseIndex === -1) {
                            showNotification('Course not found', 'error');
                            return;
                        }

                        // Remove the course
                        courses.splice(courseIndex, 1);
                        localStorage.setItem('courses', JSON.stringify(courses));

                        // Update the display
                        updateMyCoursesTable();
                        showNotification('Course deleted successfully', 'success');
                    } catch (error) {
                        console.error('Error deleting course:', error);
                        showNotification('Error deleting course', 'error');
                    }
                }

                // Date handling functions
                function formatDateForStorage(date) {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }

                function formatDateForDisplay(dateString) {
                    if (!dateString) return '-';
                    const [year, month, day] = dateString.split('-');
                    return `${month}/${day}/${year}`;
                }

                function getCurrentDate() {
                    const now = new Date();
                    return formatDateForStorage(now);
                }

                // Update sorting function
                function sortCourses(courses) {
                    return courses.sort((a, b) => {
                        const [yearA, monthA, dayA] = a.courseDate.split('-');
                        const [yearB, monthB, dayB] = b.courseDate.split('-');
                        return new Date(yearA, monthA - 1, dayA).getTime() - new Date(yearB, monthB - 1, dayB).getTime();
                    });
                }

                // Update bulk scheduling
                function handleBulkScheduling() {
                    const startDate = document.getElementById('bulkStartDate').value;
                    const endDate = document.getElementById('bulkEndDate').value;
                    
                    if (!startDate || !endDate) {
                        showNotification('Please select both start and end dates', 'error');
                        return;
                    }

                    // Generate dates in between
                    const dates = [];
                    let [startYear, startMonth, startDay] = startDate.split('-').map(Number);
                    const [endYear, endMonth, endDay] = endDate.split('-').map(Number);
                    
                    let currentDate = new Date(startYear, startMonth - 1, startDay);
                    const lastDate = new Date(endYear, endMonth - 1, endDay);

                    while (currentDate <= lastDate) {
                        dates.push(formatDateForStorage(currentDate));
                        currentDate.setDate(currentDate.getDate() + 1);
                    }

                    // Show preview
                    showBulkSchedulePreview(dates);
                }

                // Update course creation
                function createCourse(courseData) {
                    try {
                        const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                        const newCourse = {
                            ...courseData,
                            id: 'course_' + Date.now(),
                            systemDate: getCurrentDate(),
                            status: 'PENDING',
                            adminConfirmed: false,
                            adminScheduledDashStatus: 'PENDING',
                            adminInstructorDashStatus: 'PENDING',
                            organizationStatus: 'PENDING',
                            instructorStatus: '',
                            studentList: []
                        };
                        
                        courses.push(newCourse);
                        localStorage.setItem('courses', JSON.stringify(courses));
                        return true;
                    } catch (error) {
                        console.error('Error creating course:', error);
                        return false;
                    }
                }

                // Update course completion
                function completeCourse(courseId) {
                    try {
                        const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                        const courseIndex = courses.findIndex(c => c.id === courseId);
                        
                        if (courseIndex === -1) return false;
                        
                        const currentDate = getCurrentDate();
                        courses[courseIndex].completedDate = currentDate;
                        courses[courseIndex].status = 'Complete';
                        
                        // Set auto-archive date to 30 days from completion
                        const archiveDate = new Date();
                        archiveDate.setDate(archiveDate.getDate() + 30);
                        courses[courseIndex].autoArchiveDate = formatDateForStorage(archiveDate);
                        
                        localStorage.setItem('courses', JSON.stringify(courses));
                        return true;
                    } catch (error) {
                        console.error('Error completing course:', error);
                        return false;
                    }
                }

                // Update archive handling
                function checkAutoArchive() {
                    try {
                        const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                        const currentDate = getCurrentDate();
                        let updated = false;

                        courses.forEach(course => {
                            if (course.autoArchiveDate && 
                                course.autoArchiveDate <= currentDate && 
                                !course.isArchived) {
                                course.isArchived = true;
                                course.archivedDate = currentDate;
                                updated = true;
                            }
                        });

                        if (updated) {
                            localStorage.setItem('courses', JSON.stringify(courses));
                            updateMyCoursesTable();
                        }
                    } catch (error) {
                        console.error('Error checking auto-archive:', error);
                    }
                }
            </script>
        </main>
    </div>

    <!-- Modal for uploading student list -->
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('uploadModal')">&times;</span>
            <h2>Upload Student List</h2>
            <form id="uploadForm" onsubmit="handleFileUpload(event)">
                <div class="form-group">
                    <label for="studentListFileModal">Select Excel File:</label>
                    <input type="file" id="studentListFileModal" accept=".xlsx,.xls" required>
                    <small>Accepted formats: .xlsx, .xls</small>
                </div>
                <div class="progress-container" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-bar-fill"></div>
                    </div>
                    <div class="progress-text">Uploading: <span id="progressPercentage">0%</span></div>
                </div>
                <div class="button-group">
                    <button type="submit" class="btn btn-primary">Upload</button>
                    <button type="button" class="btn btn-secondary" onclick="downloadTemplate()">Download Template</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for viewing student list -->
    <div id="studentListModal" class="student-list-modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeStudentListModal()">&times;</span>
            <h3>Student List</h3>
            <div id="studentListContent">
                <table class="student-list-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Status</th>
                            ${course.adminConfirmed ? '<th>Attendance</th>' : ''}
                        </tr>
                    </thead>
                    <tbody id="studentListTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</body>
</html>