<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GTA CPR - Course Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --background-color: #ecf0f1;
            --text-color: #2c3e50;
            --border-color: #bdc3c7;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .main-header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .main-nav {
            display: flex;
            gap: 1rem;
        }

        .main-nav a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .main-nav a:hover {
            background-color: var(--secondary-color);
        }

        .main-nav a.active {
            background-color: var(--secondary-color);
        }

        .dashboard {
            padding: 1rem;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .dashboard-title {
            margin-bottom: 1rem;
            color: var(--primary-color);
            font-size: 1.5rem;
        }

        .filter-section {
            background-color: white;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-group label {
            color: var(--text-color);
            font-weight: bold;
        }

        .filter-group select {
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-color);
        }

        .btn {
            background-color: var(--secondary-color);
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .btn:hover {
            background-color: #2980b9;
        }

        .btn-reset {
            background-color: var(--accent-color);
        }

        .btn-reset:hover {
            background-color: #c0392b;
        }

        .btn-assign {
            background-color: var(--secondary-color);
        }

        .btn-confirm {
            background-color: #27ae60;
        }

        .btn-confirm:hover {
            background-color: #219a52;
        }

        .btn-bill {
            background-color: #f39c12;
        }

        .btn-bill:hover {
            background-color: #d68910;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            table-layout: fixed;
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        th {
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        /* Add specific column widths */
        th:nth-child(1), td:nth-child(1) { width: 15%; } /* Name */
        th:nth-child(2), td:nth-child(2) { width: 10%; } /* Status */
        th:nth-child(3), td:nth-child(3) { width: 12%; } /* Date */
        th:nth-child(4), td:nth-child(4) { width: 18%; } /* Organization */
        th:nth-child(5), td:nth-child(5) { width: 15%; } /* Location */
        th:nth-child(6), td:nth-child(6) { width: 12%; } /* Class Type */
        th:nth-child(7), td:nth-child(7) { width: 10%; } /* Students Registered */
        th:nth-child(8), td:nth-child(8) { width: 8%; } /* Actions */

        thead {
            width: 100%;
            display: table;
            table-layout: fixed;
        }

        tbody {
            width: 100%;
            display: table;
            table-layout: fixed;
        }

        tr {
            width: 100%;
            display: table-row;
        }

        .table-container {
            width: 100%;
            overflow-x: auto;
            margin-bottom: 2rem;
        }

        th.sortable:hover {
            background-color: #34495e;
        }

        th.asc::after {
            content: ' ↑';
        }

        th.desc::after {
            content: ' ↓';
        }

        tr:hover {
            background-color: var(--background-color);
        }

        .instructor-row {
            background-color: #f8f9fa;
            font-weight: bold;
        }

        .date-status-row {
            background-color: white;
        }

        .nested-row td:first-child {
            padding-left: 30px;
        }

        .status-available {
            background-color: #2ecc71;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .status-scheduled {
            background-color: #f39c12;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .status-confirmed {
            background-color: #3498db;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .status-complete {
            background-color: #28a745;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .notes-cell {
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        section {
            margin-bottom: 2rem;
        }

        section h2 {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        @media (max-width: 768px) {
            .dashboard {
                padding: 1rem;
            }

            .filter-section {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-group {
                flex-direction: column;
                align-items: stretch;
            }

            table {
                font-size: 0.9rem;
            }

            .btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 5px;
            width: 80%;
            max-width: 500px;
        }

        .modal-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            border-radius: 4px;
            color: white;
            display: none;
            z-index: 1001;
        }

        .notification-success {
            background-color: #2ecc71;
        }

        .notification-error {
            background-color: #e74c3c;
        }

        .btn-secondary {
            background-color: #95a5a6;
        }

        .btn-secondary:hover {
            background-color: #7f8c8d;
        }

        .btn-danger {
            background-color: #e74c3c;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        #resetDataModal ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        #resetDataModal p {
            margin: 10px 0;
        }

        .table-responsive td:last-child {
            text-align: center;
            white-space: nowrap;
        }

        .table-responsive .btn {
            display: inline-block;
            margin: 0;
            min-width: 80px;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-success {
            background-color: #2ecc71;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-success:hover {
            background-color: #27ae60;
        }

        /* Update column widths for scheduled courses table */
        .table-responsive table {
            table-layout: fixed;
            width: 100%;
        }

        .table-responsive table th,
        .table-responsive table td {
            padding: 0.75rem;
            text-align: left;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Specific column widths for scheduled courses table */
        .table-responsive table th:nth-child(1), 
        .table-responsive table td:nth-child(1) { width: 12%; }  /* Course Date */
        
        .table-responsive table th:nth-child(2), 
        .table-responsive table td:nth-child(2) { width: 15%; }  /* Organization */
        
        .table-responsive table th:nth-child(3), 
        .table-responsive table td:nth-child(3) { width: 10%; }  /* Location */
        
        .table-responsive table th:nth-child(4), 
        .table-responsive table td:nth-child(4) { width: 10%; }  /* Class Type */
        
        .table-responsive table th:nth-child(5), 
        .table-responsive table td:nth-child(5) { width: 10%; }  /* Students Registered */
        
        .table-responsive table th:nth-child(6), 
        .table-responsive table td:nth-child(6) { width: 15%; }  /* Status */
        
        .table-responsive table th:nth-child(7), 
        .table-responsive table td:nth-child(7) { width: 15%; }  /* Instructor */
        
        .table-responsive table th:nth-child(8), 
        .table-responsive table td:nth-child(8) { width: 13%; }  /* Actions */

        /* Ensure the table header and cells align properly */
        .table-responsive thead {
            background-color: var(--primary-color);
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .table-responsive th {
            font-weight: bold;
            color: white;
            background-color: var(--primary-color);
        }

        /* Ensure consistent padding and text alignment */
        .table-responsive td {
            vertical-align: middle;
        }

        /* Make sure the action buttons stay in their column */
        .table-responsive td:last-child {
            text-align: center;
            white-space: nowrap;
            overflow: visible;
        }

        .table-responsive .btn {
            margin: 2px;
            padding: 0.4rem 0.8rem;
            font-size: 0.9rem;
        }

        /* Add these styles to your existing CSS */
        .section {
            display: none;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .section.active {
            display: block;
        }

        .left-nav {
            display: flex;
            flex-direction: row;
            gap: 10px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .left-nav button {
            padding: 8px 15px;
            border: none;
            background: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            transition: background-color 0.3s;
            min-width: 120px;
            white-space: nowrap;
        }

        .left-nav button:hover {
            background: #e9ecef;
        }

        .left-nav button.active {
            background: var(--secondary-color);
            color: white;
        }

        .left-nav button.btn-danger {
            background: var(--accent-color);
            color: white;
        }

        .left-nav button.btn-danger:hover {
            background: #c0392b;
        }

        .main-content {
            flex: 1;
            padding: 20px;
        }

        .dashboard {
            display: flex;
            gap: 20px;
        }

        /* Add these styles to your existing CSS */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 5px;
            margin-top: 5px;
        }

        .stat-card {
            background: white;
            padding: 5px;
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card h3 {
            color: var(--primary-color);
            margin-bottom: 2px;
            font-size: 0.8rem;
        }

        .stat-card p {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--secondary-color);
            margin: 0;
        }

        /* Add these styles to your existing CSS */
        .banner-box {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .banner-box h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .banner-box .nav-links {
            display: flex;
            gap: 1rem;
        }

        .banner-box .nav-links a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .banner-box .nav-links a:hover {
            background-color: var(--secondary-color);
        }

        .banner-box .nav-links a.active {
            background-color: var(--secondary-color);
        }

        /* Update table styles for proper alignment */
        .table-responsive {
            overflow-x: auto;
            margin-bottom: 1rem;
        }

        .table-responsive table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        .table-responsive th,
        .table-responsive td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Specific column widths for scheduled courses table */
        .table-responsive table th:nth-child(1), 
        .table-responsive table td:nth-child(1) { width: 12%; }  /* Course Date */
        
        .table-responsive table th:nth-child(2), 
        .table-responsive table td:nth-child(2) { width: 15%; }  /* Organization */
        
        .table-responsive table th:nth-child(3), 
        .table-responsive table td:nth-child(3) { width: 10%; }  /* Location */
        
        .table-responsive table th:nth-child(4), 
        .table-responsive table td:nth-child(4) { width: 10%; }  /* Class Type */
        
        .table-responsive table th:nth-child(5), 
        .table-responsive table td:nth-child(5) { width: 10%; }  /* Students Registered */
        
        .table-responsive table th:nth-child(6), 
        .table-responsive table td:nth-child(6) { width: 15%; }  /* Status */
        
        .table-responsive table th:nth-child(7), 
        .table-responsive table td:nth-child(7) { width: 15%; }  /* Instructor */
        
        .table-responsive table th:nth-child(8), 
        .table-responsive table td:nth-child(8) { width: 13%; }  /* Actions */

        /* Ensure header stays fixed */
        .table-responsive thead {
            position: sticky;
            top: 0;
            z-index: 1;
            background-color: var(--primary-color);
        }

        /* Ensure content cells are properly aligned */
        .table-responsive tbody td {
            vertical-align: middle;
            background-color: white;
        }

        /* Status styling */
        .status-scheduled {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
            background-color: #f39c12;
            color: white;
        }

        /* Action buttons alignment */
        .table-responsive td:last-child {
            text-align: center;
            white-space: nowrap;
            overflow: visible;
        }

        .table-responsive .btn {
            margin: 2px;
            padding: 0.4rem 0.8rem;
            font-size: 0.9rem;
        }

        .section-buttons {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .section-buttons button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            background-color: var(--secondary-color);
            color: white;
        }

        .section-buttons button:hover {
            background-color: #2980b9;
        }

        .section-buttons button.active {
            background-color: var(--primary-color);
        }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="logo">GTA CPR</div>
        <nav class="main-nav">
            <a href="Index.html">Home</a>
            <a href="instructor-portal.html">Instructors</a>
            <a href="organization-portal.html">Organizations</a>
            <a href="admin-portal.html">Admin</a>
            <a href="support-portal.html">Support</a>
        </nav>
    </header>

    <div class="dashboard">
        <h1 class="dashboard-title">Admin Dashboard</h1>
        <div class="section-buttons">
            <button onclick="showSection('scheduledCourses')" class="btn btn-primary">Scheduled Courses</button>
            <button onclick="showSection('confirmedCourses')" class="btn btn-primary">Confirmed Courses</button>
            <button onclick="showSection('instructorDashboard')" class="btn btn-primary">Instructor Dashboard</button>
            <button onclick="showSection('courseTypes')" class="btn btn-primary">Course Types</button>
            <button onclick="showSection('completedCourses')" class="btn btn-primary">Completed Courses</button>
        </div>

        <nav class="left-nav">
            <button onclick="showSection('dashboard')">Dashboard</button>
            <button onclick="showSection('scheduledCourses')">Scheduled Courses</button>
            <button onclick="showSection('confirmedCourses')">Confirmed Courses</button>
            <button onclick="showSection('completedCourses')">Completed Courses</button>
            <button onclick="showSection('instructors')">Instructors</button>
            <button onclick="showSection('organizations')">Organizations</button>
            <button onclick="showSection('userManagement')">User Management</button>
            <button onclick="showSection('courseTypes')">Course Types</button>
            <button onclick="showSection('analytics')">Analytics</button>
            <button class="btn-danger" onclick="showResetDataConfirmation()">Reset All Data</button>
            <button onclick="handleLogout()">Logout</button>
        </nav>

        <main class="main-content">
            <!-- Dashboard Section -->
            <section id="dashboard" class="section">
                <div style="display: flex; gap: 10px;">
                    <!-- Left side - Stats -->
                    <div style="flex: 2;">
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <!-- Current Week Stats -->
                            <div style="flex: 1; background: white; padding: 10px; border-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                                <h3 style="color: var(--primary-color); margin: 0 0 5px 0; font-size: 0.8rem;">Current Week</h3>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px;">
                                    <div style="text-align: center; padding: 3px;">
                                        <div style="font-size: 0.7rem; color: #666;">Scheduled</div>
                                        <div style="font-size: 1rem; font-weight: bold; color: var(--secondary-color);" id="currentWeekScheduledCount">0</div>
                                    </div>
                                    <div style="text-align: center; padding: 3px;">
                                        <div style="font-size: 0.7rem; color: #666;">Confirmed</div>
                                        <div style="font-size: 1rem; font-weight: bold; color: var(--secondary-color);" id="currentWeekConfirmedCount">0</div>
                                    </div>
                                    <div style="text-align: center; padding: 3px;">
                                        <div style="font-size: 0.7rem; color: #666;">Instructors</div>
                                        <div style="font-size: 1rem; font-weight: bold; color: var(--secondary-color);" id="currentWeekInstructorCount">0</div>
                                    </div>
                                    <div style="text-align: center; padding: 3px;">
                                        <div style="font-size: 0.7rem; color: #666;">Organizations</div>
                                        <div style="font-size: 1rem; font-weight: bold; color: var(--secondary-color);" id="currentWeekOrganizationCount">0</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Next Week Stats -->
                            <div style="flex: 1; background: white; padding: 10px; border-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                                <h3 style="color: var(--primary-color); margin: 0 0 5px 0; font-size: 0.8rem;">Next Week</h3>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px;">
                                    <div style="text-align: center; padding: 3px;">
                                        <div style="font-size: 0.7rem; color: #666;">Scheduled</div>
                                        <div style="font-size: 1rem; font-weight: bold; color: var(--secondary-color);" id="nextWeekScheduledCount">0</div>
                                    </div>
                                    <div style="text-align: center; padding: 3px;">
                                        <div style="font-size: 0.7rem; color: #666;">Confirmed</div>
                                        <div style="font-size: 1rem; font-weight: bold; color: var(--secondary-color);" id="nextWeekConfirmedCount">0</div>
                                    </div>
                                    <div style="text-align: center; padding: 3px;">
                                        <div style="font-size: 0.7rem; color: #666;">Instructors</div>
                                        <div style="font-size: 1rem; font-weight: bold; color: var(--secondary-color);" id="nextWeekInstructorCount">0</div>
                                    </div>
                                    <div style="text-align: center; padding: 3px;">
                                        <div style="font-size: 0.7rem; color: #666;">Organizations</div>
                                        <div style="font-size: 1rem; font-weight: bold; color: var(--secondary-color);" id="nextWeekOrganizationCount">0</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right side - Monthly Instructor Summary -->
                    <div style="flex: 1; background: var(--primary-color); padding: 10px; border-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                        <h3 style="color: white; margin: 0 0 5px 0; font-size: 0.8rem;">Monthly Summary</h3>
                        <div style="max-height: 100px; overflow-y: auto; background: rgba(255,255,255,0.1); border-radius: 4px; padding: 5px;">
                            <table style="width: 100%; font-size: 0.8rem; border-collapse: collapse; background: transparent;">
                                <thead>
                                    <tr>
                                        <th style="text-align: left; padding: 5px; color: white; border-bottom: 1px solid rgba(255,255,255,0.2);">Instructor</th>
                                        <th style="text-align: center; padding: 5px; color: white; border-bottom: 1px solid rgba(255,255,255,0.2);">Total</th>
                                    </tr>
                                </thead>
                                <tbody id="monthlyConfirmedCoursesTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Add User Management Section -->
            <section id="userManagement" class="section">
                <h2>User Management</h2>
                <div class="table-container">
                    <div class="table-header">
                        <h3>System Users</h3>
                        <button class="btn btn-primary" onclick="showAddUserModal()">Add New User</button>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Last Login</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="userManagementTableBody"></tbody>
                    </table>
                </div>
            </section>

            <!-- Add User Modal -->
            <div id="addUserModal" class="modal">
                <div class="modal-content">
                    <h2>Add New User</h2>
                    <form onsubmit="handleAddUser(event)">
                        <div class="form-group">
                            <label for="newUsername">Username:</label>
                            <input type="text" id="newUsername" required>
                        </div>
                        <div class="form-group">
                            <label for="newPassword">Password:</label>
                            <input type="password" id="newPassword" required>
                        </div>
                        <div class="form-group">
                            <label for="userRole">Role:</label>
                            <select id="userRole" required>
                                <option value="">Select Role</option>
                                <option value="admin">Admin</option>
                                <option value="instructor">Instructor</option>
                                <option value="organization">Organization</option>
                                <option value="accounting">Accounting</option>
                            </select>
                        </div>
                        <div class="modal-buttons">
                            <button type="submit" class="btn btn-primary">Add User</button>
                            <button type="button" class="btn btn-secondary" onclick="closeModal('addUserModal')">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Instructor Dashboard -->
            <section id="instructorDashboard">
                <h2>Instructor Dashboard</h2>
                <div class="filters-section">
                    <div class="form-group">
                        <label for="dateFilter">Date:</label>
                        <input type="date" id="dateFilter">
                    </div>
                    <div class="form-group">
                        <label for="instructorFilter">Instructor:</label>
                        <select id="instructorFilter">
                            <option value="">All Instructors</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="organizationFilter">Organization:</label>
                        <select id="organizationFilter">
                            <option value="">All Organizations</option>
                        </select>
                    </div>
                    <!-- Add Quick Status Filter -->
                    <div class="form-group">
                        <label for="quickStatusFilter">Status:</label>
                        <select id="quickStatusFilter" onchange="filterTables()">
                            <option value="">All Statuses</option>
                            <option value="Available">Available</option>
                            <option value="Scheduled">Scheduled</option>
                            <option value="Confirmed">Confirmed</option>
                        </select>
                    </div>
                    <!-- Add Search Bar -->
                    <div class="form-group">
                        <label for="searchInput">Search:</label>
                        <input type="text" id="searchInput" placeholder="Search instructors, organizations..." oninput="filterTables()">
                    </div>
                    <!-- Add Bulk Actions -->
                    <div class="form-group">
                        <button class="btn btn-primary" onclick="confirmSelectedCourses()">Confirm Selected</button>
                    </div>
                </div>
                <div class="filter-section">
                    <div class="filter-group">
                        <label for="statusFilter">Status:</label>
                        <select id="statusFilter">
                            <option value="">All</option>
                            <option value="Available">Available</option>
                            <option value="Scheduled">Scheduled</option>
                            <option value="Confirmed">Confirmed</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <button class="btn btn-reset" onclick="resetFilters()">Reset Filters</button>
                        <button class="btn btn-danger" onclick="showResetDataConfirmation()">Reset All Data</button>
                    </div>
                </div>
                <div class="table-container">
                    <table id="instructorTable">
                        <thead>
                            <tr>
                                <th onclick="sortTable('instructorTable', 0)">Name</th>
                                <th onclick="sortTable('instructorTable', 1)">Status</th>
                                <th onclick="sortTable('instructorTable', 2)">Date</th>
                                <th onclick="sortTable('instructorTable', 3)">Organization</th>
                                <th onclick="sortTable('instructorTable', 4)">Location</th>
                                <th onclick="sortTable('instructorTable', 5)">Class Type</th>
                                <th onclick="sortTable('instructorTable', 6)">Students Registered</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="instructorTableBody"></tbody>
                    </table>
                </div>
            </section>

            <!-- Scheduled Courses -->
            <section id="scheduledCourses" class="section">
                <h2>Scheduled Courses</h2>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Course Date</th>
                                <th>Organization</th>
                                <th>Location</th>
                                <th>Class Type</th>
                                <th>Students</th>
                                <th>Status</th>
                                <th>Instructor</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="scheduledCoursesTableBody"></tbody>
                    </table>
                </div>
            </section>

            <!-- Confirmed Courses -->
            <section id="confirmedCourses" class="section">
                <h2>Confirmed Courses</h2>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Course Date</th>
                                <th>Organization</th>
                                <th>Location</th>
                                <th>Class Type</th>
                                <th>Students Registered</th>
                                <th>Status</th>
                                <th>Instructor</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="confirmedCoursesTableBody"></tbody>
                    </table>
                </div>
            </section>

            <!-- Completed Courses -->
            <section id="completedCourses" class="section">
                <h2>Completed Courses</h2>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Course Date</th>
                                <th>Organization</th>
                                <th>Location</th>
                                <th>Class Type</th>
                                <th>Students Registered</th>
                                <th>Students Attended</th>
                                <th>Status</th>
                                <th>Billing Status</th>
                                <th>Instructor</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="completedCoursesTableBody"></tbody>
                    </table>
                </div>
            </section>

            <!-- Notification Element -->
            <div id="notification" class="notification"></div>

            <!-- Assign Instructor Modal -->
            <div id="assignInstructorModal" class="modal">
                <div class="modal-content">
                    <span class="close-modal" onclick="closeModal('assignInstructorModal')">&times;</span>
                    <h3>Assign Instructor</h3>
                    <div class="form-group">
                        <label for="instructorSelect">Select Instructor:</label>
                        <select id="instructorSelect" required>
                            <option value="">Choose an instructor...</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="assignInstructor()">Assign</button>
                </div>
            </div>

            <!-- Add Reset Data Confirmation Modal -->
            <div id="resetDataModal" class="modal">
                <div class="modal-content">
                    <h2>Reset All Data</h2>
                    <p>Warning: This will permanently delete all data including:</p>
                    <ul>
                        <li>All instructors and their availability</li>
                        <li>All organizations</li>
                        <li>All courses and schedules</li>
                        <li>All student lists</li>
                    </ul>
                    <p>This action cannot be undone. Are you sure you want to continue?</p>
                    <div class="modal-buttons">
                        <button class="btn btn-danger" onclick="resetAllData()">Yes, Reset All Data</button>
                        <button class="btn btn-secondary" onclick="closeModal('resetDataModal')">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Student List Modal -->
            <div id="studentListModal" class="modal">
                <div class="modal-content">
                    <span class="close-modal" onclick="closeStudentListModal()">&times;</span>
                    <h3>Student List</h3>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Status</th>
                                    <th>Attendance</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody id="studentListTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <section id="courseTypes" class="section">
                <h2>Course Type Management</h2>
                <div class="section-content">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Course Type</th>
                                    <th>Description</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="courseTypesTableBody"></tbody>
                        </table>
                    </div>
                    <button class="btn btn-primary" onclick="showAddCourseTypeModal()">Add Course Type</button>
                </div>
            </section>

            <!-- Add Course Type Modal -->
            <div id="courseTypeModal" class="modal">
                <div class="modal-content">
                    <span class="close-modal" onclick="closeModal('courseTypeModal')">&times;</span>
                    <h3 id="courseTypeModalTitle">Add Course Type</h3>
                    <form id="courseTypeForm" onsubmit="saveCourseType(event)">
                        <div class="form-group">
                            <label for="courseTypeName">Course Type Name:</label>
                            <input type="text" id="courseTypeName" required>
                        </div>
                        <div class="form-group">
                            <label for="courseTypeDescription">Description:</label>
                            <textarea id="courseTypeDescription" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="courseTypeStatus">Status:</label>
                            <select id="courseTypeStatus" required>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                        <input type="hidden" id="courseTypeId">
                        <button type="submit" class="btn btn-primary">Save</button>
                    </form>
                </div>
            </div>

            <!-- Add Student Management Section -->
            <div id="studentManagementSection" class="section" style="display: none;">
                <h2>Student Management</h2>
                <div class="search-filters">
                    <input type="text" id="studentSearch" placeholder="Search students..." onkeyup="updateStudentTable()">
                </div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Registration Date</th>
                            <th>Courses</th>
                            <th>Certificates</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="studentTableBody"></tbody>
                </table>
            </div>
        </main>
    </div>

    <script>
        // Standardized course types configuration
        const COURSE_TYPES = {
            'BLS': 'Basic Life Support',
            'ACLS': 'Advanced Cardiac Life Support',
            'PALS': 'Pediatric Advanced Life Support',
            'CPR': 'Cardiopulmonary Resuscitation',
            'First Aid': 'First Aid',
            'AED': 'Automated External Defibrillator'
        };

        // Function to get course type options HTML
        function getCourseTypeOptions() {
            return Object.entries(COURSE_TYPES)
                .map(([value, label]) => `<option value="${value}">${value} - ${label}</option>`)
                .join('');
        }

        // Function to get course type label
        function getCourseTypeLabel(value) {
            return COURSE_TYPES[value] || value;
        }

        // Initialize data if not exists
        function initializeData() {
            // Initialize instructors if not exists
            if (!localStorage.getItem('instructors')) {
                localStorage.setItem('instructors', JSON.stringify([]));
            }

            // Initialize organizations if not exists
            if (!localStorage.getItem('organizations')) {
                localStorage.setItem('organizations', JSON.stringify([]));
            }

            // Initialize courses if not exists
            if (!localStorage.getItem('courses')) {
                localStorage.setItem('courses', JSON.stringify([]));
            } else {
                // Fix any existing courses that might have inconsistent status
                const courses = JSON.parse(localStorage.getItem('courses'));
                const updatedCourses = courses.map(course => {
                    if (course.status === 'CONFIRMED') {
                        course.adminConfirmed = true;
                        course.adminScheduledDashStatus = 'CONFIRMED';
                        course.adminInstructorDashStatus = 'CONFIRMED';
                        course.organizationStatus = 'CONFIRMED';
                        course.instructorStatus = 'CONFIRMED';
                    } else {
                        course.adminConfirmed = false;
                    }
                    return course;
                });
                localStorage.setItem('courses', JSON.stringify(updatedCourses));
            }
        }

        // Add this function after initializeData()
        function fixCourseData() {
            try {
                const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                let needsUpdate = false;

                courses.forEach(course => {
                    // If a course is completed but not confirmed, mark it as confirmed
                    if (course.completionStatus === 'COMPLETED' && !course.adminConfirmed) {
                        course.adminConfirmed = true;
                        course.status = 'CONFIRMED';
                        course.adminScheduledDashStatus = 'CONFIRMED';
                        course.adminInstructorDashStatus = 'CONFIRMED';
                        course.organizationStatus = 'CONFIRMED';
                        course.instructorStatus = 'CONFIRMED';
                        needsUpdate = true;
                    }
                });

                if (needsUpdate) {
                    localStorage.setItem('courses', JSON.stringify(courses));
                    console.log('Course data fixed and updated');
                }
            } catch (error) {
                console.error('Error fixing course data:', error);
            }
        }

        // Update the DOMContentLoaded event listener to call fixCourseData
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded');
            
            console.log('Initializing data...');
            initializeData();
            
            console.log('Fixing course data...');
            fixCourseData();
            
            console.log('Initializing filters...');
            initializeFilters();
            
            // Load and display data
            const instructors = JSON.parse(localStorage.getItem('instructors') || '[]');
            console.log('Loaded instructors:', instructors);
            
            const organizations = JSON.parse(localStorage.getItem('organizations') || '[]');
            console.log('Loaded organizations:', organizations);
            
            const courses = JSON.parse(localStorage.getItem('courses') || '[]');
            console.log('Loaded courses:', courses);
            
            console.log('Initializing course types...');
            initializeCourseTypes();
            
            console.log('Updating tables and stats...');
            // Update all displays once at initialization
            updateScheduledCoursesList();
            updateConfirmedCoursesList();
            updateCompletedCoursesList();
            updateInstructorDashboard();
            updateMonthlyConfirmedCourses();
            
            console.log('Setting up section display...');
            setupSectionDisplay();
        });

        function setupSectionDisplay() {
            // Get all section buttons
            const sectionButtons = document.querySelectorAll('[data-section]');
            const sections = document.querySelectorAll('section');

            // Add click event listeners to buttons
            sectionButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const sectionToShow = button.getAttribute('data-section');
                    
                    // Hide all sections
                    sections.forEach(section => {
                        section.style.display = 'none';
                    });
                    
                    // Show selected section
                    const selectedSection = document.getElementById(sectionToShow);
                    if (selectedSection) {
                        selectedSection.style.display = 'block';
                    }
                    
                    // Update active button state
                    sectionButtons.forEach(btn => {
                        btn.classList.remove('active');
                    });
                    button.classList.add('active');
                });
            });

            // Show default section
            const defaultSection = document.querySelector('section');
            if (defaultSection) {
                defaultSection.style.display = 'block';
            }
        }

        function initializeFilters() {
            try {
                // Load instructors
                const instructors = JSON.parse(localStorage.getItem('instructors')) || [];
                console.log('Loaded instructors:', instructors);
                
                // Load organizations
                const organizations = JSON.parse(localStorage.getItem('organizations')) || [];
                console.log('Loaded organizations:', organizations);
                
                // Load courses
                const courses = JSON.parse(localStorage.getItem('courses')) || [];
                console.log('Loaded courses:', courses);
                
                // Populate instructor filters
                const instructorFilters = [
                    document.getElementById('instructorFilter'),
                    document.getElementById('instructorSelect')
                ];
                
                instructorFilters.forEach(filter => {
                    if (filter) {
                        filter.innerHTML = `
                            <option value="">All Instructors</option>
                            ${instructors.map(instructor => 
                                `<option value="${instructor.id}">${instructor.name}</option>`
                            ).join('')}
                        `;
                    }
                });
                
                // Populate organization filters
                const organizationFilters = [
                    document.getElementById('organizationFilter'),
                    document.getElementById('scheduledOrgFilter')
                ];
                
                organizationFilters.forEach(filter => {
                    if (filter) {
                        filter.innerHTML = `
                            <option value="">All Organizations</option>
                            ${organizations.map(org => 
                                `<option value="${org.id}">${org.name}</option>`
                            ).join('')}
                        `;
                    }
                });

                // Set date filters to blank (no default date)
                const dateFilters = [
                    document.getElementById('dateFilter'),
                    document.getElementById('scheduledDateFilter')
                ];
                
                dateFilters.forEach(filter => {
                    if (filter) {
                        filter.value = ''; // Set to blank instead of today's date
                    }
                });

                // Trigger initial table updates
                updateTables();
            } catch (error) {
                console.error('Error initializing filters:', error);
                safeShowNotification('Error loading filters', 'error');
            }
        }

        function updateTables() {
            updateInstructorTable();
            updateScheduledCourses();
            updateConfirmedCourses();
        }

        function updateInstructorTable() {
            const instructors = JSON.parse(localStorage.getItem('instructors') || '[]');
            const courses = JSON.parse(localStorage.getItem('courses') || '[]');
            const tableBody = document.getElementById('instructorTableBody');
            const selectedDate = document.getElementById('dateFilter').value;
            const selectedInstructor = document.getElementById('instructorFilter').value;
            const selectedOrganization = document.getElementById('organizationFilter').value;

            if (!tableBody) return;

            let rows = [];
            let hasRows = false;

            instructors.forEach(instructor => {
                if (selectedInstructor && instructor.id !== selectedInstructor) return;

                if (instructor.availability && instructor.availability.length > 0) {
                    instructor.availability.forEach(date => {
                        if (selectedDate && date !== selectedDate) return;

                        // Find if there's a course scheduled for this instructor on this date
                        const scheduledCourse = courses.find(course => 
                            course.instructorId === instructor.id && 
                            course.courseDate === date
                        );

                        let status = 'Available';
                        let organization = '-';

                        if (scheduledCourse) {
                            // Only show organization name in admin view
                            organization = scheduledCourse.organizationName;
                            // Use admin dashboard status for instructor table
                            status = scheduledCourse.adminInstructorDashStatus || 'Available';
                        }

                        rows.push(`
                            <tr>
                                <td>${instructor.name}</td>
                                <td><span class="status-${status.toLowerCase()}">${status}</span></td>
                                <td>${formatDate(date)}</td>
                                <td>${organization}</td>
                                <td>${scheduledCourse?.location || '-'}</td>
                                <td>${scheduledCourse?.classType || '-'}</td>
                                <td>${scheduledCourse?.studentsRegistered || 0}</td>
                                <td>
                                    ${status === 'Available' ? 
                                        `<button class="btn btn-primary" onclick="assignInstructor('${instructor.id}', '${date}')">Edit</button>` : 
                                        '-'
                                    }
                                </td>
                            </tr>
                        `);
                        hasRows = true;
                    });
                }
            });

            if (!hasRows) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8">No instructors found for the selected criteria</td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = rows.join('');
        }

        function assignInstructor() {
            try {
                console.log('Starting assignInstructor function');
                const courseId = localStorage.getItem('currentCourseId');
                const selectedInstructor = document.getElementById('instructorSelect').value;
                
                console.log('CourseId:', courseId, 'Selected Instructor:', selectedInstructor);
                
                if (!courseId || !selectedInstructor) {
                    showNotification('Missing course or instructor information', 'error');
                    return;
                }

                const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                const courseIndex = courses.findIndex(c => c.id === courseId);
                
                if (courseIndex === -1) {
                    showNotification('Course not found', 'error');
                    return;
                }

                // Get instructor details
                const instructors = JSON.parse(localStorage.getItem('instructors') || '[]');
                const instructor = instructors.find(i => i.id === selectedInstructor);
                
                if (!instructor) {
                    showNotification('Instructor not found', 'error');
                    return;
                }

                console.log('Current course state:', courses[courseIndex]);

                // Update course with instructor information and status
                courses[courseIndex].instructorId = selectedInstructor;
                courses[courseIndex].instructorName = instructor.name;
                
                // Update statuses for each portal view:
                courses[courseIndex].status = 'PENDING';                    // Organization Portal view (hide instructor details)
                courses[courseIndex].adminScheduledDashStatus = 'SCHEDULED';// Admin Portal Scheduled Courses view
                courses[courseIndex].adminInstructorDashStatus = 'SCHEDULED';// Admin Portal Instructor Dashboard
                courses[courseIndex].organizationStatus = 'PENDING';       // Organization Portal status
                courses[courseIndex].instructorStatus = 'SCHEDULED';       // Instructor Portal status (now SCHEDULED when assigned)
                courses[courseIndex].adminConfirmed = false;              // Not confirmed yet
                courses[courseIndex].displayInstructorDetails = false;    // Hide instructor details in org portal
                courses[courseIndex].displayOrgDetails = false;          // Hide org details in instructor portal until confirmed

                console.log('Updated course state:', courses[courseIndex]);

                // Save changes
                localStorage.setItem('courses', JSON.stringify(courses));
                
                // Close modal and show success message
                closeModal('assignInstructorModal');
                showNotification('Instructor assigned successfully', 'success');
                
                // Update all relevant displays
                updateScheduledCoursesList();
                updateConfirmedCoursesList();
                updateInstructorDashboard();
            } catch (error) {
                console.error('Error assigning instructor:', error);
                showNotification('Error assigning instructor', 'error');
            }
        }

        function confirmInstructor(instructorId, date) {
            try {
                const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                const course = courses.find(c => 
                    c.courseDate === date && 
                    c.instructorId === instructorId
                );
                
                if (course) {
                    course.status = 'Confirmed';
                    localStorage.setItem('courses', JSON.stringify(courses));
                    
                    updateInstructorTable();
                    updateScheduledCourses(); // Update both tables
                    showNotification('Instructor confirmed successfully', 'success');
                } else {
                    showNotification('No scheduled course found', 'error');
                }
            } catch (error) {
                console.error('Error confirming instructor:', error);
                showNotification('Error confirming instructor', 'error');
            }
        }

        function updateScheduledCourses() {
            try {
                console.log('Starting updateScheduledCourses function');
                const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                console.log('All courses from localStorage:', courses);
                
                const instructors = JSON.parse(localStorage.getItem('instructors') || '[]');
                const tbody = document.getElementById('scheduledCoursesTableBody');
                
                if (!tbody) {
                    console.warn('scheduledCoursesTableBody element not found');
                    return;
                }
                
                // Filter for courses that are pending or scheduled but not confirmed or completed
                const scheduledCourses = courses.filter(course => {
                    console.log('Checking course:', course);
                    console.log('Course status checks:', {
                        notArchived: !course.isArchived,
                        noCompletion: !course.completionStatus,
                        notConfirmed: !course.adminConfirmed,
                        status: course.adminScheduledDashStatus
                    });
                    
                    return !course.isArchived && 
                           !course.completionStatus && 
                           !course.adminConfirmed &&
                           (course.adminScheduledDashStatus === 'PENDING' || 
                            course.adminScheduledDashStatus === 'SCHEDULED');
                });
                
                console.log('Filtered scheduled courses:', scheduledCourses);
                
                tbody.innerHTML = scheduledCourses.length ? 
                    scheduledCourses.map(course => {
                        const hasAvailableInstructors = instructors.some(instructor => 
                            instructor.availability && 
                            instructor.availability.includes(course.courseDate)
                        );
                        
                        const isPending = course.adminScheduledDashStatus === 'PENDING';
                        
                        return `
                            <tr>
                                <td>${formatDate(course.courseDate)}</td>
                                <td>${course.organizationName || '-'}</td>
                                <td>${course.location || '-'}</td>
                                <td>${course.classType || '-'}</td>
                                <td>${course.studentsRegistered || 0}</td>
                                <td>
                                    <span class="status-${course.adminScheduledDashStatus.toLowerCase()}">${course.adminScheduledDashStatus}</span>
                                </td>
                                <td>${course.instructorName || 'Not Assigned'}</td>
                                <td>
                                    ${isPending ? 
                                        (hasAvailableInstructors ? 
                                            `<button class="btn btn-primary" onclick="showAssignInstructorModal('${course.id}')">Assign Instructor</button>` :
                                            `<button class="btn btn-secondary" disabled>No Instructors Available</button>`
                                        ) :
                                        `<button class="btn btn-success" onclick="confirmCourse('${course.id}')">Confirm</button>`
                                    }
                                    <button class="btn btn-info" onclick="viewStudentList('${course.id}')">View Students</button>
                                </td>
                            </tr>
                        `;
                    }).join('') :
                    '<tr><td colspan="8" style="text-align: center;">No scheduled courses</td></tr>';
            } catch (error) {
                console.error('Error updating scheduled courses:', error);
                showNotification('Error updating scheduled courses', 'error');
            }
        }

        function updateConfirmedCourses() {
            try {
                const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                const tbody = document.getElementById('confirmedCoursesTableBody');
                
                if (!tbody) return;
                
                // Filter for confirmed courses
                const confirmedCourses = courses.filter(course => 
                    course.adminConfirmed === true
                );
                
                tbody.innerHTML = confirmedCourses.length ? 
                    confirmedCourses.map(course => {
                        const escapedNotes = (course.notes || '-').replace(/"/g, '&quot;');
                        const status = course.adminConfirmed ? 'CONFIRMED' : 'SCHEDULED';
                        return `
                            <tr>
                                <td>${formatDate(course.courseDate)}</td>
                                <td>${course.organizationName || '-'}</td>
                                <td>${course.location || '-'}</td>
                                <td>${course.classType || '-'}</td>
                                <td>${course.studentsRegistered || 0}</td>
                                <td>
                                    <span class="status-${status.toLowerCase()}">${status}</span>
                                    ${course.instructorName ? `<br><small>${course.instructorName}</small>` : ''}
                                </td>
                                <td>
                                    <button class="btn btn-info" onclick="viewStudentList('${course.id}')">
                                        <i class="fas fa-users"></i> View Students
                                    </button>
                                    <button class="btn btn-primary" onclick="generateBill('${course.id}')">
                                        <i class="fas fa-file-invoice-dollar"></i> BILL
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('') :
                    '<tr><td colspan="7" style="text-align: center;">No confirmed courses found</td></tr>';
            } catch (error) {
                console.error('Error updating confirmed courses:', error);
                showNotification('Error updating confirmed courses', 'error');
            }
        }

        function editCourseType(courseTypeId) {
            try {
                const courseTypes = JSON.parse(localStorage.getItem('courseTypes') || '[]');
                const courseType = courseTypes.find(ct => ct.id === courseTypeId);

                if (courseType) {
                    document.getElementById('courseTypeModalTitle').textContent = 'Edit Course Type';
                    document.getElementById('courseTypeId').value = courseType.id;
                    document.getElementById('courseTypeName').value = courseType.name;
                    document.getElementById('courseTypeDescription').value = courseType.description;
                    document.getElementById('courseTypeStatus').value = courseType.status;
                    document.getElementById('courseTypeModal').style.display = 'block';
                }
            } catch (error) {
                console.error('Error editing course type:', error);
                showNotification('Error editing course type', 'error');
            }
        }

        function deleteCourseType(courseTypeId) {
            if (!confirm('Are you sure you want to delete this course type? This action cannot be undone.')) {
                return;
            }

            try {
                let courseTypes = JSON.parse(localStorage.getItem('courseTypes') || '[]');
                courseTypes = courseTypes.filter(ct => ct.id !== courseTypeId);
                localStorage.setItem('courseTypes', JSON.stringify(courseTypes));
                updateCourseTypesTable();
                showNotification('Course type deleted successfully', 'success');
            } catch (error) {
                console.error('Error deleting course type:', error);
                showNotification('Error deleting course type', 'error');
            }
        }

        // Initialize course types if not exists
        function initializeCourseTypes() {
            try {
                let courseTypes = JSON.parse(localStorage.getItem('courseTypes'));
                if (!courseTypes || courseTypes.length === 0) {
                    courseTypes = [
                        {
                            id: 'ct_1',
                            name: 'BLS',
                            description: 'Basic Life Support',
                            status: 'active'
                        },
                        {
                            id: 'ct_2',
                            name: 'ACLS',
                            description: 'Advanced Cardiac Life Support',
                            status: 'active'
                        },
                        {
                            id: 'ct_3',
                            name: 'PALS',
                            description: 'Pediatric Advanced Life Support',
                            status: 'active'
                        },
                        {
                            id: 'ct_4',
                            name: 'CPR',
                            description: 'Cardiopulmonary Resuscitation',
                            status: 'active'
                        },
                        {
                            id: 'ct_5',
                            name: 'First Aid',
                            description: 'First Aid',
                            status: 'active'
                        },
                        {
                            id: 'ct_6',
                            name: 'AED',
                            description: 'Automated External Defibrillator',
                            status: 'active'
                        }
                    ];
                    localStorage.setItem('courseTypes', JSON.stringify(courseTypes));
                }
            } catch (error) {
                console.error('Error initializing course types:', error);
            }
        }

        // Date handling functions
        function formatDateForStorage(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDateForDisplay(dateString) {
            if (!dateString) return '-';
            const [year, month, day] = dateString.split('-');
            return `${month}/${day}/${year}`;
        }

        function getCurrentDate() {
            const now = new Date();
            return formatDateForStorage(now);
        }

        // Update user creation
        function createUser(userData) {
            try {
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const newUser = {
                    ...userData,
                    id: 'user_' + Date.now(),
                    createdAt: getCurrentDate(),
                    lastLogin: null
                };
                
                users.push(newUser);
                localStorage.setItem('users', JSON.stringify(users));
                return true;
            } catch (error) {
                console.error('Error creating user:', error);
                return false;
            }
        }

        // Update login tracking
        function updateLastLogin(userId) {
            try {
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const userIndex = users.findIndex(u => u.id === userId);
                
                if (userIndex === -1) return false;
                
                users[userIndex].lastLogin = getCurrentDate();
                localStorage.setItem('users', JSON.stringify(users));
                return true;
            } catch (error) {
                console.error('Error updating last login:', error);
                return false;
            }
        }

        // Update course completion display
        function formatCompletionDate(completedDate) {
            if (!completedDate) return 'Not completed';
            return formatDateForDisplay(completedDate);
        }

        // Update showSection function
        function showSection(sectionId) {
            // Hide all sections
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => {
                section.style.display = 'none';
            });

            // Show the selected section
            const selectedSection = document.getElementById(sectionId);
            if (selectedSection) {
                selectedSection.style.display = 'block';
            }

            // Update active state in navigation
            const navButtons = document.querySelectorAll('.left-nav button');
            navButtons.forEach(button => {
                button.classList.remove('active');
                if (button.getAttribute('onclick').includes(sectionId)) {
                    button.classList.add('active');
                }
            });
        }

        function updateDashboardStats() {
            try {
                const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                const instructors = JSON.parse(localStorage.getItem('instructors') || '[]');
                const organizations = JSON.parse(localStorage.getItem('organizations') || '[]');

                // Get current and next week bounds
                const today = new Date();
                const currentWeek = getWeekBounds(today);
                const nextWeek = getWeekBounds(new Date(today.setDate(today.getDate() + 7)));

                // Filter courses for current week
                const currentWeekCourses = courses.filter(course => 
                    course.courseDate >= currentWeek.start && course.courseDate <= currentWeek.end
                );

                // Filter courses for next week
                const nextWeekCourses = courses.filter(course => 
                    course.courseDate >= nextWeek.start && course.courseDate <= nextWeek.end
                );

                // Filter instructors for current week
                const currentWeekInstructors = instructors.filter(instructor => 
                    instructor.availability?.some(date => 
                        date >= currentWeek.start && date <= currentWeek.end
                    )
                );

                // Filter instructors for next week
                const nextWeekInstructors = instructors.filter(instructor => 
                    instructor.availability?.some(date => 
                        date >= nextWeek.start && date <= nextWeek.end
                    )
                );

                // Update current week stats
                document.getElementById('currentWeekScheduledCount').textContent = 
                    currentWeekCourses.filter(course => course.adminScheduledDashStatus === 'Scheduled').length;
                
                document.getElementById('currentWeekConfirmedCount').textContent = 
                    currentWeekCourses.filter(course => course.adminScheduledDashStatus === 'Confirmed').length;
                
                document.getElementById('currentWeekInstructorCount').textContent = currentWeekInstructors.length;
                document.getElementById('currentWeekOrganizationCount').textContent = 
                    [...new Set(currentWeekCourses.map(course => course.organizationId))].length;

                // Update next week stats
                document.getElementById('nextWeekScheduledCount').textContent = 
                    nextWeekCourses.filter(course => course.adminScheduledDashStatus === 'Scheduled').length;
                
                document.getElementById('nextWeekConfirmedCount').textContent = 
                    nextWeekCourses.filter(course => course.adminScheduledDashStatus === 'Confirmed').length;
                
                document.getElementById('nextWeekInstructorCount').textContent = nextWeekInstructors.length;
                document.getElementById('nextWeekOrganizationCount').textContent = 
                    [...new Set(nextWeekCourses.map(course => course.organizationId))].length;

            } catch (error) {
                console.error('Error updating dashboard stats:', error);
            }
        }

        // Date formatting function
        function formatDate(dateString) {
            if (!dateString) return '-';
            const [year, month, day] = dateString.split('-');
            return `${month}/${day}/${year}`;
        }

        // Safe notification function
        function safeShowNotification(message, type = 'info') {
            try {
                const notification = document.getElementById('notification');
                if (notification) {
                    notification.textContent = message;
                    notification.className = `notification notification-${type}`;
                    notification.style.display = 'block';
                    
                    setTimeout(() => {
                        notification.style.display = 'none';
                    }, 3000);
                }
            } catch (error) {
                console.error('Error showing notification:', error);
            }
        }

        function updateCourseTypesTable() {
            try {
                const courseTypes = JSON.parse(localStorage.getItem('courseTypes') || '[]');
                const tbody = document.getElementById('courseTypesTableBody');
                
                if (!tbody) return;
                
                tbody.innerHTML = courseTypes.length ? 
                    courseTypes.map(courseType => `
                        <tr>
                            <td>${courseType.name}</td>
                            <td>${courseType.description}</td>
                            <td><span class="status-${courseType.status}">${courseType.status}</span></td>
                            <td>
                                <button class="btn btn-primary" onclick="editCourseType('${courseType.id}')">Edit</button>
                                <button class="btn btn-danger" onclick="deleteCourseType('${courseType.id}')">Delete</button>
                            </td>
                        </tr>
                    `).join('') :
                    '<tr><td colspan="4" style="text-align: center;">No course types found</td></tr>';
            } catch (error) {
                console.error('Error updating course types table:', error);
                showNotification('Error updating course types table', 'error');
            }
        }

        // Add these helper functions at the beginning of your script section
        function getWeekBounds(date) {
            const curr = new Date(date);
            const first = curr.getDate() - curr.getDay(); // First day is the day of the month - the day of the week
            const last = first + 6; // last day is the first day + 6

            const firstDay = new Date(curr.setDate(first));
            const lastDay = new Date(curr.setDate(last));

            // Format dates to YYYY-MM-DD
            return {
                start: firstDay.toISOString().split('T')[0],
                end: lastDay.toISOString().split('T')[0]
            };
        }

        function showAssignInstructorModal(courseId) {
            try {
                console.log('Starting showAssignInstructorModal with courseId:', courseId);
                
                const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                const instructors = JSON.parse(localStorage.getItem('instructors') || '[]');
                
                const course = courses.find(c => c.id === courseId);
                
                if (!course) {
                    console.error('Course not found:', courseId);
                    showNotification('Course not found', 'error');
                    return;
                }

                // Filter available instructors for the course date
                const availableInstructors = instructors.filter(instructor => {
                    const hasDate = instructor.availability && 
                        instructor.availability.includes(course.courseDate);
                    
                    if (!hasDate) {
                        console.log(`Instructor ${instructor.name} does not have date in availability`);
                        return false;
                    }

                    const isAlreadyAssigned = courses.some(c => 
                        c.courseDate === course.courseDate && 
                        c.instructorId === instructor.id &&
                        c.id !== courseId
                    );

                    console.log(`Instructor ${instructor.name}: hasDate=${hasDate}, isAlreadyAssigned=${isAlreadyAssigned}`);
                    return hasDate && !isAlreadyAssigned;
                });

                console.log('Available instructors:', availableInstructors);

                if (!availableInstructors || availableInstructors.length === 0) {
                    console.log('No available instructors found');
                    showNotification(`No instructors available for ${formatDateForDisplay(course.courseDate)}`, 'error');
                    return;
                }

                // Store courseId for the assign function
                localStorage.setItem('currentCourseId', courseId);

                // Populate and show modal
                const select = document.getElementById('instructorSelect');
                select.innerHTML = availableInstructors.map(instructor => 
                    `<option value="${instructor.id}">${instructor.name}</option>`
                ).join('');

                const modal = document.getElementById('assignInstructorModal');
                modal.style.display = 'block';
            } catch (error) {
                console.error('Error showing assign instructor modal:', error);
                showNotification('Error loading instructor assignment modal', 'error');
            }
        }

        // Add closeModal function
        function closeModal(modalId) {
            try {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'none';
                } else {
                    console.error(`Modal ${modalId} not found`);
                }
            } catch (error) {
                console.error('Error closing modal:', error);
            }
        }

        // Update the notification function to ensure it's visible
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            if (notification) {
                notification.textContent = message;
                notification.className = `notification notification-${type}`;
                notification.style.display = 'block';
                
                // Make sure the notification is visible
                notification.style.zIndex = '9999';
                notification.style.opacity = '1';
                
                // Hide after 3 seconds
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 3000);
            }
        }

        // Update the monthly confirmed courses table function with detailed tracing
        function updateMonthlyConfirmedCourses() {
            try {
                console.log('Starting updateMonthlyConfirmedCourses');
                
                const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                console.log('Loaded courses:', courses);
                
                const tbody = document.getElementById('monthlyConfirmedCoursesTable');
                console.log('Found tbody element:', !!tbody);
                
                if (!tbody) {
                    console.log('No tbody element found, returning');
                    return;
                }

                // Get current month's date range
                const today = new Date();
                const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                console.log('Date range:', {
                    firstDay: firstDay.toISOString(),
                    lastDay: lastDay.toISOString()
                });

                // Filter confirmed courses for current month
                const confirmedCourses = courses.filter(course => {
                    const courseDate = new Date(course.courseDate);
                    const isConfirmed = course.adminConfirmed === true; // Explicitly check for true
                    const isInCurrentMonth = courseDate >= firstDay && courseDate <= lastDay;
                    console.log('Course:', {
                        id: course.id,
                        date: course.courseDate,
                        status: course.status,
                        adminConfirmed: course.adminConfirmed,
                        isConfirmed,
                        isInCurrentMonth
                    });
                    return isConfirmed && isInCurrentMonth;
                });
                console.log('Filtered confirmed courses:', confirmedCourses);

                // Group courses by instructor and count them
                const instructorSummary = {};
                confirmedCourses.forEach(course => {
                    if (course.instructorName) {
                        instructorSummary[course.instructorName] = (instructorSummary[course.instructorName] || 0) + 1;
                    }
                });
                console.log('Instructor summary:', instructorSummary);

                // Convert to array and sort by total courses (descending)
                const sortedInstructors = Object.entries(instructorSummary)
                    .sort(([, a], [, b]) => b - a);
                console.log('Sorted instructors:', sortedInstructors);

                // Update the table
                tbody.innerHTML = sortedInstructors.length ? 
                    sortedInstructors.map(([instructor, total]) => `
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                            <td style="padding: 8px 5px; color: white; white-space: nowrap; font-weight: 500; background: transparent;">${instructor}</td>
                            <td style="text-align: center; padding: 8px 5px; font-weight: bold; color: white; background: rgba(255,255,255,0.15); border-radius: 3px;">${total}</td>
                        </tr>
                    `).join('') :
                    '<tr><td colspan="2" style="text-align: center; padding: 15px 5px; color: white; font-style: italic; background: transparent;">No confirmed courses</td></tr>';
                
                console.log('Table updated successfully');
            } catch (error) {
                console.error('Error in updateMonthlyConfirmedCourses:', error);
            }
        }

        // Clear all storage data
        function clearAllStorage() {
            try {
                localStorage.clear();
                console.log('All storage data cleared successfully');
                showNotification('All storage data cleared successfully', 'success');
            } catch (error) {
                console.error('Error clearing storage:', error);
                showNotification('Error clearing storage', 'error');
            }
        }

        function updateScheduledCoursesList() {
            try {
                const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                const tbody = document.getElementById('scheduledCoursesTableBody');
                
                if (!tbody) return;
                
                // Filter for unconfirmed and uncompleted courses
                const scheduledCourses = courses.filter(course => 
                    !course.isArchived && 
                    !course.completionStatus && 
                    !course.adminConfirmed
                );
                
                tbody.innerHTML = scheduledCourses.length ? 
                    scheduledCourses.map(course => {
                        const isPending = course.adminScheduledDashStatus === 'PENDING';
                        const instructors = JSON.parse(localStorage.getItem('instructors') || '[]');
                        const hasAvailableInstructors = instructors.some(instructor => 
                            instructor.availability && 
                            instructor.availability.includes(course.courseDate)
                        );

                        return `
                            <tr>
                                <td>${formatDate(course.courseDate)}</td>
                                <td>${course.organizationName || '-'}</td>
                                <td>${course.location || '-'}</td>
                                <td>${course.classType || '-'}</td>
                                <td>${course.studentsRegistered || 0}</td>
                                <td>
                                    <span class="status-${course.adminScheduledDashStatus.toLowerCase()}">${course.adminScheduledDashStatus}</span>
                                </td>
                                <td>${course.instructorName || 'Not Assigned'}</td>
                                <td>
                                    ${isPending ? 
                                        (hasAvailableInstructors ? 
                                            `<button class="btn btn-primary" onclick="showAssignInstructorModal('${course.id}')">Assign Instructor</button>` :
                                            `<button class="btn btn-secondary" disabled>No Instructors Available</button>`
                                        ) : 
                                        `<button class="btn btn-success" onclick="confirmCourse('${course.id}')">Confirm</button>`
                                    }
                                    <button class="btn btn-info" onclick="viewStudentList('${course.id}')">View Students</button>
                                </td>
                            </tr>
                        `;
                    }).join('') :
                    '<tr><td colspan="8" style="text-align: center;">No scheduled courses found</td></tr>';
                
                console.log('Scheduled courses list updated successfully');
            } catch (error) {
                console.error('Error in updateScheduledCoursesList:', error);
                showNotification('Error updating scheduled courses list', 'error');
            }
        }

        function updateConfirmedCoursesList() {
            try {
                console.log('=== STARTING CONFIRMED COURSES TRACE ===');
                
                const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                console.log('All courses from storage:', JSON.stringify(courses, null, 2));
                
                const tbody = document.getElementById('confirmedCoursesTableBody');
                console.log('Found confirmedCoursesTableBody element:', !!tbody);
                
                if (!tbody) {
                    console.warn('confirmedCoursesTableBody element not found');
                    return;
                }

                // Debug: Log all courses with their status
                console.log('\n=== COURSE STATUS DETAILS ===');
                courses.forEach(course => {
                    console.log('\nCourse Details:', {
                        id: course.id,
                        date: course.courseDate,
                        adminConfirmed: course.adminConfirmed,
                        completionStatus: course.completionStatus,
                        isArchived: course.isArchived,
                        status: course.status,
                        adminScheduledDashStatus: course.adminScheduledDashStatus,
                        instructorName: course.instructorName,
                        organizationName: course.organizationName,
                        classType: course.classType
                    });
                });

                // Filter for confirmed courses that are not completed
                console.log('\n=== FILTERING COURSES ===');
                const confirmedCourses = courses.filter(course => {
                    const isConfirmed = course.adminConfirmed === true;
                    const isNotCompleted = course.completionStatus !== 'COMPLETED';
                    const isNotArchived = !course.isArchived;
                    
                    console.log('\nCourse Filter Check:', {
                        id: course.id,
                        date: course.courseDate,
                        isConfirmed,
                        isNotCompleted,
                        isNotArchived,
                        adminConfirmed: course.adminConfirmed,
                        completionStatus: course.completionStatus,
                        isArchived: course.isArchived,
                        'Filter Result': isConfirmed && isNotCompleted && isNotArchived
                    });
                    
                    return isConfirmed && isNotCompleted && isNotArchived;
                });
                
                console.log('\n=== FILTERED CONFIRMED COURSES ===');
                console.log('Number of confirmed courses:', confirmedCourses.length);
                console.log('Confirmed courses:', JSON.stringify(confirmedCourses, null, 2));

                tbody.innerHTML = confirmedCourses.length ? 
                    confirmedCourses.map(course => {
                        console.log('\nProcessing confirmed course for display:', course);
                        return `
                            <tr>
                                <td>${formatDate(course.courseDate)}</td>
                                <td>${course.organizationName || '-'}</td>
                                <td>${course.location || '-'}</td>
                                <td>${course.classType || '-'}</td>
                                <td>${course.studentsRegistered || 0}</td>
                                <td>
                                    <span class="status-confirmed">CONFIRMED</span>
                                </td>
                                <td>${course.instructorName || '-'}</td>
                                <td>
                                    <button class="btn btn-info" onclick="viewStudentList('${course.id}')">View Students</button>
                                    <button class="btn btn-primary" onclick="generateBill('${course.id}')">BILL</button>
                                </td>
                            </tr>
                        `;
                    }).join('') :
                    '<tr><td colspan="8" style="text-align: center;">No confirmed courses found</td></tr>';
                
                console.log('\n=== CONFIRMED COURSES LIST UPDATE COMPLETE ===');
            } catch (error) {
                console.error('Error in updateConfirmedCoursesList:', error);
                showNotification('Error updating confirmed courses list', 'error');
            }
        }

        function confirmCourse(courseId) {
            try {
                console.log('Starting confirmCourse function with courseId:', courseId);
                
                const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                console.log('Current courses:', courses);
                
                const courseIndex = courses.findIndex(c => c.id === courseId);
                console.log('Found course at index:', courseIndex);
                
                if (courseIndex === -1) {
                    console.error('Course not found with ID:', courseId);
                    showNotification('Course not found', 'error');
                    return;
                }

                console.log('Course before update:', courses[courseIndex]);

                // Update course statuses for all portals
                const course = courses[courseIndex];
                course.status = 'CONFIRMED';                    // Organization Portal view
                course.adminConfirmed = true;                  // Set confirmation flag
                course.adminScheduledDashStatus = 'CONFIRMED'; // Admin Portal Scheduled Courses view
                course.adminInstructorDashStatus = 'CONFIRMED';// Admin Portal Instructor Dashboard
                course.organizationStatus = 'CONFIRMED';       // Organization Portal status
                course.instructorStatus = 'CONFIRMED';         // Instructor Portal status
                course.displayInstructorDetails = true;       // Show instructor details in org portal
                course.displayOrgDetails = true;              // Show org details in instructor portal
                course.billingStatus = 'PENDING';             // Set billing status
                course.confirmationDate = new Date().toISOString(); // Record confirmation date

                console.log('Course after update:', course);

                // Save changes
                localStorage.setItem('courses', JSON.stringify(courses));
                
                // Update displays
                updateScheduledCoursesList();
                updateConfirmedCoursesList();
                updateInstructorDashboard();
                
                showNotification('Course confirmed successfully', 'success');
            } catch (error) {
                console.error('Error confirming course:', error);
                showNotification('Error confirming course', 'error');
            }
        }

        // Add this function to handle course completion
        function completeCourse(courseId) {
            try {
                console.log('Starting completeCourse function with courseId:', courseId);
                
                const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                const courseIndex = courses.findIndex(c => c.id === courseId);
                
                if (courseIndex === -1) {
                    console.error('Course not found with ID:', courseId);
                    showNotification('Course not found', 'error');
                    return;
                }

                const course = courses[courseIndex];
                
                // Only allow completion of confirmed courses
                if (!course.adminConfirmed) {
                    showNotification('Course must be confirmed before completion', 'error');
                    return;
                }

                // Update course status
                course.completionStatus = 'COMPLETED';
                course.completedDate = new Date().toISOString();
                course.completedBy = course.instructorId;
                course.billingStatus = 'READY_FOR_BILLING';
                course.autoArchiveDate = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(); // 7 days from now

                // Save changes
                localStorage.setItem('courses', JSON.stringify(courses));
                
                // Update displays
                updateConfirmedCoursesList();
                updateCompletedCoursesList();
                updateInstructorDashboard();
                
                showNotification('Course marked as completed successfully', 'success');
            } catch (error) {
                console.error('Error completing course:', error);
                showNotification('Error completing course', 'error');
            }
        }

        // Add this function to handle billing
        function generateBill(courseId) {
            try {
                console.log('Starting generateBill function with courseId:', courseId);
                
                const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                const courseIndex = courses.findIndex(c => c.id === courseId);
                
                if (courseIndex === -1) {
                    console.error('Course not found with ID:', courseId);
                    showNotification('Course not found', 'error');
                    return;
                }

                const course = courses[courseIndex];
                
                // Only allow billing of completed courses
                if (course.completionStatus !== 'COMPLETED') {
                    showNotification('Course must be completed before billing', 'error');
                    return;
                }

                // Update billing status
                course.billingStatus = 'BILLED';
                course.billedDate = new Date().toISOString();

                // Save changes
                localStorage.setItem('courses', JSON.stringify(courses));
                
                // Update displays
                updateCompletedCoursesList();
                
                showNotification('Bill generated successfully', 'success');
            } catch (error) {
                console.error('Error generating bill:', error);
                showNotification('Error generating bill', 'error');
            }
        }

        // Update the instructor dashboard
        function updateInstructorDashboard() {
            try {
                const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                const tbody = document.getElementById('instructorDashboardTableBody');
                
                if (!tbody) return;

                tbody.innerHTML = courses.length ? 
                    courses.map(course => {
                        if (!course.instructorId) return '';
                        
                        // Show status based on adminInstructorDashStatus
                        let statusDisplay = `<span class="status-${course.adminInstructorDashStatus.toLowerCase()}">${course.adminInstructorDashStatus}</span>`;
                        
                        // Only show organization details if course is confirmed
                        const showDetails = course.adminConfirmed;

                        return `
                            <tr>
                                <td>${formatDate(course.courseDate)}</td>
                                <td>${course.instructorName || '-'}</td>
                                <td>${showDetails ? course.organizationName : '-'}</td>
                                <td>${showDetails ? course.location : '-'}</td>
                                <td>${showDetails ? course.classType : '-'}</td>
                                <td>${statusDisplay}</td>
                                <td>
                                    <button class="btn btn-info" onclick="viewStudentList('${course.id}')">View Students</button>
                                </td>
                            </tr>
                        `;
                    }).filter(row => row !== '').join('') :
                    '<tr><td colspan="7" style="text-align: center;">No instructor assignments found</td></tr>';
            } catch (error) {
                console.error('Error updating instructor dashboard:', error);
                showNotification('Error updating instructor dashboard', 'error');
            }
        }

        function updateCourseList() {
            try {
                const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                const courseList = document.getElementById('courseList');
                const noCourses = document.getElementById('noCourses');

                if (!courseList || !noCourses) return;

                // Get today's date in YYYY-MM-DD format
                const today = new Date().toISOString().split('T')[0];

                // Filter courses for today that are confirmed but not completed
                const todaysCourses = courses.filter(course => 
                    course.courseDate === today && 
                    course.adminConfirmed && 
                    course.completionStatus !== 'COMPLETED'
                );

                if (todaysCourses.length === 0) {
                    courseList.style.display = 'none';
                    noCourses.style.display = 'block';
                    return;
                }

                courseList.style.display = 'grid';
                noCourses.style.display = 'none';

                // Generate course cards
                const courseCards = todaysCourses.map(course => {
                    const statusClass = course.completionStatus === 'COMPLETED' ? 'complete' :
                        course.adminConfirmed ? 'confirmed' :
                        course.instructorId ? 'scheduled' : 'pending';

                    const statusText = course.completionStatus === 'COMPLETED' ? 'COMPLETED' :
                        course.adminConfirmed ? 'CONFIRMED' :
                        course.instructorId ? 'SCHEDULED' : 'PENDING';

                    return `
                        <div class="course-card">
                            <div class="course-header">
                                <h3>${course.classType}</h3>
                                <span class="status-${statusClass}">${statusText}</span>
                            </div>
                            <div class="course-details">
                                <p><strong>Date:</strong> ${formatDate(course.courseDate)}</p>
                                <p><strong>Location:</strong> ${course.location}</p>
                                <p><strong>Organization:</strong> ${course.organizationName}</p>
                                <p><strong>Instructor:</strong> ${course.instructorName || 'Not Assigned'}</p>
                                <p><strong>Students:</strong> ${course.studentsRegistered || 0} registered</p>
                            </div>
                            <div class="course-actions">
                                <button class="btn btn-primary" onclick="viewStudentList('${course.id}')">
                                    View Student List
                                </button>
                                <button class="btn btn-success" onclick="viewCertificates('${course.id}')">
                                    View Certificates
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

                courseList.innerHTML = courseCards;
            } catch (error) {
                console.error('Error updating course list:', error);
                showNotification('Error loading courses', 'error');
            }
        }

        function viewStudentList(courseId) {
            try {
                const courses = JSON.parse(localStorage.getItem('courses')) || [];
                const course = courses.find(c => c.id === courseId);
                
                if (course) {
                    const studentListTableBody = document.getElementById('studentListTableBody');
                    if (!studentListTableBody) return;
                    
                    // Clear existing content
                    studentListTableBody.innerHTML = '';
                    
                    if (!course.studentList || course.studentList.length === 0) {
                        studentListTableBody.innerHTML = `
                            <tr>
                                <td colspan="4" style="text-align: center;">No students added yet</td>
                            </tr>
                        `;
                    } else {
                        course.studentList.forEach(student => {
                            const row = document.createElement('tr');
                            // Determine attendance status
                            const attendanceStatus = student.attendance ? 
                                `<span class="status-${student.attendance}">${student.attendance.toUpperCase()}</span>` : 
                                'Not Recorded';
                            
                            row.innerHTML = `
                                <td>${student.name || '-'}</td>
                                <td>${student.email || '-'}</td>
                                <td>${student.status || 'Registered'}</td>
                                <td>${attendanceStatus}</td>
                                <td>${student.notes || '-'}</td>
                            `;
                            studentListTableBody.appendChild(row);
                        });
                    }
                    
                    // Show the modal
                    document.getElementById('studentListModal').style.display = 'block';
                }
            } catch (error) {
                console.error('Error viewing student list:', error);
                showNotification('Error loading student list', 'error');
            }
        }

        function closeStudentListModal() {
            try {
                const modal = document.getElementById('studentListModal');
                if (modal) {
                    modal.style.display = 'none';
                }
            } catch (error) {
                console.error('Error closing student list modal:', error);
                showNotification('Error closing modal', 'error');
            }
        }

        // Add this function to update completed courses
        function updateCompletedCoursesList() {
            try {
                console.log('=== STARTING COMPLETED COURSES TRACE ===');
                
                const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                console.log('All courses from storage:', JSON.stringify(courses, null, 2));
                
                const tbody = document.getElementById('completedCoursesTableBody');
                console.log('Found completedCoursesTableBody element:', !!tbody);
                
                if (!tbody) {
                    console.warn('completedCoursesTableBody element not found');
                    return;
                }

                // Filter for completed courses
                const completedCourses = courses.filter(course => {
                    const isCompleted = course.completionStatus === 'COMPLETED';
                    const isNotArchived = !course.isArchived;
                    
                    console.log('\nCourse Filter Check:', {
                        id: course.id,
                        date: course.courseDate,
                        isCompleted,
                        isNotArchived,
                        completionStatus: course.completionStatus,
                        isArchived: course.isArchived,
                        billingStatus: course.billingStatus,
                        'Filter Result': isCompleted && isNotArchived
                    });
                    
                    return isCompleted && isNotArchived;
                });
                
                console.log('\n=== FILTERED COMPLETED COURSES ===');
                console.log('Number of completed courses:', completedCourses.length);
                console.log('Completed courses:', JSON.stringify(completedCourses, null, 2));

                tbody.innerHTML = completedCourses.length ? 
                    completedCourses.map(course => {
                        console.log('\nProcessing completed course for display:', course);
                        const billingStatusClass = course.billingStatus === 'BILLED' ? 'billed' :
                                                 course.billingStatus === 'READY_FOR_BILLING' ? 'ready-for-billing' : 'pending';
                        
                        return `
                            <tr>
                                <td>${formatDate(course.courseDate)}</td>
                                <td>${course.organizationName || '-'}</td>
                                <td>${course.location || '-'}</td>
                                <td>${course.classType || '-'}</td>
                                <td>${course.studentsRegistered || 0}</td>
                                <td>${course.studentsAttended || 0}</td>
                                <td>
                                    <span class="status-complete">COMPLETED</span>
                                </td>
                                <td>
                                    <span class="status-${billingStatusClass}">${course.billingStatus || 'PENDING'}</span>
                                </td>
                                <td>${course.instructorName || '-'}</td>
                                <td>
                                    <button class="btn btn-info" onclick="viewStudentList('${course.id}')">View Students</button>
                                    ${course.billingStatus === 'READY_FOR_BILLING' ? 
                                        `<button class="btn btn-primary" onclick="generateBill('${course.id}')">BILL</button>` :
                                        course.billingStatus === 'BILLED' ?
                                        `<button class="btn btn-success" disabled>BILLED</button>` :
                                        ''
                                    }
                                </td>
                            </tr>
                        `;
                    }).join('') :
                    '<tr><td colspan="10" style="text-align: center;">No completed courses found</td></tr>';
                
                console.log('\n=== COMPLETED COURSES LIST UPDATE COMPLETE ===');
            } catch (error) {
                console.error('Error in updateCompletedCoursesList:', error);
                showNotification('Error updating completed courses list', 'error');
            }
        }

        function showResetDataConfirmation() {
            document.getElementById('resetDataModal').style.display = 'block';
        }

        function resetAllData() {
            try {
                // Clear all data from localStorage
                localStorage.clear();
                
                // Reinitialize default course types
                initializeCourseTypes();
                
                // Show success message
                showNotification('All data has been reset successfully', 'success');
                
                // Reload the page after a short delay
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } catch (error) {
                console.error('Error resetting data:', error);
                showNotification('Error resetting data', 'error');
            }
        }

        function updateStudentTable() {
            const students = JSON.parse(localStorage.getItem('students') || '[]');
            const courses = JSON.parse(localStorage.getItem('courses') || '[]');
            const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
            const tbody = document.getElementById('studentTableBody');

            const filteredStudents = students.filter(student =>
                student.name.toLowerCase().includes(searchTerm) ||
                student.email.toLowerCase().includes(searchTerm) ||
                student.phone.includes(searchTerm)
            );

            tbody.innerHTML = filteredStudents.map(student => {
                const studentCourses = courses.filter(course => 
                    student.courses.includes(course.id)
                );

                return `
                    <tr>
                        <td>${student.name}</td>
                        <td>${student.email}</td>
                        <td>${student.phone}</td>
                        <td>${formatDate(student.registrationDate)}</td>
                        <td>${studentCourses.length} courses</td>
                        <td>${student.certificates.length} certificates</td>
                        <td>
                            <button class="btn btn-info btn-sm" onclick="viewStudentDetails('${student.id}')">
                                View Details
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function viewStudentDetails(studentId) {
            const students = JSON.parse(localStorage.getItem('students') || '[]');
            const courses = JSON.parse(localStorage.getItem('courses') || '[]');
            const student = students.find(s => s.id === studentId);

            if (!student) {
                showNotification('Student not found', 'error');
                return;
            }

            const studentCourses = courses.filter(course => 
                student.courses.includes(course.id)
            );

            const modalContent = `
                <div class="student-details">
                    <h3>${student.name}</h3>
                    <p><strong>Email:</strong> ${student.email}</p>
                    <p><strong>Phone:</strong> ${student.phone}</p>
                    <p><strong>Registration Date:</strong> ${formatDate(student.registrationDate)}</p>
                    
                    <h4>Course History</h4>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Course Type</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Certificate</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${studentCourses.map(course => `
                                <tr>
                                    <td>${course.classType}</td>
                                    <td>${formatDate(course.courseDate)}</td>
                                    <td>${course.completionStatus}</td>
                                    <td>
                                        ${course.completionStatus === 'COMPLETED' ?
                                            `<button class="btn btn-info btn-sm" onclick="viewCertificate('${course.id}', '${student.id}')">
                                                View Certificate
                                            </button>` :
                                            'N/A'
                                        }
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            // Show modal with student details
            const modal = document.getElementById('genericModal');
            modal.querySelector('.modal-title').textContent = 'Student Details';
            modal.querySelector('.modal-body').innerHTML = modalContent;
            new bootstrap.Modal(modal).show();
        }

        // Add student management to section buttons
        document.addEventListener('DOMContentLoaded', function() {
            const sectionButtons = document.querySelector('.section-buttons');
            sectionButtons.innerHTML += `
                <button onclick="showSection('studentManagement')" class="btn btn-primary">
                    Student Management
                </button>
            `;
        });
    </script>
</body>
</html> 