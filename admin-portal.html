<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GTA CPR - Course Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --background-color: #ecf0f1;
            --text-color: #2c3e50;
            --border-color: #bdc3c7;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .main-header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .main-nav {
            display: flex;
            gap: 1rem;
        }

        .main-nav a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .main-nav a:hover {
            background-color: var(--secondary-color);
        }

        .main-nav a.active {
            background-color: var(--secondary-color);
        }

        .dashboard {
            padding: 1rem;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .dashboard-title {
            margin-bottom: 1rem;
            color: var(--primary-color);
            font-size: 1.5rem;
        }

        .filter-section {
            background-color: white;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-group label {
            color: var(--text-color);
            font-weight: bold;
        }

        .filter-group select {
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-color);
        }

        .btn {
            background-color: var(--secondary-color);
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .btn:hover {
            background-color: #2980b9;
        }

        .btn-reset {
            background-color: var(--accent-color);
        }

        .btn-reset:hover {
            background-color: #c0392b;
        }

        .btn-assign {
            background-color: var(--secondary-color);
        }

        .btn-confirm {
            background-color: #27ae60;
        }

        .btn-confirm:hover {
            background-color: #219a52;
        }

        .btn-bill {
            background-color: #f39c12;
        }

        .btn-bill:hover {
            background-color: #d68910;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            table-layout: fixed;
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        th {
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        /* Add specific column widths */
        th:nth-child(1), td:nth-child(1) { width: 15%; } /* Name */
        th:nth-child(2), td:nth-child(2) { width: 10%; } /* Status */
        th:nth-child(3), td:nth-child(3) { width: 12%; } /* Date */
        th:nth-child(4), td:nth-child(4) { width: 18%; } /* Organization */
        th:nth-child(5), td:nth-child(5) { width: 15%; } /* Location */
        th:nth-child(6), td:nth-child(6) { width: 12%; } /* Class Type */
        th:nth-child(7), td:nth-child(7) { width: 10%; } /* Students Registered */
        th:nth-child(8), td:nth-child(8) { width: 8%; } /* Actions */

        thead {
            width: 100%;
            display: table;
            table-layout: fixed;
        }

        tbody {
            width: 100%;
            display: table;
            table-layout: fixed;
        }

        tr {
            width: 100%;
            display: table-row;
        }

        .table-container {
            width: 100%;
            overflow-x: auto;
            margin-bottom: 2rem;
        }

        th.sortable:hover {
            background-color: #34495e;
        }

        th.asc::after {
            content: ' ↑';
        }

        th.desc::after {
            content: ' ↓';
        }

        tr:hover {
            background-color: var(--background-color);
        }

        .instructor-row {
            background-color: #f8f9fa;
            font-weight: bold;
        }

        .date-status-row {
            background-color: white;
        }

        .nested-row td:first-child {
            padding-left: 30px;
        }

        .status-available {
            background-color: #2ecc71;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .status-scheduled {
            background-color: #f39c12;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .status-confirmed {
            background-color: #3498db;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .status-complete {
            background-color: #28a745;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .notes-cell {
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        section {
            margin-bottom: 2rem;
        }

        section h2 {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        @media (max-width: 768px) {
            .dashboard {
                padding: 1rem;
            }

            .filter-section {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-group {
                flex-direction: column;
                align-items: stretch;
            }

            table {
                font-size: 0.9rem;
            }

            .btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 5px;
            width: 80%;
            max-width: 500px;
        }

        .modal-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            border-radius: 4px;
            color: white;
            display: none;
            z-index: 1001;
        }

        .notification-success {
            background-color: #2ecc71;
        }

        .notification-error {
            background-color: #e74c3c;
        }

        .btn-secondary {
            background-color: #95a5a6;
        }

        .btn-secondary:hover {
            background-color: #7f8c8d;
        }

        .btn-danger {
            background-color: #e74c3c;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        #resetDataModal ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        #resetDataModal p {
            margin: 10px 0;
        }

        .table-responsive td:last-child {
            text-align: center;
            white-space: nowrap;
        }

        .table-responsive .btn {
            display: inline-block;
            margin: 0;
            min-width: 80px;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-success {
            background-color: #2ecc71;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-success:hover {
            background-color: #27ae60;
        }

        /* Update column widths for scheduled courses table */
        .table-responsive table {
            table-layout: fixed;
            width: 100%;
        }

        .table-responsive table th,
        .table-responsive table td {
            padding: 0.75rem;
            text-align: left;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Specific column widths for scheduled courses table */
        .table-responsive table th:nth-child(1), 
        .table-responsive table td:nth-child(1) { width: 12%; }  /* Course Date */
        
        .table-responsive table th:nth-child(2), 
        .table-responsive table td:nth-child(2) { width: 15%; }  /* Organization */
        
        .table-responsive table th:nth-child(3), 
        .table-responsive table td:nth-child(3) { width: 10%; }  /* Location */
        
        .table-responsive table th:nth-child(4), 
        .table-responsive table td:nth-child(4) { width: 10%; }  /* Class Type */
        
        .table-responsive table th:nth-child(5), 
        .table-responsive table td:nth-child(5) { width: 10%; }  /* Students Registered */
        
        .table-responsive table th:nth-child(6), 
        .table-responsive table td:nth-child(6) { width: 15%; }  /* Status */
        
        .table-responsive table th:nth-child(7), 
        .table-responsive table td:nth-child(7) { width: 15%; }  /* Instructor */
        
        .table-responsive table th:nth-child(8), 
        .table-responsive table td:nth-child(8) { width: 13%; }  /* Actions */

        /* Ensure the table header and cells align properly */
        .table-responsive thead {
            background-color: var(--primary-color);
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .table-responsive th {
            font-weight: bold;
            color: white;
            background-color: var(--primary-color);
        }

        /* Ensure consistent padding and text alignment */
        .table-responsive td {
            vertical-align: middle;
        }

        /* Make sure the action buttons stay in their column */
        .table-responsive td:last-child {
            text-align: center;
            white-space: nowrap;
            overflow: visible;
        }

        .table-responsive .btn {
            margin: 2px;
            padding: 0.4rem 0.8rem;
            font-size: 0.9rem;
        }

        /* Add these styles to your existing CSS */
        .section {
            display: none;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .section.active {
            display: block;
        }

        .left-nav {
            display: flex;
            flex-direction: row;
            gap: 10px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .left-nav button {
            padding: 8px 15px;
            border: none;
            background: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            transition: background-color 0.3s;
            min-width: 120px;
            white-space: nowrap;
        }

        .left-nav button:hover {
            background: #e9ecef;
        }

        .left-nav button.active {
            background: var(--secondary-color);
            color: white;
        }

        .left-nav button.btn-danger {
            background: var(--accent-color);
            color: white;
        }

        .left-nav button.btn-danger:hover {
            background: #c0392b;
        }

        .main-content {
            flex: 1;
            padding: 20px;
        }

        .dashboard {
            display: flex;
            gap: 20px;
        }

        /* Add these styles to your existing CSS */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 5px;
            margin-top: 5px;
        }

        .stat-card {
            background: white;
            padding: 5px;
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card h3 {
            color: var(--primary-color);
            margin-bottom: 2px;
            font-size: 0.8rem;
        }

        .stat-card p {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--secondary-color);
            margin: 0;
        }

        /* Add these styles to your existing CSS */
        .banner-box {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .banner-box h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .banner-box .nav-links {
            display: flex;
            gap: 1rem;
        }

        .banner-box .nav-links a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .banner-box .nav-links a:hover {
            background-color: var(--secondary-color);
        }

        .banner-box .nav-links a.active {
            background-color: var(--secondary-color);
        }

        /* Update table styles for proper alignment */
        .table-responsive {
            overflow-x: auto;
            margin-bottom: 1rem;
        }

        .table-responsive table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        .table-responsive th,
        .table-responsive td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Specific column widths for scheduled courses table */
        .table-responsive table th:nth-child(1), 
        .table-responsive table td:nth-child(1) { width: 12%; }  /* Course Date */
        
        .table-responsive table th:nth-child(2), 
        .table-responsive table td:nth-child(2) { width: 15%; }  /* Organization */
        
        .table-responsive table th:nth-child(3), 
        .table-responsive table td:nth-child(3) { width: 10%; }  /* Location */
        
        .table-responsive table th:nth-child(4), 
        .table-responsive table td:nth-child(4) { width: 10%; }  /* Class Type */
        
        .table-responsive table th:nth-child(5), 
        .table-responsive table td:nth-child(5) { width: 10%; }  /* Students Registered */
        
        .table-responsive table th:nth-child(6), 
        .table-responsive table td:nth-child(6) { width: 15%; }  /* Status */
        
        .table-responsive table th:nth-child(7), 
        .table-responsive table td:nth-child(7) { width: 15%; }  /* Instructor */
        
        .table-responsive table th:nth-child(8), 
        .table-responsive table td:nth-child(8) { width: 13%; }  /* Actions */

        /* Ensure header stays fixed */
        .table-responsive thead {
            position: sticky;
            top: 0;
            z-index: 1;
            background-color: var(--primary-color);
        }

        /* Ensure content cells are properly aligned */
        .table-responsive tbody td {
            vertical-align: middle;
            background-color: white;
        }

        /* Status styling */
        .status-scheduled {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
            background-color: #f39c12;
            color: white;
        }

        /* Action buttons alignment */
        .table-responsive td:last-child {
            text-align: center;
            white-space: nowrap;
            overflow: visible;
        }

        .table-responsive .btn {
            margin: 2px;
            padding: 0.4rem 0.8rem;
            font-size: 0.9rem;
        }

        .section-buttons {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .section-buttons button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            background-color: var(--secondary-color);
            color: white;
        }

        .section-buttons button:hover {
            background-color: #2980b9;
        }

        .section-buttons button.active {
            background-color: var(--primary-color);
        }

        .bulk-upload-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 1rem;
        }

        .upload-section {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .upload-section h3 {
            margin-bottom: 1rem;
            color: var(--primary-color);
        }

        .button-group {
            margin-top: 1rem;
            display: flex;
            gap: 1rem;
        }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="logo">GTA CPR</div>
        <nav class="main-nav">
            <a href="Index.html">Home</a>
            <a href="instructor-portal.html">Instructors</a>
            <a href="organization-portal.html">Organizations</a>
            <a href="admin-portal.html" class="active">Course Management</a>
            <a href="support-portal.html">Support</a>
            <a href="#" onclick="handleLogout()">Logout</a>
        </nav>
    </header>

    <div class="dashboard">
        <h1 class="dashboard-title">Admin Dashboard</h1>
        <div class="section-buttons">
            <button onclick="showSection('scheduledCourses')" id="scheduledCoursesBtn">
                <i class="fas fa-calendar-check"></i>
                <span>Scheduled Courses</span>
            </button>
            <button onclick="showSection('instructorAvailability')" id="instructorAvailabilityBtn">
                <i class="fas fa-user-clock"></i>
                <span>Instructor Availability</span>
            </button>
            <button onclick="showSection('instructorDash')" id="instructorDashBtn">
                <i class="fas fa-chart-line"></i>
                <span>Instructor Dashboard</span>
            </button>
            <button onclick="showSection('organizationDash')" id="organizationDashBtn">
                <i class="fas fa-building"></i>
                <span>Organization Dashboard</span>
            </button>
            <button onclick="showSection('bulkUpload')" id="bulkUploadBtn">
                <i class="fas fa-file-upload"></i>
                <span>Bulk Upload</span>
            </button>
            <button onclick="showSection('confirmedCourses')" class="btn btn-primary">Confirmed Courses</button>
            <button onclick="showSection('completedCourses')" class="btn btn-primary">Completed Courses</button>
            <button onclick="showSection('courseTypes')" class="btn btn-primary">Course Types</button>
            <button onclick="showSection('instructors')">Instructors</button>
            <button onclick="showSection('organizations')">Organizations</button>
            <button onclick="showSection('userManagement')">User Management</button>
            <button onclick="showSection('courseTypes')">Course Types</button>
            <button onclick="showSection('analytics')">Analytics</button>
            <button class="btn-danger" onclick="showResetDataConfirmation()">Reset All Data</button>
            <button onclick="handleLogout()">Logout</button>
        </div>

        <nav class="left-nav">
            <button onclick="showSection('dashboard')">Dashboard</button>
            <button onclick="showSection('scheduledCourses')">Scheduled Courses</button>
            <button onclick="showSection('confirmedCourses')">Confirmed Courses</button>
            <button onclick="showSection('completedCourses')">Completed Courses</button>
            <button onclick="showSection('instructors')">Instructors</button>
            <button onclick="showSection('organizations')">Organizations</button>
            <button onclick="showSection('userManagement')">User Management</button>
            <button onclick="showSection('courseTypes')">Course Types</button>
            <button onclick="showSection('analytics')">Analytics</button>
            <button class="btn-danger" onclick="showResetDataConfirmation()">Reset All Data</button>
            <button onclick="handleLogout()">Logout</button>
        </nav>

        <main class="main-content">
            <!-- Dashboard Section -->
            <section id="dashboard" class="section">
                <div style="display: flex; gap: 10px;">
                    <!-- Left side - Stats -->
                    <div style="flex: 2;">
                        <div class="dashboard-stats" style="margin-bottom: 20px;">
                            <div class="stat-card">
                                <h3>Total Courses</h3>
                                <p id="totalCoursesCount">0</p>
                            </div>
                            <div class="stat-card">
                                <h3>Pending</h3>
                                <p id="pendingCoursesCount">0</p>
                            </div>
                            <div class="stat-card">
                                <h3>Scheduled</h3>
                                <p id="scheduledCoursesCount">0</p>
                            </div>
                            <div class="stat-card">
                                <h3>Confirmed</h3>
                                <p id="confirmedCoursesCount">0</p>
                            </div>
                            <div class="stat-card">
                                <h3>Completed</h3>
                                <p id="completedCoursesCount">0</p>
                            </div>
                        </div>
                        <div class="table-responsive" style="background: white; padding: 15px; border-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th scope="col" style="background-color: var(--primary-color); color: white; font-size: 0.9rem; text-align: left;">Date</th>
                                        <th scope="col" style="background-color: var(--primary-color); color: white; font-size: 0.9rem; text-align: left;">Organization</th>
                                        <th scope="col" style="background-color: var(--primary-color); color: white; font-size: 0.9rem; text-align: left;">Course Type</th>
                                        <th scope="col" style="background-color: var(--primary-color); color: white; font-size: 0.9rem; text-align: left;">Instructor</th>
                                        <th scope="col" style="background-color: var(--primary-color); color: white; font-size: 0.9rem; text-align: center;">Pending</th>
                                        <th scope="col" style="background-color: var(--primary-color); color: white; font-size: 0.9rem; text-align: center;">Scheduled</th>
                                        <th scope="col" style="background-color: var(--primary-color); color: white; font-size: 0.9rem; text-align: center;">Confirmed</th>
                                        <th scope="col" style="background-color: var(--primary-color); color: white; font-size: 0.9rem; text-align: center;">Completed</th>
                                    </tr>
                                </thead>
                                <tbody id="courseStatusTableBody">
                                    <!-- JavaScript will populate this -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Right side - Monthly Instructor Summary -->
                    <div style="max-width: 300px; margin-left: 20px;">
                        <div style="background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%); border-radius: 8px; padding: 1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <h3 style="color: white; margin: 0 0 15px 0; font-size: 1.1rem; text-align: center; border-bottom: 2px solid rgba(255,255,255,0.2); padding-bottom: 10px;">Monthly Summary</h3>
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto; overflow-x: hidden;">
                                <table style="width: 100%; color: white; border-collapse: separate; border-spacing: 0 8px;">
                                    <thead>
                                        <tr>
                                            <th style="padding: 8px; text-align: left; font-size: 0.9rem; color: #a3c2e3;">Instructor</th>
                                            <th style="padding: 8px; text-align: center; font-size: 0.9rem; color: #a3c2e3;">Confirmed</th>
                                            <th style="padding: 8px; text-align: center; font-size: 0.9rem; color: #a3c2e3;">Completed</th>
                                        </tr>
                                    </thead>
                                    <tbody id="monthlyConfirmedCoursesBody">
                                        <tr>
                                            <td colspan="3" style="text-align: center; padding: 15px 5px; color: white; font-style: italic;">No confirmed courses</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Add User Management Section -->
            <section id="userManagement" class="section">
                <h2>User Management</h2>
                <div class="table-container">
                    <div class="table-header">
                        <h3>System Users</h3>
                        <button class="btn btn-primary" onclick="showAddUserModal()">Add New User</button>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Last Login</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="userManagementTableBody"></tbody>
                    </table>
                </div>
            </section>

            <!-- Add User Modal -->
            <div id="addUserModal" class="modal">
                <div class="modal-content">
                    <h2>Add New User</h2>
                    <form onsubmit="handleAddUser(event)">
                        <div class="form-group">
                            <label for="newUsername">Username:</label>
                            <input type="text" id="newUsername" required>
                        </div>
                        <div class="form-group">
                            <label for="newPassword">Password:</label>
                            <input type="password" id="newPassword" required>
                        </div>
                        <div class="form-group">
                            <label for="userRole">Role:</label>
                            <select id="userRole" required>
                                <option value="">Select Role</option>
                                <option value="admin">Admin</option>
                                <option value="instructor">Instructor</option>
                                <option value="organization">Organization</option>
                                <option value="accounting">Accounting</option>
                            </select>
                        </div>
                        <div class="modal-buttons">
                            <button type="submit" class="btn btn-primary">Add User</button>
                            <button type="button" class="btn btn-secondary" onclick="closeModal('addUserModal')">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Instructor Dashboard -->
            <section id="instructorDashboard">
                <h2>Instructor Dashboard</h2>
                <div class="filters-section">
                    <div class="form-group">
                        <label for="dateFilter">Date:</label>
                        <input type="date" id="dateFilter">
                    </div>
                    <div class="form-group">
                        <label for="instructorFilter">Instructor:</label>
                        <select id="instructorFilter">
                            <option value="">All Instructors</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="organizationFilter">Organization:</label>
                        <select id="organizationFilter">
                            <option value="">All Organizations</option>
                        </select>
                    </div>
                    <!-- Add Quick Status Filter -->
                    <div class="form-group">
                        <label for="quickStatusFilter">Status:</label>
                        <select id="quickStatusFilter" onchange="filterTables()">
                            <option value="">All Statuses</option>
                            <option value="Available">Available</option>
                            <option value="Scheduled">Scheduled</option>
                            <option value="Confirmed">Confirmed</option>
                        </select>
                    </div>
                    <!-- Add Search Bar -->
                    <div class="form-group">
                        <label for="searchInput">Search:</label>
                        <input type="text" id="searchInput" placeholder="Search instructors, organizations..." oninput="filterTables()">
                    </div>
                    <!-- Add Bulk Actions -->
                    <div class="form-group">
                        <button class="btn btn-primary" onclick="confirmSelectedCourses()">Confirm Selected</button>
                    </div>
                </div>
                <div class="filter-section">
                    <div class="filter-group">
                        <label for="statusFilter">Status:</label>
                        <select id="statusFilter">
                            <option value="">All</option>
                            <option value="Available">Available</option>
                            <option value="Scheduled">Scheduled</option>
                            <option value="Confirmed">Confirmed</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <button class="btn btn-reset" onclick="resetFilters()">Reset Filters</button>
                        <button class="btn btn-danger" onclick="showResetDataConfirmation()">Reset All Data</button>
                    </div>
                </div>
                <div class="table-container">
                    <table id="instructorTable">
                        <thead>
                            <tr>
                                <th onclick="sortTable('instructorTable', 0)">Name</th>
                                <th onclick="sortTable('instructorTable', 1)">Status</th>
                                <th onclick="sortTable('instructorTable', 2)">Date</th>
                                <th onclick="sortTable('instructorTable', 3)">Organization</th>
                                <th onclick="sortTable('instructorTable', 4)">Location</th>
                                <th onclick="sortTable('instructorTable', 5)">Class Type</th>
                                <th onclick="sortTable('instructorTable', 6)">Students Registered</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="instructorTableBody"></tbody>
                    </table>
                </div>
            </section>

            <!-- Scheduled Courses -->
            <section id="scheduledCourses" class="section">
                <h2>Scheduled Courses</h2>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Course Date</th>
                                <th>Organization</th>
                                <th>Location</th>
                                <th>Class Type</th>
                                <th>Students</th>
                                <th>Status</th>
                                <th>Instructor</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="scheduledCoursesTableBody"></tbody>
                    </table>
                </div>
            </section>

            <!-- Confirmed Courses -->
            <section id="confirmedCourses" class="section">
                <h2>Confirmed Courses</h2>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Course Date</th>
                                <th>Organization</th>
                                <th>Location</th>
                                <th>Class Type</th>
                                <th>Students Registered</th>
                                <th>Status</th>
                                <th>Instructor</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="confirmedCoursesTableBody"></tbody>
                    </table>
                </div>
            </section>

            <!-- Completed Courses -->
            <section id="completedCourses" class="section">
                <h2>Completed Courses</h2>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Course Date</th>
                                <th>Organization</th>
                                <th>Location</th>
                                <th>Class Type</th>
                                <th>Students Registered</th>
                                <th>Students Attended</th>
                                <th>Status</th>
                                <th>Billing Status</th>
                                <th>Instructor</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="completedCoursesTableBody"></tbody>
                    </table>
                </div>
            </section>

            <!-- Notification Element -->
            <div id="notification" class="notification"></div>

            <!-- Assign Instructor Modal -->
            <div id="assignInstructorModal" class="modal">
                <div class="modal-content">
                    <span class="close-modal" onclick="closeModal('assignInstructorModal')">&times;</span>
                    <h3>Assign Instructor</h3>
                    <div class="form-group">
                        <label for="instructorSelect">Select Instructor:</label>
                        <select id="instructorSelect" required>
                            <option value="">Choose an instructor...</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="assignInstructor()">Assign</button>
                </div>
            </div>

            <!-- Add Reset Data Confirmation Modal -->
            <div id="resetDataModal" class="modal">
                <div class="modal-content">
                    <h2>Reset All Data</h2>
                    <p>Warning: This will permanently delete all data including:</p>
                    <ul>
                        <li>All instructors and their availability</li>
                        <li>All organizations</li>
                        <li>All courses and schedules</li>
                        <li>All student lists</li>
                    </ul>
                    <p>This action cannot be undone. Are you sure you want to continue?</p>
                    <div class="modal-buttons">
                        <button class="btn btn-danger" onclick="resetAllData()">Yes, Reset All Data</button>
                        <button class="btn btn-secondary" onclick="closeModal('resetDataModal')">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Student List Modal -->
            <div id="studentListModal" class="modal">
                <div class="modal-content">
                    <span class="close-modal" onclick="closeStudentListModal()">&times;</span>
                    <h3>Student List</h3>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Status</th>
                                    <th>Attendance</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody id="studentListTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <section id="courseTypes" class="section">
                <h2>Course Type Management</h2>
                <div class="section-content">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Course Type</th>
                                    <th>Description</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="courseTypesTableBody"></tbody>
                        </table>
                    </div>
                    <button class="btn btn-primary" onclick="showAddCourseTypeModal()">Add Course Type</button>
                </div>
            </section>

            <!-- Add Course Type Modal -->
            <div id="courseTypeModal" class="modal">
                <div class="modal-content">
                    <span class="close-modal" onclick="closeModal('courseTypeModal')">&times;</span>
                    <h3 id="courseTypeModalTitle">Add Course Type</h3>
                    <form id="courseTypeForm" onsubmit="saveCourseType(event)">
                        <div class="form-group">
                            <label for="courseTypeName">Course Type Name:</label>
                            <input type="text" id="courseTypeName" required>
                        </div>
                        <div class="form-group">
                            <label for="courseTypeDescription">Description:</label>
                            <textarea id="courseTypeDescription" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="courseTypeStatus">Status:</label>
                            <select id="courseTypeStatus" required>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                        <input type="hidden" id="courseTypeId">
                        <button type="submit" class="btn btn-primary">Save</button>
                    </form>
                </div>
            </div>

            <!-- Add Student Management Section -->
            <div id="studentManagementSection" class="section" style="display: none;">
                <h2>Student Management</h2>
                <div class="search-filters">
                    <input type="text" id="studentSearch" placeholder="Search students..." onkeyup="updateStudentTable()">
                </div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Registration Date</th>
                            <th>Courses</th>
                            <th>Certificates</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="studentTableBody"></tbody>
                </table>
            </div>

            <section id="bulkUpload" class="section">
                <h2>Bulk Upload</h2>
                <div class="bulk-upload-container">
                    <div class="upload-section">
                        <h3>Instructor Availability</h3>
                        <div class="form-group">
                            <label for="instructorAvailabilityFile">Upload Instructor Availability Excel File:</label>
                            <input type="file" id="instructorAvailabilityFile" accept=".xlsx,.xls" onchange="handleInstructorAvailabilityFileSelect(event)">
                        </div>
                        <div class="progress-container" id="instructorAvailabilityProgress" style="display: none;">
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div class="progress-text">Processing: 0%</div>
                        </div>
                        <div class="button-group">
                            <button id="uploadInstructorAvailabilityBtn" class="btn btn-primary" onclick="handleInstructorAvailabilityUpload()" disabled>
                                Upload Availability
                            </button>
                            <button class="btn btn-secondary" onclick="downloadInstructorAvailabilityTemplate()">
                                Download Template
                            </button>
                        </div>
                    </div>

                    <div class="upload-section">
                        <h3>Organization Course Schedule</h3>
                        <div class="form-group">
                            <label for="organizationCoursesFile">Upload Organization Course Schedule Excel File:</label>
                            <input type="file" id="organizationCoursesFile" accept=".xlsx,.xls" onchange="handleOrganizationCoursesFileSelect(event)">
                        </div>
                        <div class="progress-container" id="organizationCoursesProgress" style="display: none;">
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div class="progress-text">Processing: 0%</div>
                        </div>
                        <div class="button-group">
                            <button id="uploadOrganizationCoursesBtn" class="btn btn-primary" onclick="handleOrganizationCoursesUpload()" disabled>
                                Upload Course Schedule
                            </button>
                            <button class="btn btn-secondary" onclick="downloadOrganizationCoursesTemplate()">
                                Download Template
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <style>
                .bulk-upload-container {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 2rem;
                    margin-top: 1rem;
                }

                .upload-section {
                    background: white;
                    padding: 1.5rem;
                    border-radius: 8px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                }

                .upload-section h3 {
                    margin-bottom: 1rem;
                    color: var(--primary-color);
                }

                .button-group {
                    margin-top: 1rem;
                    display: flex;
                    gap: 1rem;
                }
            </style>

            <script>
                // Add these functions to handle bulk uploads
                let instructorAvailabilityFile = null;
                let organizationCoursesFile = null;

                function handleInstructorAvailabilityFileSelect(event) {
                    instructorAvailabilityFile = event.target.files[0];
                    const uploadBtn = document.getElementById('uploadInstructorAvailabilityBtn');
                    uploadBtn.disabled = !instructorAvailabilityFile;
                }

                function handleOrganizationCoursesFileSelect(event) {
                    organizationCoursesFile = event.target.files[0];
                    const uploadBtn = document.getElementById('uploadOrganizationCoursesBtn');
                    uploadBtn.disabled = !organizationCoursesFile;
                }

                function downloadInstructorAvailabilityTemplate() {
                    try {
                        const wb = XLSX.utils.book_new();
                        const wsData = [
                            ['Instructor Name', 'Date', 'Start Time', 'End Time', 'Location', 'Notes'],
                            ['John Doe', '2024-03-21', '09:00', '17:00', 'Toronto', 'Available for BLS and CPR']
                        ];
                        const ws = XLSX.utils.aoa_to_sheet(wsData);
                        XLSX.utils.book_append_sheet(wb, ws, 'Instructor Availability');
                        XLSX.writeFile(wb, 'instructor_availability_template.xlsx');
                        showNotification('Template downloaded successfully', 'success');
                    } catch (error) {
                        console.error('Error downloading template:', error);
                        showNotification('Error downloading template', 'error');
                    }
                }

                function downloadOrganizationCoursesTemplate() {
                    try {
                        const wb = XLSX.utils.book_new();
                        const wsData = [
                            ['Organization Name', 'Course Date', 'Location', 'Class Type', 'Students Registered', 'Notes'],
                            ['Kaizen', '2024-03-21', 'Toronto', 'BLS', '10', 'Morning session']
                        ];
                        const ws = XLSX.utils.aoa_to_sheet(wsData);
                        XLSX.utils.book_append_sheet(wb, ws, 'Organization Courses');
                        XLSX.writeFile(wb, 'organization_courses_template.xlsx');
                        showNotification('Template downloaded successfully', 'success');
                    } catch (error) {
                        console.error('Error downloading template:', error);
                        showNotification('Error downloading template', 'error');
                    }
                }

                function handleInstructorAvailabilityUpload() {
                    try {
                        if (!instructorAvailabilityFile) {
                            showNotification('Please select a file to upload', 'error');
                            return;
                        }

                        const progressContainer = document.getElementById('instructorAvailabilityProgress');
                        const progressBar = progressContainer.querySelector('.progress-bar');
                        const progressText = progressContainer.querySelector('.progress-text');
                        
                        progressContainer.style.display = 'block';
                        progressBar.style.width = '0%';
                        progressText.textContent = '0%';

                        const reader = new FileReader();
                        reader.onload = function(e) {
                            try {
                                progressBar.style.width = '50%';
                                progressText.textContent = '50%';

                                const data = e.target.result;
                                const workbook = XLSX.read(data, { type: 'binary' });
                                const sheetName = workbook.SheetNames[0];
                                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);

                                // Process instructor availability data
                                const instructors = JSON.parse(localStorage.getItem('instructors') || '[]');
                                const availability = JSON.parse(localStorage.getItem('instructorAvailability') || '[]');

                                jsonData.forEach(row => {
                                    const instructor = instructors.find(i => i.name === row['Instructor Name']);
                                    if (instructor) {
                                        availability.push({
                                            id: 'availability_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                                            instructorId: instructor.id,
                                            instructorName: instructor.name,
                                            date: row['Date'],
                                            startTime: row['Start Time'],
                                            endTime: row['End Time'],
                                            location: row['Location'],
                                            notes: row['Notes'],
                                            status: 'Available'
                                        });
                                    }
                                });

                                localStorage.setItem('instructorAvailability', JSON.stringify(availability));

                                progressBar.style.width = '100%';
                                progressText.textContent = '100%';

                                setTimeout(() => {
                                    progressContainer.style.display = 'none';
                                    showNotification('Instructor availability uploaded successfully', 'success');
                                    updateInstructorAvailabilityTable();
                                }, 500);

                            } catch (error) {
                                console.error('Error processing Excel file:', error);
                                showNotification('Error processing Excel file', 'error');
                                progressContainer.style.display = 'none';
                            }
                        };

                        reader.onerror = function(error) {
                            console.error('Error reading file:', error);
                            showNotification('Error reading file', 'error');
                            progressContainer.style.display = 'none';
                        };

                        reader.readAsBinaryString(instructorAvailabilityFile);
                    } catch (error) {
                        console.error('Error handling file upload:', error);
                        showNotification('Error handling file upload', 'error');
                        document.getElementById('instructorAvailabilityProgress').style.display = 'none';
                    }
                }

                function handleOrganizationCoursesUpload() {
                    try {
                        if (!organizationCoursesFile) {
                            showNotification('Please select a file to upload', 'error');
                            return;
                        }

                        const progressContainer = document.getElementById('organizationCoursesProgress');
                        const progressBar = progressContainer.querySelector('.progress-bar');
                        const progressText = progressContainer.querySelector('.progress-text');
                        
                        progressContainer.style.display = 'block';
                        progressBar.style.width = '0%';
                        progressText.textContent = '0%';

                        const reader = new FileReader();
                        reader.onload = function(e) {
                            try {
                                progressBar.style.width = '50%';
                                progressText.textContent = '50%';

                                const data = e.target.result;
                                const workbook = XLSX.read(data, { type: 'binary' });
                                const sheetName = workbook.SheetNames[0];
                                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);

                                // Process organization courses data
                                const organizations = JSON.parse(localStorage.getItem('organizations') || '[]');
                                const courses = JSON.parse(localStorage.getItem('courses') || '[]');

                                jsonData.forEach(row => {
                                    const organization = organizations.find(org => org.name === row['Organization Name']);
                                    if (organization) {
                                        courses.push({
                                            id: 'course_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                                            organizationId: organization.id,
                                            organizationName: organization.name,
                                            courseDate: row['Course Date'],
                                            location: row['Location'],
                                            classType: row['Class Type'],
                                            studentsRegistered: parseInt(row['Students Registered']) || 0,
                                            notes: row['Notes'],
                                            status: 'PENDING',
                                            adminScheduledDashStatus: 'PENDING',
                                            adminInstructorDashStatus: 'PENDING',
                                            organizationStatus: 'PENDING',
                                            instructorStatus: 'PENDING',
                                            adminConfirmed: false,
                                            displayInstructorDetails: false,
                                            displayOrgDetails: false,
                                            hideOrgDetails: true,
                                            studentList: []
                                        });
                                    }
                                });

                                localStorage.setItem('courses', JSON.stringify(courses));

                                progressBar.style.width = '100%';
                                progressText.textContent = '100%';

                                setTimeout(() => {
                                    progressContainer.style.display = 'none';
                                    showNotification('Organization courses uploaded successfully', 'success');
                                    updateScheduledCoursesList();
                                }, 500);

                            } catch (error) {
                                console.error('Error processing Excel file:', error);
                                showNotification('Error processing Excel file', 'error');
                                progressContainer.style.display = 'none';
                            }
                        };

                        reader.onerror = function(error) {
                            console.error('Error reading file:', error);
                            showNotification('Error reading file', 'error');
                            progressContainer.style.display = 'none';
                        };

                        reader.readAsBinaryString(organizationCoursesFile);
                    } catch (error) {
                        console.error('Error handling file upload:', error);
                        showNotification('Error handling file upload', 'error');
                        document.getElementById('organizationCoursesProgress').style.display = 'none';
                    }
                }
            </script>
        </main>
    </div>

    <script>
        // Standardized course types configuration
        const COURSE_TYPES = {
            'BLS': 'Basic Life Support',
            'ACLS': 'Advanced Cardiac Life Support',
            'PALS': 'Pediatric Advanced Life Support',
            'CPR': 'Cardiopulmonary Resuscitation',
            'First Aid': 'First Aid',
            'AED': 'Automated External Defibrillator'
        };

        // Function to get course type options HTML
        function getCourseTypeOptions() {
            return Object.entries(COURSE_TYPES)
                .map(([value, label]) => `<option value="${value}">${value} - ${label}</option>`)
                .join('');
        }

        // Function to get course type label
        function getCourseTypeLabel(value) {
            return COURSE_TYPES[value] || value;
        }

        // Initialize data if not exists
        function initializeData() {
            try {
                // Initialize instructors if not exists
                if (!localStorage.getItem('instructors')) {
                    localStorage.setItem('instructors', JSON.stringify([]));
                }

                // Initialize organizations if not exists
                if (!localStorage.getItem('organizations')) {
                    localStorage.setItem('organizations', JSON.stringify([]));
                }

                // Initialize courses if not exists
                if (!localStorage.getItem('courses')) {
                    localStorage.setItem('courses', JSON.stringify([]));
                }

                // Update all displays
                updateDashboardStats();
                updateMonthlyConfirmedCourses();
                updateScheduledCoursesList();
                updateConfirmedCoursesList();
                updateCompletedCoursesList();
                updateInstructorDashboard();
            } catch (error) {
                console.error('Error initializing data:', error);
            }
        }

        // Add this function after initializeData()
        function fixCourseData() {
            try {
                const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                let needsUpdate = false;

                courses.forEach(course => {
                    // If a course is completed but not confirmed, mark it as confirmed
                    if (course.completionStatus === 'COMPLETED' && !course.adminConfirmed) {
                        course.adminConfirmed = true;
                        course.status = 'CONFIRMED';
                        course.adminScheduledDashStatus = 'CONFIRMED';
                        course.adminInstructorDashStatus = 'CONFIRMED';
                        course.organizationStatus = 'CONFIRMED';
                        course.instructorStatus = 'CONFIRMED';
                        needsUpdate = true;
                    }
                });

                if (needsUpdate) {
                    localStorage.setItem('courses', JSON.stringify(courses));
                    console.log('Course data fixed and updated');
                }
            } catch (error) {
                console.error('Error fixing course data:', error);
            }
        }

        // Update the DOMContentLoaded event listener to call fixCourseData
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded');
            
            console.log('Initializing data...');
            initializeData();
            
            console.log('Fixing course data...');
            fixCourseData();
            
            console.log('Initializing filters...');
            initializeFilters();
            
            // Load and display data
            const instructors = JSON.parse(localStorage.getItem('instructors') || '[]');
            console.log('Loaded instructors:', instructors);
            
            const organizations = JSON.parse(localStorage.getItem('organizations') || '[]');
            console.log('Loaded organizations:', organizations);
            
            const courses = JSON.parse(localStorage.getItem('courses') || '[]');
            console.log('Loaded courses:', courses);
            
            console.log('Initializing course types...');
            initializeCourseTypes();
            
            console.log('Updating tables and stats...');
            // Update all displays once at initialization
            updateScheduledCoursesList();
            updateConfirmedCoursesList();
            updateCompletedCoursesList();
            updateInstructorDashboard();
            updateMonthlyConfirmedCourses();
            
            console.log('Setting up section display...');
            setupSectionDisplay();
            
            // Initialize dashboard and monthly summary
            updateDashboardStats();
            updateMonthlyConfirmedCourses();
        });

        function setupSectionDisplay() {
            // Get all section buttons
            const sectionButtons = document.querySelectorAll('[data-section]');
            const sections = document.querySelectorAll('section');

            // Add click event listeners to buttons
            sectionButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const sectionToShow = button.getAttribute('data-section');
                    
                    // Hide all sections
                    sections.forEach(section => {
                        section.style.display = 'none';
                    });
                    
                    // Show selected section
                    const selectedSection = document.getElementById(sectionToShow);
                    if (selectedSection) {
                        selectedSection.style.display = 'block';
                    }
                    
                    // Update active button state
                    sectionButtons.forEach(btn => {
                        btn.classList.remove('active');
                    });
                    button.classList.add('active');
                });
            });

            // Show default section
            const defaultSection = document.querySelector('section');
            if (defaultSection) {
                defaultSection.style.display = 'block';
            }
        }

        function initializeFilters() {
            try {
                // Load instructors
                const instructors = JSON.parse(localStorage.getItem('instructors')) || [];
                console.log('Loaded instructors:', instructors);
                
                // Load organizations
                const organizations = JSON.parse(localStorage.getItem('organizations')) || [];
                console.log('Loaded organizations:', organizations);
                
                // Load courses
                const courses = JSON.parse(localStorage.getItem('courses')) || [];
                console.log('Loaded courses:', courses);
                
                // Populate instructor filters
                const instructorFilters = [
                    document.getElementById('instructorFilter'),
                    document.getElementById('instructorSelect')
                ];
                
                instructorFilters.forEach(filter => {
                    if (filter) {
                        filter.innerHTML = `
                            <option value="">All Instructors</option>
                            ${instructors.map(instructor => 
                                `<option value="${instructor.id}">${instructor.name}</option>`
                            ).join('')}
                        `;
                    }
                });
                
                // Populate organization filters
                const organizationFilters = [
                    document.getElementById('organizationFilter'),
                    document.getElementById('scheduledOrgFilter')
                ];
                
                organizationFilters.forEach(filter => {
                    if (filter) {
                        filter.innerHTML = `
                            <option value="">All Organizations</option>
                            ${organizations.map(org => 
                                `<option value="${org.id}">${org.name}</option>`
                            ).join('')}
                        `;
                    }
                });

                // Set date filters to blank (no default date)
                const dateFilters = [
                    document.getElementById('dateFilter'),
                    document.getElementById('scheduledDateFilter')
                ];
                
                dateFilters.forEach(filter => {
                    if (filter) {
                        filter.value = ''; // Set to blank instead of today's date
                    }
                });

                // Trigger initial table updates
                updateTables();
            } catch (error) {
                console.error('Error initializing filters:', error);
                safeShowNotification('Error loading filters', 'error');
            }
        }

        function updateTables() {
            updateInstructorTable();
            updateScheduledCourses();
            updateConfirmedCourses();
        }

        function updateInstructorTable() {
            const instructors = JSON.parse(localStorage.getItem('instructors') || '[]');
            const courses = JSON.parse(localStorage.getItem('courses') || '[]');
            const tableBody = document.getElementById('instructorTableBody');
            const selectedDate = document.getElementById('dateFilter').value;
            const selectedInstructor = document.getElementById('instructorFilter').value;
            const selectedOrganization = document.getElementById('organizationFilter').value;

            if (!tableBody) return;

            let rows = [];
            let hasRows = false;

            instructors.forEach(instructor => {
                if (selectedInstructor && instructor.id !== selectedInstructor) return;

                if (instructor.availability && instructor.availability.length > 0) {
                    instructor.availability.forEach(date => {
                        if (selectedDate && date !== selectedDate) return;

                        // Find if there's a course scheduled for this instructor on this date
                        const scheduledCourse = courses.find(course => 
                            course.instructorId === instructor.id && 
                            course.courseDate === date
                        );

                        let status = 'Available';
                        let organization = '-';

                        if (scheduledCourse) {
                            // Only show organization name in admin view
                            organization = scheduledCourse.organizationName;
                            // Use admin dashboard status for instructor table
                            status = scheduledCourse.adminInstructorDashStatus || 'Available';
                        }

                        rows.push(`
                            <tr>
                                <td>${instructor.name}</td>
                                <td><span class="status-${status.toLowerCase()}">${status}</span></td>
                                <td>${formatDate(date)}</td>
                                <td>${organization}</td>
                                <td>${scheduledCourse?.location || '-'}</td>
                                <td>${scheduledCourse?.classType || '-'}</td>
                                <td>${scheduledCourse?.studentsRegistered || 0}</td>
                                <td>
                                    ${status === 'Available' ? 
                                        `<button class="btn btn-primary" onclick="assignInstructor('${instructor.id}', '${date}')">Edit</button>` : 
                                        '-'
                                    }
                                </td>
                            </tr>
                        `);
                        hasRows = true;
                    });
                }
            });

            if (!hasRows) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8">No instructors found for the selected criteria</td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = rows.join('');
        }

        function assignInstructor() {
            try {
                console.log('Starting assignInstructor function');
                const courseId = localStorage.getItem('currentCourseId');
                const selectedInstructor = document.getElementById('instructorSelect').value;
                
                console.log('CourseId:', courseId, 'Selected Instructor:', selectedInstructor);
                
                if (!courseId || !selectedInstructor) {
                    showNotification('Missing course or instructor information', 'error');
                    return;
                }

                const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                const courseIndex = courses.findIndex(c => c.id === courseId);
                
                if (courseIndex === -1) {
                    showNotification('Course not found', 'error');
                    return;
                }

                // Get instructor details
                const instructors = JSON.parse(localStorage.getItem('instructors') || '[]');
                const instructor = instructors.find(i => i.id === selectedInstructor);
                
                if (!instructor) {
                    showNotification('Instructor not found', 'error');
                    return;
                }

                console.log('Current course state:', courses[courseIndex]);

                // Update course with instructor information and status
                courses[courseIndex].instructorId = selectedInstructor;
                courses[courseIndex].instructorName = instructor.name;
                
                // Update statuses for each portal view:
                courses[courseIndex].status = 'PENDING';                    // Organization Portal view (hide instructor details)
                courses[courseIndex].adminScheduledDashStatus = 'SCHEDULED';// Admin Portal Scheduled Courses view
                courses[courseIndex].adminInstructorDashStatus = 'SCHEDULED';// Admin Portal Instructor Dashboard
                courses[courseIndex].organizationStatus = 'PENDING';       // Organization Portal status
                courses[courseIndex].instructorStatus = 'SCHEDULED';       // Instructor Portal status
                courses[courseIndex].adminConfirmed = false;              // Not confirmed yet
                courses[courseIndex].displayInstructorDetails = false;    // Hide instructor details in org portal
                courses[courseIndex].displayOrgDetails = false;          // Hide org details in instructor portal
                courses[courseIndex].hideOrgDetails = true;             // Hide org details until confirmed

                console.log('Updated course state:', courses[courseIndex]);

                // Save changes
                localStorage.setItem('courses', JSON.stringify(courses));
                
                // Close modal and show success message
                closeModal('assignInstructorModal');
                showNotification('Instructor assigned successfully', 'success');
                
                // Update all relevant displays
                updateScheduledCoursesList();
                updateConfirmedCoursesList();
                updateInstructorDashboard();
            } catch (error) {
                console.error('Error assigning instructor:', error);
                showNotification('Error assigning instructor', 'error');
            }
        }

        function confirmInstructor(instructorId, date) {
            try {
                const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                const course = courses.find(c => 
                    c.courseDate === date && 
                    c.instructorId === instructorId
                );
                
                if (course) {
                    course.status = 'Confirmed';
                    localStorage.setItem('courses', JSON.stringify(courses));
                    
                    updateInstructorTable();
                    updateScheduledCourses(); // Update both tables
                    showNotification('Instructor confirmed successfully', 'success');
                } else {
                    showNotification('No scheduled course found', 'error');
                }
            } catch (error) {
                console.error('Error confirming instructor:', error);
                showNotification('Error confirming instructor', 'error');
            }
        }

        function updateScheduledCourses() {
            try {
                console.log('Starting updateScheduledCourses function');
                const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                console.log('All courses from localStorage:', courses);
                
                const instructors = JSON.parse(localStorage.getItem('instructors') || '[]');
                const tbody = document.getElementById('scheduledCoursesTableBody');
                
                if (!tbody) {
                    console.warn('scheduledCoursesTableBody element not found');
                    return;
                }
                
                // Filter for courses that are pending or scheduled but not confirmed or completed
                const scheduledCourses = courses.filter(course => {
                    console.log('Checking course:', course);
                    console.log('Course status checks:', {
                        notArchived: !course.isArchived,
                        noCompletion: !course.completionStatus,
                        notConfirmed: !course.adminConfirmed,
                        status: course.adminScheduledDashStatus
                    });
                    
                    return !course.isArchived && 
                           !course.completionStatus && 
                           !course.adminConfirmed &&
                           (course.adminScheduledDashStatus === 'PENDING' || 
                            course.adminScheduledDashStatus === 'SCHEDULED');
                });
                
                console.log('Filtered scheduled courses:', scheduledCourses);
                
                tbody.innerHTML = scheduledCourses.length ? 
                    scheduledCourses.map(course => {
                        const hasAvailableInstructors = instructors.some(instructor => 
                            instructor.availability && 
                            instructor.availability.includes(course.courseDate)
                        );
                        
                        const isPending = course.adminScheduledDashStatus === 'PENDING';
                        
                        return `
                            <tr>
                                <td>${formatDate(course.courseDate)}</td>
                                <td>${course.organizationName || '-'}</td>
                                <td>${course.location || '-'}</td>
                                <td>${course.classType || '-'}</td>
                                <td>${course.studentsRegistered || 0}</td>
                                <td>
                                    <span class="status-${course.adminScheduledDashStatus.toLowerCase()}">${course.adminScheduledDashStatus}</span>
                                </td>
                                <td>${course.instructorName || 'Not Assigned'}</td>
                                <td>
                                    ${isPending ? 
                                        (hasAvailableInstructors ? 
                                            `<button class="btn btn-primary" onclick="showAssignInstructorModal('${course.id}')">Assign Instructor</button>` :
                                            `<button class="btn btn-secondary" disabled>No Instructors Available</button>`
                                        ) :
                                        `<button class="btn btn-success" onclick="confirmCourse('${course.id}')">Confirm</button>`
                                    }
                                    <button class="btn btn-info" onclick="viewStudentList('${course.id}')">View Students</button>
                                </td>
                            </tr>
                        `;
                    }).join('') :
                    '<tr><td colspan="8" style="text-align: center;">No scheduled courses</td></tr>';
            } catch (error) {
                console.error('Error updating scheduled courses:', error);
                showNotification('Error updating scheduled courses', 'error');
            }
        }

        function updateConfirmedCourses() {
            try {
                const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                const tbody = document.getElementById('confirmedCoursesTableBody');
                
                if (!tbody) return;
                
                // Filter for confirmed courses
                const confirmedCourses = courses.filter(course => 
                    course.adminConfirmed === true
                );
                
                tbody.innerHTML = confirmedCourses.length ? 
                    confirmedCourses.map(course => {
                        const escapedNotes = (course.notes || '-').replace(/"/g, '&quot;');
                        const status = course.adminConfirmed ? 'CONFIRMED' : 'SCHEDULED';
                        return `
                            <tr>
                                <td>${formatDate(course.courseDate)}</td>
                                <td>${course.organizationName || '-'}</td>
                                <td>${course.location || '-'}</td>
                                <td>${course.classType || '-'}</td>
                                <td>${course.studentsRegistered || 0}</td>
                                <td>
                                    <span class="status-${status.toLowerCase()}">${status}</span>
                                    ${course.instructorName ? `<br><small>${course.instructorName}</small>` : ''}
                                </td>
                                <td>
                                    <button class="btn btn-info" onclick="viewStudentList('${course.id}')">
                                        <i class="fas fa-users"></i> View Students
                                    </button>
                                    <button class="btn btn-primary" onclick="generateBill('${course.id}')">
                                        <i class="fas fa-file-invoice-dollar"></i> BILL
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('') :
                    '<tr><td colspan="7" style="text-align: center;">No confirmed courses found</td></tr>';
            } catch (error) {
                console.error('Error updating confirmed courses:', error);
                showNotification('Error updating confirmed courses', 'error');
            }
        }

        function editCourseType(courseTypeId) {
            try {
                const courseTypes = JSON.parse(localStorage.getItem('courseTypes') || '[]');
                const courseType = courseTypes.find(ct => ct.id === courseTypeId);

                if (courseType) {
                    document.getElementById('courseTypeModalTitle').textContent = 'Edit Course Type';
                    document.getElementById('courseTypeId').value = courseType.id;
                    document.getElementById('courseTypeName').value = courseType.name;
                    document.getElementById('courseTypeDescription').value = courseType.description;
                    document.getElementById('courseTypeStatus').value = courseType.status;
                    document.getElementById('courseTypeModal').style.display = 'block';
                }
            } catch (error) {
                console.error('Error editing course type:', error);
                showNotification('Error editing course type', 'error');
            }
        }

        function deleteCourseType(courseTypeId) {
            if (!confirm('Are you sure you want to delete this course type? This action cannot be undone.')) {
                return;
            }

            try {
                let courseTypes = JSON.parse(localStorage.getItem('courseTypes') || '[]');
                courseTypes = courseTypes.filter(ct => ct.id !== courseTypeId);
                localStorage.setItem('courseTypes', JSON.stringify(courseTypes));
                updateCourseTypesTable();
                showNotification('Course type deleted successfully', 'success');
            } catch (error) {
                console.error('Error deleting course type:', error);
                showNotification('Error deleting course type', 'error');
            }
        }

        // Initialize course types if not exists
        function initializeCourseTypes() {
            try {
                let courseTypes = JSON.parse(localStorage.getItem('courseTypes'));
                if (!courseTypes || courseTypes.length === 0) {
                    courseTypes = [
                        {
                            id: 'ct_1',
                            name: 'BLS',
                            description: 'Basic Life Support',
                            status: 'active'
                        },
                        {
                            id: 'ct_2',
                            name: 'ACLS',
                            description: 'Advanced Cardiac Life Support',
                            status: 'active'
                        },
                        {
                            id: 'ct_3',
                            name: 'PALS',
                            description: 'Pediatric Advanced Life Support',
                            status: 'active'
                        },
                        {
                            id: 'ct_4',
                            name: 'CPR',
                            description: 'Cardiopulmonary Resuscitation',
                            status: 'active'
                        },
                        {
                            id: 'ct_5',
                            name: 'First Aid',
                            description: 'First Aid',
                            status: 'active'
                        },
                        {
                            id: 'ct_6',
                            name: 'AED',
                            description: 'Automated External Defibrillator',
                            status: 'active'
                        }
                    ];
                    localStorage.setItem('courseTypes', JSON.stringify(courseTypes));
                }
            } catch (error) {
                console.error('Error initializing course types:', error);
            }
        }

        // Date handling functions
        function formatDateForStorage(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDateForDisplay(dateString) {
            if (!dateString) return '-';
            const [year, month, day] = dateString.split('-');
            return `${month}/${day}/${year}`;
        }

        function getCurrentDate() {
            const now = new Date();
            return formatDateForStorage(now);
        }

        // Update user creation
        function createUser(userData) {
            try {
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const newUser = {
                    ...userData,
                    id: 'user_' + Date.now(),
                    createdAt: getCurrentDate(),
                    lastLogin: null
                };
                
                users.push(newUser);
                localStorage.setItem('users', JSON.stringify(users));
                return true;
            } catch (error) {
                console.error('Error creating user:', error);
                return false;
            }
        }

        // Update login tracking
        function updateLastLogin(userId) {
            try {
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const userIndex = users.findIndex(u => u.id === userId);
                
                if (userIndex === -1) return false;
                
                users[userIndex].lastLogin = getCurrentDate();
                localStorage.setItem('users', JSON.stringify(users));
                return true;
            } catch (error) {
                console.error('Error updating last login:', error);
                return false;
            }
        }

        // Update course completion display
        function formatCompletionDate(completedDate) {
            if (!completedDate) return 'Not completed';
            return formatDateForDisplay(completedDate);
        }

        // Update showSection function
        function showSection(sectionId) {
            // Hide all sections
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => {
                section.style.display = 'none';
            });

            // Show the selected section
            const selectedSection = document.getElementById(sectionId);
            if (selectedSection) {
                selectedSection.style.display = 'block';
            }

            // Update active state in navigation
            const navButtons = document.querySelectorAll('.left-nav button');
            navButtons.forEach(button => {
                button.classList.remove('active');
                if (button.getAttribute('onclick').includes(sectionId)) {
                    button.classList.add('active');
                }
            });
        }

        function updateDashboardStats() {
            try {
                const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                
                // Get current month's date range
                const today = new Date();
                const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);

                // Filter courses for current month
                const currentMonthCourses = courses.filter(course => {
                    const courseDate = new Date(course.courseDate);
                    return courseDate >= firstDay && courseDate <= lastDay;
                });

                // Count different statuses
                const stats = {
                    total: currentMonthCourses.length,
                    pending: currentMonthCourses.filter(c => !c.adminConfirmed && !c.completionStatus).length,
                    scheduled: currentMonthCourses.filter(c => c.adminScheduledDashStatus === 'SCHEDULED' && !c.adminConfirmed).length,
                    confirmed: currentMonthCourses.filter(c => c.adminConfirmed && !c.completionStatus).length,
                    completed: currentMonthCourses.filter(c => c.completionStatus === 'COMPLETED').length
                };

                // Update dashboard stats
                document.getElementById('totalCoursesCount').textContent = stats.total;
                document.getElementById('pendingCoursesCount').textContent = stats.pending;
                document.getElementById('scheduledCoursesCount').textContent = stats.scheduled;
                document.getElementById('confirmedCoursesCount').textContent = stats.confirmed;
                document.getElementById('completedCoursesCount').textContent = stats.completed;

                // Update course status table
                const tbody = document.getElementById('courseStatusTableBody');
                if (tbody) {
                    tbody.innerHTML = currentMonthCourses.map(course => {
                        const status = course.completionStatus === 'COMPLETED' ? 'COMPLETED' :
                                     course.adminConfirmed ? 'CONFIRMED' :
                                     course.adminScheduledDashStatus === 'SCHEDULED' ? 'SCHEDULED' : 'PENDING';
                        
                        return `
                            <tr>
                                <td style="font-size: 0.9rem;">${formatDate(course.courseDate)}</td>
                                <td style="font-size: 0.9rem;">${course.organizationName || '-'}</td>
                                <td style="font-size: 0.9rem;">${course.classType || '-'}</td>
                                <td style="font-size: 0.9rem;">${course.instructorName || '-'}</td>
                                <td style="text-align: center; font-weight: bold;">${status === 'PENDING' ? 'X' : ''}</td>
                                <td style="text-align: center; font-weight: bold;">${status === 'SCHEDULED' ? 'X' : ''}</td>
                                <td style="text-align: center; font-weight: bold;">${status === 'CONFIRMED' ? 'X' : ''}</td>
                                <td style="text-align: center; font-weight: bold;">${status === 'COMPLETED' ? 'X' : ''}</td>
                            </tr>
                        `;
                    }).join('') || '<tr><td colspan="8" style="text-align: center;">No courses found</td></tr>';
                }

                console.log('Dashboard stats updated successfully:', stats);
            } catch (error) {
                console.error('Error updating dashboard stats:', error);
            }
        }

        // Date formatting function
        function formatDate(dateString) {
            if (!dateString) return '-';
            const [year, month, day] = dateString.split('-');
            return `${month}/${day}/${year}`;
        }

        // Safe notification function
        function safeShowNotification(message, type = 'info') {
            try {
                const notification = document.getElementById('notification');
                if (notification) {
                    notification.textContent = message;
                    notification.className = `notification notification-${type}`;
                    notification.style.display = 'block';
                    
                    setTimeout(() => {
                        notification.style.display = 'none';
                    }, 3000);
                }
            } catch (error) {
                console.error('Error showing notification:', error);
            }
        }

        function updateCourseTypesTable() {
            try {
                const courseTypes = JSON.parse(localStorage.getItem('courseTypes') || '[]');
                const tbody = document.getElementById('courseTypesTableBody');
                
                if (!tbody) return;
                
                tbody.innerHTML = courseTypes.length ? 
                    courseTypes.map(courseType => `
                        <tr>
                            <td>${courseType.name}</td>
                            <td>${courseType.description}</td>
                            <td><span class="status-${courseType.status}">${courseType.status}</span></td>
                            <td>
                                <button class="btn btn-primary" onclick="editCourseType('${courseType.id}')">Edit</button>
                                <button class="btn btn-danger" onclick="deleteCourseType('${courseType.id}')">Delete</button>
                            </td>
                        </tr>
                    `).join('') :
                    '<tr><td colspan="4" style="text-align: center;">No course types found</td></tr>';
            } catch (error) {
                console.error('Error updating course types table:', error);
                showNotification('Error updating course types table', 'error');
            }
        }

        // Add these helper functions at the beginning of your script section
        function getWeekBounds(date) {
            const curr = new Date(date);
            const first = curr.getDate() - curr.getDay(); // First day is the day of the month - the day of the week
            const last = first + 6; // last day is the first day + 6

            const firstDay = new Date(curr.setDate(first));
            const lastDay = new Date(curr.setDate(last));

            // Format dates to YYYY-MM-DD
            return {
                start: firstDay.toISOString().split('T')[0],
                end: lastDay.toISOString().split('T')[0]
            };
        }

        function showAssignInstructorModal(courseId) {
            try {
                console.log('Starting showAssignInstructorModal with courseId:', courseId);
                
                const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                const instructors = JSON.parse(localStorage.getItem('instructors') || '[]');
                
                const course = courses.find(c => c.id === courseId);
                
                if (!course) {
                    console.error('Course not found:', courseId);
                    showNotification('Course not found', 'error');
                    return;
                }

                // Filter available instructors for the course date
                const availableInstructors = instructors.filter(instructor => {
                    const hasDate = instructor.availability && 
                        instructor.availability.includes(course.courseDate);
                    
                    if (!hasDate) {
                        console.log(`Instructor ${instructor.name} does not have date in availability`);
                        return false;
                    }

                    const isAlreadyAssigned = courses.some(c => 
                        c.courseDate === course.courseDate && 
                        c.instructorId === instructor.id &&
                        c.id !== courseId
                    );

                    console.log(`Instructor ${instructor.name}: hasDate=${hasDate}, isAlreadyAssigned=${isAlreadyAssigned}`);
                    return hasDate && !isAlreadyAssigned;
                });

                console.log('Available instructors:', availableInstructors);

                if (!availableInstructors || availableInstructors.length === 0) {
                    console.log('No available instructors found');
                    showNotification(`No instructors available for ${formatDateForDisplay(course.courseDate)}`, 'error');
                    return;
                }

                // Store courseId for the assign function
                localStorage.setItem('currentCourseId', courseId);

                // Populate and show modal
                const select = document.getElementById('instructorSelect');
                select.innerHTML = availableInstructors.map(instructor => 
                    `<option value="${instructor.id}">${instructor.name}</option>`
                ).join('');

                const modal = document.getElementById('assignInstructorModal');
                modal.style.display = 'block';
            } catch (error) {
                console.error('Error showing assign instructor modal:', error);
                showNotification('Error loading instructor assignment modal', 'error');
            }
        }

        // Add closeModal function
        function closeModal(modalId) {
            try {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'none';
                } else {
                    console.error(`Modal ${modalId} not found`);
                }
            } catch (error) {
                console.error('Error closing modal:', error);
            }
        }

        // Update the notification function to ensure it's visible
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            if (notification) {
                notification.textContent = message;
                notification.className = `notification notification-${type}`;
                notification.style.display = 'block';
                
                // Make sure the notification is visible
                notification.style.zIndex = '9999';
                notification.style.opacity = '1';
                
                // Hide after 3 seconds
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 3000);
            }
        }

        // Update the monthly confirmed courses table function with detailed tracing
        function updateMonthlyConfirmedCourses() {
            try {
                console.log('Starting updateMonthlyConfirmedCourses');
                const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                const tbody = document.getElementById('monthlyConfirmedCoursesBody');
                
                if (!tbody) {
                    console.log('No tbody element found');
                    return;
                }

                // Get current month's date range
                const today = new Date();
                const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                
                console.log('Date range:', {
                    firstDay: firstDay.toISOString(),
                    lastDay: lastDay.toISOString()
                });

                // Create instructor summary object
                const instructorSummary = {};

                // Process all courses for the current month
                courses.forEach(course => {
                    const courseDate = new Date(course.courseDate);
                    const isInCurrentMonth = courseDate >= firstDay && courseDate <= lastDay;
                    
                    if (isInCurrentMonth && course.instructorName) {
                        // Initialize instructor summary if not exists
                        if (!instructorSummary[course.instructorName]) {
                            instructorSummary[course.instructorName] = {
                                confirmed: 0,
                                completed: 0
                            };
                        }
                        
                        // Count confirmed and completed courses
                        if (course.completionStatus === 'COMPLETED') {
                            instructorSummary[course.instructorName].completed++;
                            console.log(`Completed course for ${course.instructorName}`);
                        } else if (course.adminConfirmed) {
                            instructorSummary[course.instructorName].confirmed++;
                            console.log(`Confirmed course for ${course.instructorName}`);
                        }
                    }
                });

                console.log('Instructor summary:', instructorSummary);

                // Convert to array and sort by total courses
                const sortedInstructors = Object.entries(instructorSummary)
                    .sort(([, a], [, b]) => (b.confirmed + b.completed) - (a.confirmed + a.completed));

                // Update the table
                tbody.innerHTML = sortedInstructors.length ? 
                    sortedInstructors.map(([instructor, counts]) => `
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                            <td style="padding: 8px 5px; color: white; white-space: nowrap; font-weight: 500; background: transparent;">${instructor}</td>
                            <td style="text-align: center; padding: 8px 5px; font-weight: bold; color: white; background: rgba(255,255,255,0.1); border-radius: 3px;">${counts.confirmed}</td>
                            <td style="text-align: center; padding: 8px 5px; font-weight: bold; color: white; background: rgba(255,255,255,0.15); border-radius: 3px;">${counts.completed}</td>
                        </tr>
                    `).join('') :
                    '<tr><td colspan="3" style="text-align: center; padding: 15px 5px; color: white; font-style: italic; background: transparent;">No courses found</td></tr>';

                console.log('Monthly summary updated successfully');
            } catch (error) {
                console.error('Error in updateMonthlyConfirmedCourses:', error);
            }
        }

        // Clear all storage data
        function clearAllStorage() {
            try {
                localStorage.clear();
                console.log('All storage data cleared successfully');
                showNotification('All storage data cleared successfully', 'success');
            } catch (error) {
                console.error('Error clearing storage:', error);
                showNotification('Error clearing storage', 'error');
            }
        }

        function updateScheduledCoursesList() {
            try {
                const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                const tbody = document.getElementById('scheduledCoursesTableBody');
                
                if (!tbody) return;
                
                // Filter for unconfirmed and uncompleted courses
                const scheduledCourses = courses.filter(course => 
                    !course.isArchived && 
                    !course.completionStatus && 
                    !course.adminConfirmed
                );
                
                tbody.innerHTML = scheduledCourses.length ? 
                    scheduledCourses.map(course => {
                        const isPending = course.adminScheduledDashStatus === 'PENDING';
                        const instructors = JSON.parse(localStorage.getItem('instructors') || '[]');
                        const hasAvailableInstructors = instructors.some(instructor => 
                            instructor.availability && 
                            instructor.availability.includes(course.courseDate)
                        );

                        return `
                            <tr>
                                <td>${formatDate(course.courseDate)}</td>
                                <td>${course.organizationName || '-'}</td>
                                <td>${course.location || '-'}</td>
                                <td>${course.classType || '-'}</td>
                                <td>${course.studentsRegistered || 0}</td>
                                <td>
                                    <span class="status-${course.adminScheduledDashStatus.toLowerCase()}">${course.adminScheduledDashStatus}</span>
                                </td>
                                <td>${course.instructorName || 'Not Assigned'}</td>
                                <td>
                                    ${isPending ? 
                                        (hasAvailableInstructors ? 
                                            `<button class="btn btn-primary" onclick="showAssignInstructorModal('${course.id}')">Assign Instructor</button>` :
                                            `<button class="btn btn-secondary" disabled>No Instructors Available</button>`
                                        ) : 
                                        `<button class="btn btn-success" onclick="confirmCourse('${course.id}')">Confirm</button>`
                                    }
                                    <button class="btn btn-info" onclick="viewStudentList('${course.id}')">View Students</button>
                                </td>
                            </tr>
                        `;
                    }).join('') :
                    '<tr><td colspan="8" style="text-align: center;">No scheduled courses found</td></tr>';
                
                console.log('Scheduled courses list updated successfully');
            } catch (error) {
                console.error('Error in updateScheduledCoursesList:', error);
                showNotification('Error updating scheduled courses list', 'error');
            }
        }

        function updateConfirmedCoursesList() {
            try {
                const confirmedCoursesTableBody = document.getElementById('confirmedCoursesTableBody');
                if (!confirmedCoursesTableBody) return;

                const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                const confirmedCourses = courses.filter(course => 
                    course.adminConfirmed && course.completionStatus !== 'COMPLETED'
                );

                if (confirmedCourses.length === 0) {
                    confirmedCoursesTableBody.innerHTML = '<tr><td colspan="8" class="text-center">No confirmed courses found</td></tr>';
                    return;
                }

                confirmedCoursesTableBody.innerHTML = confirmedCourses.map(course => `
                    <tr>
                        <td>${formatDate(course.courseDate)}</td>
                        <td>${course.organizationName || '-'}</td>
                        <td>${course.location || '-'}</td>
                        <td>${course.classType || '-'}</td>
                        <td>${course.studentsRegistered || 0}</td>
                        <td>
                            <span class="status-confirmed">CONFIRMED</span>
                        </td>
                        <td>${course.instructorName || 'Not Assigned'}</td>
                        <td>
                            <button class="btn btn-info" onclick="viewStudentList('${course.id}')">
                                View Students
                            </button>
                            <button class="btn btn-primary" onclick="viewCourseDetails('${course.id}')">
                                Details
                            </button>
                            <button class="btn btn-warning" onclick="editCourse('${course.id}')">
                                Edit
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error updating confirmed courses list:', error);
            }
        }

        function updateInstructorDashboard() {
            try {
                const instructorDashboardTableBody = document.getElementById('instructorDashboardTableBody');
                if (!instructorDashboardTableBody) return;

                const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                
                // Filter for courses that are:
                // 1. Admin confirmed
                // 2. Not completed
                // 3. Have an assigned instructor
                const availableCourses = courses.filter(course => 
                    course.adminConfirmed && 
                    course.completionStatus !== 'COMPLETED' &&
                    course.instructorName &&
                    course.instructorName.trim() !== ''
                );

                console.log('Available courses for instructor dashboard:', availableCourses);

                if (availableCourses.length === 0) {
                    instructorDashboardTableBody.innerHTML = '<tr><td colspan="7" class="text-center">No available courses found</td></tr>';
                    return;
                }

                instructorDashboardTableBody.innerHTML = availableCourses.map(course => {
                    const isCompleted = course.completionStatus === 'COMPLETED';
                    return `
                        <tr>
                            <td>${formatDate(course.courseDate)}</td>
                            <td>${course.organizationName || '-'}</td>
                            <td>${course.location || '-'}</td>
                            <td>${course.classType || '-'}</td>
                            <td>${course.studentsRegistered || 0}</td>
                            <td>${course.instructorName || 'Not Assigned'}</td>
                            <td>
                                <button class="btn btn-info" onclick="viewStudentList('${course.id}')">
                                    View Students
                                </button>
                                <button class="btn btn-primary" onclick="viewCourseDetails('${course.id}')">
                                    Details
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error updating instructor dashboard:', error);
            }
        }

        function confirmCourse(courseId) {
            try {
                const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                const courseIndex = courses.findIndex(c => c.id === courseId);
                
                if (courseIndex === -1) {
                    showNotification('Course not found', 'error');
                    return;
                }

                // Update course status
                courses[courseIndex] = {
                    ...courses[courseIndex],
                    adminConfirmed: true,
                    adminScheduledDashStatus: 'CONFIRMED',
                    adminInstructorDashStatus: 'CONFIRMED',
                    status: 'CONFIRMED',
                    organizationStatus: 'CONFIRMED',
                    instructorStatus: 'CONFIRMED',
                    displayInstructorDetails: true
                };
                
                // Update localStorage
                localStorage.setItem('courses', JSON.stringify(courses));
                
                // Force refresh all displays
                updateScheduledCoursesTable();
                updateInstructorDashboardTable();
                updateOrganizationDashboardTable();
                updateDashboardStats();
                
                showNotification('Course confirmed successfully', 'success');
            } catch (error) {
                console.error('Error confirming course:', error);
                showNotification('Error confirming course', 'error');
            }
        }

        function updateInstructorDashboardTable() {
            try {
                const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                const instructors = JSON.parse(localStorage.getItem('instructors') || '[]');
                const tableBody = document.getElementById('instructorDashboardTableBody');
                
                if (!tableBody) return;

                // Get all courses for each instructor
                const instructorCourses = instructors.map(instructor => {
                    const instructorCourses = courses.filter(course => 
                        course.instructorId === instructor.id
                    );

                    return {
                        instructor,
                        courses: instructorCourses
                    };
                });

                // Update the table
                tableBody.innerHTML = instructorCourses.map(({ instructor, courses }) => `
                    <tr>
                        <td>${instructor.name}</td>
                        <td>${courses.length}</td>
                        <td>
                            ${courses.map(course => `
                                <div class="course-item">
                                    <strong>${formatDate(course.courseDate)}</strong><br>
                                    ${course.organizationName || 'Not Specified'}<br>
                                    ${course.location}<br>
                                    ${course.classType}<br>
                                    <span class="status status-${course.adminInstructorDashStatus.toLowerCase()}">${course.adminInstructorDashStatus}</span>
                                </div>
                            `).join('<hr>')}
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error updating instructor dashboard table:', error);
                showNotification('Error loading instructor dashboard', 'error');
            }
        }

        function handleCourseStatusChange(courseId, newStatus) {
            try {
                const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                const courseIndex = courses.findIndex(c => c.id === courseId);
                
                if (courseIndex === -1) {
                    console.error('Course not found:', courseId);
                    return;
                }

                courses[courseIndex].status = newStatus;
                if (newStatus === 'COMPLETED') {
                    courses[courseIndex].completionStatus = 'COMPLETED';
                    courses[courseIndex].completedDate = new Date().toISOString();
                }

                localStorage.setItem('courses', JSON.stringify(courses));
                
                // Update both dashboard and monthly summary
                updateDashboardStats();
                updateMonthlyConfirmedCourses();
                
                console.log('Course status updated successfully:', newStatus);
            } catch (error) {
                console.error('Error updating course status:', error);
            }
        }

        function completeCourse(courseId) {
            try {
                console.log('Starting completeCourse function with courseId:', courseId);
                const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                const courseIndex = courses.findIndex(c => c.id === courseId);
                
                if (courseIndex === -1) {
                    console.error('Course not found:', courseId);
                    return false;
                }
                
                courses[courseIndex].completionStatus = 'COMPLETED';
                courses[courseIndex].completedDate = new Date().toISOString();
                
                // Set auto-archive date to 30 days from completion
                const archiveDate = new Date();
                archiveDate.setDate(archiveDate.getDate() + 30);
                courses[courseIndex].autoArchiveDate = formatDateForStorage(archiveDate);
                
                localStorage.setItem('courses', JSON.stringify(courses));
                
                // Update all relevant displays
                updateDashboardStats();
                updateMonthlyConfirmedCourses();
                updateCompletedCoursesList();
                updateConfirmedCoursesList();
                updateScheduledCoursesList();
                
                console.log('Course completed successfully');
                showNotification('Course marked as completed', 'success');
                return true;
            } catch (error) {
                console.error('Error completing course:', error);
                return false;
            }
        }

        function showResetDataConfirmation() {
            document.getElementById('resetDataModal').style.display = 'block';
        }

        function resetAllData() {
            try {
                // Clear all data from localStorage
                localStorage.clear();
                
                // Reinitialize default course types
                initializeCourseTypes();
                
                // Show success message
                showNotification('All data has been reset successfully', 'success');
                
                // Reload the page after a short delay
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } catch (error) {
                console.error('Error resetting data:', error);
                showNotification('Error resetting data', 'error');
            }
        }

        function updateStudentTable() {
            const students = JSON.parse(localStorage.getItem('students') || '[]');
            const courses = JSON.parse(localStorage.getItem('courses') || '[]');
            const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
            const tbody = document.getElementById('studentTableBody');

            const filteredStudents = students.filter(student =>
                student.name.toLowerCase().includes(searchTerm) ||
                student.email.toLowerCase().includes(searchTerm) ||
                student.phone.includes(searchTerm)
            );

            tbody.innerHTML = filteredStudents.map(student => {
                const studentCourses = courses.filter(course => 
                    student.courses.includes(course.id)
                );

                return `
                    <tr>
                        <td>${student.name}</td>
                        <td>${student.email}</td>
                        <td>${student.phone}</td>
                        <td>${formatDate(student.registrationDate)}</td>
                        <td>${studentCourses.length} courses</td>
                        <td>${student.certificates.length} certificates</td>
                        <td>
                            <button class="btn btn-info btn-sm" onclick="viewStudentDetails('${student.id}')">
                                View Details
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function viewStudentDetails(studentId) {
            const students = JSON.parse(localStorage.getItem('students') || '[]');
            const courses = JSON.parse(localStorage.getItem('courses') || '[]');
            const student = students.find(s => s.id === studentId);

            if (!student) {
                showNotification('Student not found', 'error');
                return;
            }

            const studentCourses = courses.filter(course => 
                student.courses.includes(course.id)
            );

            const modalContent = `
                <div class="student-details">
                    <h3>${student.name}</h3>
                    <p><strong>Email:</strong> ${student.email}</p>
                    <p><strong>Phone:</strong> ${student.phone}</p>
                    <p><strong>Registration Date:</strong> ${formatDate(student.registrationDate)}</p>
                    
                    <h4>Course History</h4>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Course Type</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Certificate</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${studentCourses.map(course => `
                                <tr>
                                    <td>${course.classType}</td>
                                    <td>${formatDate(course.courseDate)}</td>
                                    <td>${course.completionStatus}</td>
                                    <td>
                                        ${course.completionStatus === 'COMPLETED' ?
                                            `<button class="btn btn-info btn-sm" onclick="viewCertificate('${course.id}', '${student.id}')">
                                                View Certificate
                                            </button>` :
                                            'N/A'
                                        }
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            // Show modal with student details
            const modal = document.getElementById('genericModal');
            modal.querySelector('.modal-title').textContent = 'Student Details';
            modal.querySelector('.modal-body').innerHTML = modalContent;
            new bootstrap.Modal(modal).show();
        }

        // Add student management to section buttons
        document.addEventListener('DOMContentLoaded', function() {
            const sectionButtons = document.querySelector('.section-buttons');
            sectionButtons.innerHTML += `
                <button onclick="showSection('studentManagement')" class="btn btn-primary">
                    Student Management
                </button>
            `;
        });

        function handleScheduleCourse(event) {
            event.preventDefault();
            try {
                // ... existing scheduling code ...
                
                localStorage.setItem('courses', JSON.stringify(courses));
                updateDashboardStats();
                updateMonthlyConfirmedCourses();
                showNotification('Course scheduled successfully', 'success');
            } catch (error) {
                console.error('Error scheduling course:', error);
                showNotification('Error scheduling course', 'error');
            }
        }

        function handleExcelUpload() {
            try {
                // ... existing upload code ...
                
                localStorage.setItem('courses', JSON.stringify(courses));
                updateDashboardStats();
                updateMonthlyConfirmedCourses();
                showNotification('Student list uploaded successfully', 'success');
            } catch (error) {
                console.error('Error uploading student list:', error);
                showNotification('Error uploading student list', 'error');
            }
        }

        function viewStudentList(courseId) {
            try {
                console.log('Opening student list for course:', courseId);
                const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                const course = courses.find(c => c.id === courseId);
                
                if (!course) {
                    console.error('Course not found:', courseId);
                    showNotification('Course not found', 'error');
                    return;
                }

                console.log('Found course:', course);
                console.log('Students data:', course.studentList || course.students || []);

                const studentListModal = document.getElementById('studentListModal');
                const studentListTableBody = document.getElementById('studentListTableBody');
                
                if (!studentListModal || !studentListTableBody) {
                    console.error('Required modal elements not found');
                    return;
                }

                // Get the students array from either studentList or students property
                const students = course.studentList || course.students || [];
                console.log('Processing students:', students);

                // Update the table body with student information
                studentListTableBody.innerHTML = students.length ? 
                    students.map(student => {
                        // Handle both object and array formats
                        const studentData = typeof student === 'object' ? student : {
                            name: student,
                            email: '-',
                            status: 'Registered',
                            attendance: 'Not Taken',
                            notes: '-'
                        };

                        return `
                            <tr>
                                <td>${studentData.name || '-'}</td>
                                <td>${studentData.email || '-'}</td>
                                <td>${studentData.status || 'Registered'}</td>
                                <td>${studentData.attendance || 'Not Taken'}</td>
                                <td>${studentData.notes || '-'}</td>
                            </tr>
                        `;
                    }).join('') :
                    '<tr><td colspan="5" style="text-align: center;">No students registered for this course</td></tr>';

                // Show the modal
                studentListModal.style.display = 'block';

                // Add event listener to close button if it exists
                const closeButton = studentListModal.querySelector('.close-modal');
                if (closeButton) {
                    closeButton.onclick = closeStudentListModal;
                }

                // Add click event listener to close modal when clicking outside
                window.onclick = function(event) {
                    if (event.target === studentListModal) {
                        closeStudentListModal();
                    }
                };

            } catch (error) {
                console.error('Error viewing student list:', error);
                showNotification('Error loading student list', 'error');
            }
        }

        function closeStudentListModal() {
            const modal = document.getElementById('studentListModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function updateCompletedCoursesList() {
            try {
                const completedCoursesTableBody = document.getElementById('completedCoursesTableBody');
                if (!completedCoursesTableBody) return;

                const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                const completedCourses = courses.filter(course => 
                    course.completionStatus === 'COMPLETED'
                );

                if (completedCourses.length === 0) {
                    completedCoursesTableBody.innerHTML = '<tr><td colspan="10" class="text-center">No completed courses found</td></tr>';
                    return;
                }

                completedCoursesTableBody.innerHTML = completedCourses.map(course => `
                    <tr>
                        <td>${formatDate(course.courseDate)}</td>
                        <td>${course.organizationName || '-'}</td>
                        <td>${course.location || '-'}</td>
                        <td>${course.classType || '-'}</td>
                        <td>${course.studentsRegistered || 0}</td>
                        <td>${course.studentsAttended || 0}</td>
                        <td>
                            <span class="status-complete">COMPLETED</span>
                        </td>
                        <td>
                            <span class="${course.billingStatus === 'BILLED' ? 'status-confirmed' : 'status-pending'}">
                                ${course.billingStatus || 'PENDING'}
                            </span>
                        </td>
                        <td>${course.instructorName || '-'}</td>
                        <td style="text-align: center;">
                            <button class="btn btn-info" onclick="viewStudentList('${course.id}')">
                                <i class="fas fa-users"></i> View Students
                            </button>
                        </td>
                    </tr>
                `).join('');

                console.log('Completed courses list updated successfully');
            } catch (error) {
                console.error('Error updating completed courses list:', error);
            }
        }
    </script>
</body>
</html> 